# portkey gateway é…ç½®è¯´æ˜
Portkey Gatewayï¼ˆå¼€æºç‰ˆï¼‰å¯¹ schema æœ‰æ˜ç¡®çš„è¦æ±‚å’Œè§„åˆ™ï¼Œä¸»è¦æ¶‰åŠä¸¤ä¸ªæ–¹é¢ï¼šä¸€æ˜¯ `x-portkey-config` header ä¸­çš„ JSON é…ç½® schemaï¼ˆä½¿ç”¨ Zod è¿›è¡ŒéªŒè¯ï¼‰ï¼ŒäºŒæ˜¯ `jsonSchema` æ’ä»¶ç”¨äºè¾“å‡ºéªŒè¯çš„ JSON Schemaï¼ˆåŸºäºæ ‡å‡† JSON Schema è§„èŒƒï¼‰ã€‚è¿™äº›è§„åˆ™ç¡®ä¿é…ç½®çš„å®‰å…¨æ€§ã€ä¸€è‡´æ€§å’Œæœ‰æ•ˆæ€§ã€‚ä¸‹é¢æˆ‘åŸºäºæ–‡æ¡£è¯¦ç»†è¯´æ˜ï¼ŒåŒ…æ‹¬è¦æ±‚ã€è§„åˆ™ã€ç¤ºä¾‹å’Œæ½œåœ¨çº¦æŸã€‚

### 1. `x-portkey-config` çš„ Schema è¦æ±‚
è¿™æ˜¯ Portkey Gateway çš„æ ¸å¿ƒé…ç½®ï¼Œé€šè¿‡ HTTP header ä¼ é€’ä¸€ä¸ª JSON å­—ç¬¦ä¸²ã€‚Gateway åœ¨è¯·æ±‚å¤„ç†ç®¡é“çš„éªŒè¯é˜¶æ®µä½¿ç”¨ **Zod**ï¼ˆä¸€ä¸ª TypeScript ç±»å‹å®‰å…¨çš„ schema éªŒè¯åº“ï¼‰æ¥è§£æå’ŒéªŒè¯è¿™ä¸ª JSONï¼ˆå…·ä½“åœ¨ `src/middlewares/requestValidator.ts` ä¸­å®šä¹‰çš„ `configSchema`ï¼‰ã€‚å¦‚æœä¸ç¬¦åˆ schemaï¼Œè¯·æ±‚ä¼šå¤±è´¥ï¼ˆé€šå¸¸è¿”å›é”™è¯¯å“åº”ï¼‰ã€‚

#### ä¸»è¦è§„åˆ™å’Œè¦æ±‚ï¼š
- **æ•´ä½“ç»“æ„**ï¼šå¿…é¡»æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ JSON å¯¹è±¡ï¼Œæ”¯æŒé€’å½’åµŒå¥—ï¼ˆä¾‹å¦‚ `targets` å¯ä»¥åµŒå¥—ç­–ç•¥ï¼‰ã€‚
- **å¿…å¡«å­—æ®µ**ï¼šæŸäº›å­—æ®µå¦‚ `targets[].provider` æ˜¯å¿…éœ€çš„ï¼Œå…¶ä»–å¦‚ `retry.attempts` æœ‰é»˜è®¤å€¼ã€‚
- **ç±»å‹ä¸¥æ ¼**ï¼šZod å¼ºåˆ¶ç±»å‹æ£€æŸ¥ï¼ˆä¾‹å¦‚ `weight` å¿…é¡»æ˜¯ numberï¼‰ã€‚
- **å€¼çº¦æŸ**ï¼š
  - æšä¸¾å€¼ï¼šå¦‚ `strategy.mode` å¿…é¡»æ˜¯ç‰¹å®šå­—ç¬¦ä¸²ã€‚
  - èŒƒå›´ï¼šå¦‚ `retry.attempts` é™åˆ¶åœ¨ 1â€“5ã€‚
  - æ•°ç»„å…ƒç´ ï¼šå¦‚ `on_status_codes` å¿…é¡»æ˜¯ HTTP çŠ¶æ€ç æ•°ç»„ã€‚
- **æä¾›å•†ç™½åå•**ï¼š`targets[].provider` å¿…é¡»åœ¨ `VALID_PROVIDERS` å¸¸é‡ä¸­ï¼ˆä¾‹å¦‚ "openai"ã€"anthropic"ã€"azure-openai" ç­‰ï¼‰ï¼Œå¦åˆ™éªŒè¯å¤±è´¥ã€‚
- **å¿½ç•¥æœªçŸ¥å­—æ®µ**ï¼šZod é€šå¸¸å®½æ¾å¤„ç†æœªçŸ¥å­—æ®µï¼Œä½†æ ¸å¿ƒå­—æ®µå¿…é¡»ç¬¦åˆã€‚
- **å®‰å…¨éªŒè¯**ï¼šé¢å¤–æ£€æŸ¥ SSRFï¼ˆæœåŠ¡å™¨ç«¯è¯·æ±‚ä¼ªé€ ï¼‰é£é™©ï¼Œä¾‹å¦‚ï¼š
  - ç¦æ­¢å…ƒæ•°æ®ç«¯ç‚¹ï¼ˆå¦‚ "169.254.169.254"ï¼‰ã€‚
  - è¿‡æ»¤ç§æœ‰ IP èŒƒå›´ï¼ˆå¦‚ 10.0.0.0/8ï¼‰ã€‚
  - æ‹’ç»å†…éƒ¨ TLDï¼ˆå¦‚ .localï¼‰ã€‚
- **Header å’Œ Content-Type**ï¼šå¿…é¡»æœ‰æ­£ç¡®çš„ `Content-Type`ï¼ˆå¦‚ application/jsonï¼‰ï¼Œå¦åˆ™æ— æ³•è§£æã€‚

#### è¯¦ç»† Schema å±æ€§ï¼ˆè¡¨æ ¼å½¢å¼ï¼Œä¾¿äºå‚è€ƒï¼‰ï¼š
| å±æ€§                        | ç±»å‹          | æè¿°                   | çº¦æŸ/é»˜è®¤å€¼                                                 | ç¤ºä¾‹                                                        |
| --------------------------- | ------------- | ---------------------- | ----------------------------------------------------------- | ----------------------------------------------------------- |
| `strategy.mode`             | string        | è·¯ç”±ç­–ç•¥æ¨¡å¼           | å¿…é¡»æ˜¯ "loadbalance"ã€"fallback"ã€"conditional" æˆ– "single" | "loadbalance"                                               |
| `targets`                   | array         | ç›®æ ‡æä¾›å•†é…ç½®åˆ—è¡¨     | æ¯ä¸ªå…ƒç´ å¿…é¡»æœ‰ `provider`ï¼›æ”¯æŒåµŒå¥—                         | [{"provider": "openai", "weight": 1}]                       |
| `targets[].provider`        | string        | AI æä¾›å•†åç§°          | å¿…é¡»åœ¨ç™½åå•ä¸­                                              | "openai"                                                    |
| `targets[].weight`          | number        | è´Ÿè½½å‡è¡¡æƒé‡           | é»˜è®¤ 1ï¼›ç”¨äºéšæœºé€‰æ‹©                                        | 0.75                                                        |
| `targets[].override_params` | object        | è¦†ç›–å‚æ•°ï¼ˆå¦‚ api_keyï¼‰ | å¯é€‰ï¼›ç”¨äºæä¾›å•†ç‰¹å®šè®¾ç½®                                    | {"api_key": "sk-..."}                                       |
| `retry.attempts`            | number        | æœ€å¤§é‡è¯•æ¬¡æ•°           | èŒƒå›´ 1â€“5ï¼›é»˜è®¤ 0ï¼ˆç¦ç”¨ï¼‰                                    | 3                                                           |
| `retry.on_status_codes`     | array<number> | è§¦å‘é‡è¯•çš„çŠ¶æ€ç        | é»˜è®¤ [429, 500, 502, 503]                                   | [429, 502]                                                  |
| `request_timeout`           | number        | è¯·æ±‚è¶…æ—¶ï¼ˆmsï¼‰         | å¯é€‰                                                        | 30000                                                       |
| `cache.mode`                | string        | ç¼“å­˜æ¨¡å¼               | "simple"ï¼ˆå¼€æºç‰ˆæ”¯æŒï¼‰ï¼›"semantic"ï¼ˆä¼ä¸šç‰ˆï¼‰                | "simple"                                                    |
| `before_request_hooks`      | array<object> | è¾“å…¥éªŒè¯é’©å­           | æ¯ä¸ªå¯¹è±¡æŒ‡å®šæ’ä»¶ï¼ˆå¦‚ "regexMatch"ï¼‰                         | [{"plugin": "modelWhitelist", "allowed_models": ["gpt-4"]}] |
| `after_request_hooks`       | array<object> | è¾“å‡ºéªŒè¯é’©å­           | ç±»ä¼¼ before hooks                                           | [{"plugin": "jsonSchema", "schema": {...}}]                 |
| `metadata`                  | object        | è‡ªå®šä¹‰å…ƒæ•°æ®           | ç”¨äºè¿½è¸ªæˆ–æ¡ä»¶è·¯ç”±                                          | {"user_id": "123"}                                          |

#### ç¤ºä¾‹å®Œæ•´é…ç½®ï¼ˆç¬¦åˆ schemaï¼‰ï¼š
```json
{
  "strategy": { "mode": "fallback" },
  "targets": [
    { "provider": "openai", "override_params": { "api_key": "sk-..." } },
    { "provider": "anthropic", "override_params": { "api_key": "sk-..." } }
  ],
  "retry": { "attempts": 3, "on_status_codes": [429, 502] },
  "cache": { "mode": "simple" },
  "before_request_hooks": [{ "plugin": "modelWhitelist", "allowed_models": ["gpt-4"] }],
  "after_request_hooks": [{ "plugin": "jsonSchema", "schema": { "type": "object", "properties": { "answer": { "type": "string" } } } }],
  "metadata": { "env": "prod" }
}
```

å¦‚æœé…ç½®æ— æ•ˆï¼ˆå¦‚ mode ä¸æ˜¯æšä¸¾å€¼ï¼‰ï¼ŒGateway ä¼šè¿”å›é”™è¯¯ï¼Œé€šå¸¸æ˜¯ 400 Bad Request æˆ–ç±»ä¼¼ã€‚

- **å¼€æºç‰ˆå±€é™**ï¼šsemantic ç¼“å­˜æˆ–é«˜çº§ schema ç‰¹æ€§ï¼ˆå¦‚åŠ¨æ€ schemaï¼‰æ˜¯ä¼ä¸šç‰ˆç‹¬æœ‰ï¼›å¼€æºç‰ˆä¿æŒç®€å•ã€‚
- **æ¥æºå’Œè°ƒè¯•**ï¼šè¿™äº›è§„åˆ™æ¥è‡ª GitHub ä»“åº“çš„ `requestValidator.ts`ã€`plugins/` å’Œ READMEã€‚å¦‚æœå®ç°æ—¶å‡ºé”™ï¼Œæ£€æŸ¥æ—¥å¿—ï¼ˆè®¾ç½® `LOG_LEVEL=debug`ï¼‰æˆ–æŸ¥çœ‹æºä»£ç ã€‚

## 

### ç»Ÿè®¡ç”¨æˆ·ç”¨é‡

å…³é”®åœ¨äºç”¨é‡ç»Ÿè®¡ï¼ˆå¦‚ token æ¶ˆè€—ã€æˆæœ¬ã€è¯·æ±‚æ¬¡æ•°ï¼‰ï¼Œå¼€æºç‰ˆ Gateway æä¾›äº†è¶³å¤Ÿçš„é’©å­å’Œè¾“å‡ºï¼Œè®©ä½ èƒ½åœ¨è‡ªå·±çš„å¹³å°å±‚è½»æ¾å®ç°æŒ‰ç”¨æˆ·ï¼ˆæˆ–è™šæ‹Ÿå¯†é’¥ï¼‰èšåˆç»Ÿè®¡ï¼Œè€Œä¸éœ€è¦ä¿®æ”¹ Gateway æºä»£ç ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†æ–¹æ³•ï¼š

#### 1. **åˆ©ç”¨ Gateway çš„å“åº”å¤´è¿›è¡Œå®æ—¶ç»Ÿè®¡**

Gateway åœ¨æ¯ä¸ªå“åº”ä¸­ä¼šè‡ªåŠ¨æ·»åŠ ä»¥ä¸‹ headerï¼Œè¿™äº›ç›´æ¥æš´éœ²äº†ç”¨é‡æŒ‡æ ‡ï¼š

- x-portkey-tokens: token ç”¨é‡ï¼ˆprompt + completionï¼‰ï¼Œæ ¼å¼å¦‚ "prompt:123,completion:456"ã€‚
- x-portkey-cost: ä¼°è®¡æˆæœ¬ï¼ˆUSDï¼‰ï¼Œå¦‚æœæä¾›å•†æ”¯æŒã€‚
- x-portkey-latency: è¯·æ±‚å»¶è¿Ÿï¼ˆmsï¼‰ï¼Œç”¨äºæ€§èƒ½ç»Ÿè®¡ã€‚
- x-portkey-provider: ä½¿ç”¨çš„æä¾›å•†ï¼Œæ–¹ä¾¿æŒ‰æ¨¡å‹åˆ†ç±»ã€‚

**å®ç°æ–¹å¼**ï¼š

- åœ¨ä½ çš„å¹³å°å±‚ï¼ˆAPI Gateway æˆ–åç«¯æœåŠ¡ï¼‰ä½œä¸ºä»£ç†ï¼šæ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ï¼Œç”Ÿæˆ x-portkey-configï¼Œè½¬å‘åˆ° Portkey Gatewayï¼Œæ•è·å“åº”ã€‚

- è§£æè¿™äº› headerï¼Œå¹¶å…³è”åˆ°ç”¨æˆ·çš„ virtual_keyï¼ˆå› ä¸º virtual_key æ˜¯ä½ åœ¨è¯·æ±‚æ—¶å·²çŸ¥çš„ï¼‰ã€‚

- ç¤ºä¾‹ä»£ç ï¼ˆNode.js/Express é£æ ¼ï¼‰ï¼š

  JavaScript

  ```
  app.post('/your-endpoint', async (req, res) => {
    const virtualKey = req.headers['x-your-virtual-key']; // ä»å®¢æˆ·ç«¯è·å–
    const realKey = await getRealKeyFromDB(virtualKey); // ä½ çš„æ˜ å°„é€»è¾‘
    const portkeyConfig = generatePortkeyConfig(virtualKey, req.body.userConfig, req.body.metadata);
  
    // è½¬å‘åˆ° Portkey Gateway
    const gatewayResponse = await fetch('http://your-portkey-gateway/v1/chat/completions', {
      method: 'POST',
      headers: { 'x-portkey-config': JSON.stringify(portkeyConfig), ...otherHeaders },
      body: JSON.stringify(req.body)
    });
  
    // æ•è·ç”¨é‡
    const tokens = gatewayResponse.headers.get('x-portkey-tokens');
    const cost = gatewayResponse.headers.get('x-portkey-cost');
    const latency = gatewayResponse.headers.get('x-portkey-latency');
  
    // å­˜å‚¨åˆ°ä½ çš„æ•°æ®åº“ï¼ŒæŒ‰ virtual_key èšåˆ
    await logUsageToDB(virtualKey, { tokens, cost, latency, timestamp: Date.now() });
  
    // è¿”å›å“åº”ç»™å®¢æˆ·ç«¯
    res.json(await gatewayResponse.json());
  });
  ```

- **èšåˆç»Ÿè®¡**ï¼šåœ¨æ•°æ®åº“ï¼ˆå¦‚ MongoDB æˆ– PostgreSQLï¼‰ä¸­ï¼ŒæŒ‰ virtual_key æ±‡æ€»ï¼ˆe.g., SQL: SELECT SUM(tokens) FROM usage WHERE virtual_key = 'vk-user-alice' GROUP BY dateï¼‰ã€‚è¿™å¯ä»¥å®ç°æ¯æ—¥/æ¯æœˆç”¨é‡æŠ¥å‘Šã€é™é¢æ£€æŸ¥ï¼ˆe.g., å¦‚æœè¶…è¿‡é˜ˆå€¼ï¼Œæ‹’ç»æ–°è¯·æ±‚ï¼‰ã€‚

#### 2. **å¯é€‰ï¼šé€šè¿‡ metadata å¢å¼ºè¿½è¸ª**

å¦‚æœä½ æƒ³åœ¨ Gateway çš„æ—¥å¿—ä¸­è®°å½• virtual_keyï¼ˆä¾¿äºè°ƒè¯•æˆ–é›†ä¸­æ—¥å¿—ï¼‰ï¼Œå¯ä»¥åƒä½ ä¹‹å‰ä»£ç é‚£æ ·ï¼Œå°†å®ƒæ”¾å…¥ metadata å¯¹è±¡ä¸­ï¼š

JSON

```
"metadata": {
  "virtual_key": "vk-user-alice",
  "user_id": "123",
  "other_custom_data": "value"
}
```

- Gateway ä¼šå¿½ç•¥è¿™äº›è‡ªå®šä¹‰å­—æ®µï¼ˆä¸ä¼šå½±å“å¤„ç†ï¼‰ï¼Œä½†å®ƒä»¬ä¼šå‡ºç°åœ¨ï¼š
  - æ—¥å¿—è¾“å‡ºï¼ˆè®¾ç½® LOG_LEVEL=debug æ—¶ï¼Œæ—¥å¿—åŒ…æ‹¬å®Œæ•´ configï¼‰ã€‚
  - SSE æµï¼ˆ/log/stream endpointï¼ŒNode.js onlyï¼‰ï¼šå®æ—¶ JSON äº‹ä»¶ï¼ŒåŒ…æ‹¬ metadataã€‚
  - Web æ§åˆ¶å°ï¼ˆ/public/ï¼‰ï¼šå¯è§†åŒ–è¯·æ±‚è¯¦æƒ…ã€‚
- ä½ å¯ä»¥ä»è¿™äº›æ—¥å¿—ä¸­æå–æ•°æ®ï¼Œå¯¼å…¥ä½ çš„ç»Ÿè®¡ç³»ç»Ÿï¼ˆe.g., ç”¨ ELK Stack æˆ– Prometheus ç›‘æ§ï¼‰ã€‚ä½†å¦‚æœä½ çš„å¹³å°å·²ç»æ•è·äº†å“åº”å¤´ï¼Œè¿™æ­¥å¯é€‰â€”â€”ä¸ä¼  metadata é‡Œçš„ virtual_key ä¹Ÿä¸ä¼šä¸¢æ‰ç”¨é‡æ•°æ®ã€‚

#### 3. **ç‡é™åˆ¶å’Œé¢„ç®—æ§åˆ¶**

- è¦é˜²æ­¢ç”¨æˆ·è¶…æ”¯ï¼Œåœ¨ä½ çš„å¹³å°å±‚æ·»åŠ ç‡é™åˆ¶å™¨ï¼ˆe.g., ç”¨ Redis + ioredis æˆ–åº“å¦‚ rate-limiter-flexibleï¼‰ï¼ŒåŸºäº virtual_key æ£€æŸ¥å†å²ç”¨é‡ã€‚
- ç¤ºä¾‹ï¼šç”Ÿæˆ config å‰ï¼ŒæŸ¥è¯¢ç´¯è®¡ tokensï¼Œå¦‚æœ > é™é¢ï¼Œè¿”å› 429 é”™è¯¯ã€‚

#### æ³¨æ„äº‹é¡¹

- **æ€§èƒ½å¼€é”€**ï¼šæ•è·å“åº”å¤´å‡ ä¹æ— é¢å¤–æˆæœ¬ï¼Œå› ä¸ºå®ƒæ˜¯ HTTP æ ‡å‡†éƒ¨åˆ†ã€‚
- **å‡†ç¡®æ€§**ï¼štoken å’Œ cost æ˜¯ Gateway åŸºäºæä¾›å•†å“åº”è®¡ç®—çš„ï¼Œå¾ˆå¯é ã€‚ä½† cost å¯èƒ½ä¸æ€»æ˜¯å¯ç”¨ï¼ˆå–å†³äºæä¾›å•†å¦‚ OpenAI çš„æ”¯æŒï¼‰ã€‚
- **æ‰©å±•**ï¼šå¦‚æœç”¨é‡ç»Ÿè®¡å¤æ‚ï¼Œå¯ä»¥é›†æˆå¤–éƒ¨å·¥å…·å¦‚ Prometheusï¼ˆç›‘æ§æŒ‡æ ‡ï¼‰æˆ– Datadogï¼ˆæ—¥å¿—åˆ†æï¼‰ï¼Œä½†ä¿æŒåœ¨ä½ çš„å±‚å¤„ç†ã€‚
- **å¼€æºç‰ˆå±€é™**ï¼šæ²¡æœ‰å†…ç½®çš„ç”¨æˆ·ä»ªè¡¨ç›˜æˆ–è™šæ‹Ÿå¯†é’¥è¿½è¸ªï¼ˆé‚£æ˜¯ä¼ä¸šç‰ˆåŠŸèƒ½ï¼‰ï¼Œæ‰€ä»¥å…¨é ä½ è‡ªå»ºã€‚ä½†è¿™ä¹Ÿç»™ä½ çµæ´»æ€§ï¼ŒæŒ‰éœ€å®šåˆ¶ã€‚


# åŸºäºportkey gateway çš„é…ç½®ç³»ç»Ÿè®¾è®¡
# è¡¨

```postgresql
-- æ ¸å¿ƒå…ƒæ•°æ®è¡¨ï¼ˆå®šä¹‰ç³»ç»Ÿæœ¬èº«ï¼‰
CREATE TABLE data.config_levels (
    level_name TEXT PRIMARY KEY,        -- 'global', 'tenant', 'user', 'virtual_key'
    display_name TEXT NOT NULL,         -- æ˜¾ç¤ºåç§°
    parent_level TEXT REFERENCES data.config_levels(level_name), -- çˆ¶çº§å±‚çº§
    inherit_priority INTEGER NOT NULL,  -- ç»§æ‰¿ä¼˜å…ˆçº§ï¼ˆæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼‰
    description TEXT,
    is_system_level BOOLEAN DEFAULT false, -- ç³»ç»Ÿå±‚çº§ä¸å¯åˆ é™¤
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- é…ç½®ç±»å‹å®šä¹‰ï¼ˆæ‰€æœ‰å¯é…ç½®é¡¹ï¼‰
CREATE TABLE data.config_types (
    type_name TEXT PRIMARY KEY,           -- 'rate_limits', 'model_access', 'billing_rules'
    display_name TEXT NOT NULL,           -- æ˜¾ç¤ºåç§°
    value_schema JSONB NOT NULL,          -- JSON SchemaéªŒè¯è§„åˆ™
    default_value JSONB,                  -- å…¨å±€é»˜è®¤å€¼
    merge_strategy TEXT NOT NULL,         -- 'override', 'deep_merge', 'array_append'
    description TEXT,
    is_system_type BOOLEAN DEFAULT false, -- ç³»ç»Ÿç±»å‹ä¸å¯åˆ é™¤
    created_at TIMESTAMPTZ DEFAULT NOW(),
    supports_tier_entitlements boolean DEFAULT true
);

-- åˆå¹¶ç­–ç•¥å®šä¹‰ï¼ˆå¯æ‰©å±•çš„åˆå¹¶é€»è¾‘ï¼‰
CREATE TABLE data.merge_strategies (
    strategy_name TEXT PRIMARY KEY,       -- 'override', 'deep_merge', 'array_append'
    description TEXT NOT NULL,
    implementation_function TEXT,         -- å®ç°å‡½æ•°åï¼ˆå¯è‡ªå®šä¹‰ï¼‰
    is_builtin BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- åŠ¨æ€ç»§æ‰¿è§„åˆ™ç³»ç»Ÿ
-- å±‚çº§é—´ç»§æ‰¿è§„åˆ™ï¼ˆå®Œå…¨å¯é…ç½®ï¼‰
CREATE TABLE data.inheritance_rules (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    parent_level TEXT NOT NULL REFERENCES data.config_levels(level_name),
    child_level TEXT NOT NULL REFERENCES data.config_levels(level_name),
    config_type TEXT NOT NULL REFERENCES data.config_types(type_name),
    
    -- ç»§æ‰¿æ§åˆ¶
    is_inheritance_enabled BOOLEAN DEFAULT true,
    custom_merge_strategy TEXT REFERENCES data.merge_strategies(strategy_name),
    conflict_resolution TEXT DEFAULT 'child_wins', -- 'parent_wins', 'child_wins', 'merge'
    
    -- æ¡ä»¶ç»§æ‰¿
    condition_expression JSONB, -- {"field": "tier_name", "operator": "in", "value": ["premium", "enterprise"]}
    condition_description TEXT,
    
    -- ç”Ÿæ•ˆæ§åˆ¶
    is_active BOOLEAN DEFAULT true,
    effective_from TIMESTAMPTZ DEFAULT NOW(),
    effective_to TIMESTAMPTZ,
    
    UNIQUE(parent_level, child_level, config_type)
);
CREATE OR REPLACE TRIGGER prevent_inheritance_cycle_trigger
    BEFORE INSERT OR UPDATE 
    ON data.inheritance_rules
    FOR EACH ROW
    EXECUTE FUNCTION data.prevent_inheritance_cycle();

-- å¥—é¤å®šä¹‰ï¼ˆä¸šåŠ¡æ¨¡å‹æ ¸å¿ƒï¼‰
CREATE TABLE data.tier_definitions (
    tier_name TEXT PRIMARY KEY,
    display_name TEXT NOT NULL,
    description TEXT,
    
    -- å®šä»·ä¿¡æ¯
    pricing_model TEXT DEFAULT 'monthly', -- 'monthly', 'pay_as_you_go', 'custom'
    base_price NUMERIC(10,4),
    currency TEXT DEFAULT 'CNY',
    
    -- ä¸šåŠ¡é€»è¾‘
    is_public BOOLEAN DEFAULT true,
    is_active BOOLEAN DEFAULT true,
    display_order INTEGER DEFAULT 1,
    
    -- å…ƒæ•°æ®
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- å¥—é¤ç‰¹æ€§æ˜ å°„ï¼ˆå¥—é¤ä¸é…ç½®çš„å…³è”ï¼‰
CREATE TABLE data.tier_feature_mappings (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    tier_name TEXT NOT NULL REFERENCES data.tier_definitions(tier_name),
    config_type TEXT NOT NULL REFERENCES data.config_types(type_name),
    
    -- ç‰¹æ€§é…ç½®
    feature_value JSONB NOT NULL,           -- è¯¥å¥—é¤çš„é…ç½®å€¼
    is_default_for_tier BOOLEAN DEFAULT true, -- æ˜¯å¦å¥—é¤é»˜è®¤ç‰¹æ€§
    
    -- æ¡ä»¶ç‰¹æ€§
    condition_expression JSONB,             -- æ»¡è¶³æ¡ä»¶æ—¶æ‰ç”Ÿæ•ˆ
    condition_description TEXT,
    
    -- ç”Ÿæ•ˆæ§åˆ¶
    is_active BOOLEAN DEFAULT true,
    effective_from TIMESTAMPTZ DEFAULT NOW(),
    effective_to TIMESTAMPTZ,
    
    UNIQUE(tier_name, config_type) -- ä¸€ä¸ªå¥—é¤ä¸€ä¸ªé…ç½®ç±»å‹åªèƒ½æœ‰ä¸€æ¡æœ‰æ•ˆè®°å½•
);
CREATE OR REPLACE TRIGGER prevent_unsupported_tier_features_trigger
    BEFORE INSERT OR UPDATE 
    ON data.tier_feature_mappings
    FOR EACH ROW
    EXECUTE FUNCTION data.prevent_unsupported_tier_features();

-- ç»Ÿä¸€é…ç½®å­˜å‚¨ï¼ˆæ‰€æœ‰é…ç½®éƒ½åœ¨è¿™é‡Œï¼‰
CREATE TABLE IF NOT EXISTS data.unified_config_store
(
    id uuid NOT NULL DEFAULT gen_random_uuid(),
    config_type text COLLATE pg_catalog."default" NOT NULL,
    level_name text COLLATE pg_catalog."default" NOT NULL,
    scope_id uuid,
    config_value jsonb NOT NULL,
    version integer DEFAULT 1,
    version_notes text COLLATE pg_catalog."default",
    effective_from timestamp with time zone DEFAULT now(),
    effective_to timestamp with time zone,
    applied_tier text COLLATE pg_catalog."default",
    condition_context jsonb,
    created_by uuid,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT unified_config_store_pkey PRIMARY KEY (id),
    CONSTRAINT unified_config_store_applied_tier_fkey FOREIGN KEY (applied_tier)
        REFERENCES data.tier_definitions (tier_name) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE NO ACTION,
    CONSTRAINT unified_config_store_config_type_fkey FOREIGN KEY (config_type)
        REFERENCES data.config_types (type_name) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE NO ACTION,
    CONSTRAINT unified_config_store_created_by_fkey FOREIGN KEY (created_by)
        REFERENCES auth.login (id) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE NO ACTION,
    CONSTRAINT unified_config_store_level_name_fkey FOREIGN KEY (level_name)
        REFERENCES data.config_levels (level_name) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE NO ACTION,
    CONSTRAINT scope_constraint CHECK ((level_name = ANY (ARRAY['global'::text, 'test_global'::text])) AND scope_id IS NULL OR (level_name <> ALL (ARRAY['global'::text, 'test_global'::text])) AND scope_id IS NOT NULL)
)
CREATE OR REPLACE TRIGGER check_scope_trigger
    BEFORE INSERT OR UPDATE 
    ON data.unified_config_store
    FOR EACH ROW
    EXECUTE FUNCTION data.check_scope_constraint();

-- Trigger: prevent_unsupported_tier_references_trigger
CREATE OR REPLACE TRIGGER prevent_unsupported_tier_references_trigger
    BEFORE INSERT OR UPDATE 
    ON data.unified_config_store
    FOR EACH ROW
    EXECUTE FUNCTION data.prevent_unsupported_tier_references();

-- Trigger: validate_config_effective_period_trigger
CREATE OR REPLACE TRIGGER validate_config_effective_period_trigger
    BEFORE INSERT OR UPDATE 
    ON data.unified_config_store
    FOR EACH ROW
    EXECUTE FUNCTION data.validate_config_effective_period();

-- Trigger: validate_config_schema_trigger
CREATE OR REPLACE TRIGGER validate_config_schema_trigger
    BEFORE INSERT OR UPDATE 
    ON data.unified_config_store
    FOR EACH ROW
    EXECUTE FUNCTION data.validate_config_schema();

-- é«˜æ€§èƒ½ç´¢å¼•
CREATE INDEX idx_unified_config_lookup ON data.unified_config_store(level_name, scope_id, config_type) 
WHERE effective_to IS NULL;

CREATE INDEX idx_unified_config_tier ON data.unified_config_store(applied_tier);
CREATE INDEX idx_unified_config_effective ON data.unified_config_store(effective_from, effective_to);


```

# å‡½æ•°

```postgresql
-- å¢å¼ºç‰ˆé…ç½®è§£æå‡½æ•°ï¼ˆæ”¯æŒå®Œæ•´åŠ¨æ€æ€§ï¼‰
CREATE OR REPLACE FUNCTION api.resolve_dynamic_config(
	p_config_type text,
	p_target_level text,
	p_target_scope_id uuid,
	p_context jsonb DEFAULT '{}'::jsonb)
    RETURNS jsonb
    LANGUAGE 'plpgsql'
    COST 100
    VOLATILE PARALLEL UNSAFE
AS $BODY$
DECLARE
    v_result JSONB;
    v_inheritance_path TEXT[];
    v_current_config JSONB;
    v_i INTEGER;
    v_found_any_config BOOLEAN := false;
    v_current_level TEXT;
    v_tier_config JSONB;
    v_has_specific_config BOOLEAN := false;
BEGIN
 
    -- ğŸŸ¢ å…ˆè·å–å¥—é¤é…ç½®
IF p_context ? 'tier_name' THEN
    -- ğŸŸ¢ æ–°å¢æ£€æŸ¥
    IF EXISTS (
        SELECT 1 FROM data.config_types 
        WHERE type_name = p_config_type 
        AND supports_tier_entitlements = true
    ) THEN
        v_tier_config := api.get_tier_default_config(p_config_type, p_context->>'tier_name', p_context);
        RAISE NOTICE 'ğŸ¯ å¥—é¤æƒç›Š: %', v_tier_config;
    ELSE
        v_tier_config := NULL;
        RAISE NOTICE 'âš ï¸ é…ç½®ç±»å‹"%s"ä¸æ”¯æŒå¥—é¤æƒç›Š', p_config_type;
    END IF;
ELSE
    v_tier_config := NULL;
END IF;

    -- 1. æ„å»ºç»§æ‰¿è·¯å¾„
    RAISE NOTICE 'ğŸ“‹ æ­¥éª¤1: æ„å»ºç»§æ‰¿è·¯å¾„...';
    WITH RECURSIVE inheritance_path AS (
        SELECT 
            level_name,
            parent_level,
            inherit_priority,
            1 as depth,
            level_name as start_level
        FROM data.config_levels 
        WHERE level_name = p_target_level
        
        UNION ALL
        
        SELECT 
            parent.level_name,
            parent.parent_level,
            parent.inherit_priority,
            ip.depth + 1,
            ip.start_level
        FROM data.config_levels parent
        INNER JOIN inheritance_path ip ON parent.level_name = ip.parent_level
        WHERE ip.parent_level IS NOT NULL
          AND ip.depth < 10     -- æ·±åº¦é™åˆ¶              -- ç»§æ‰¿å®Œæ•´æ€§ä¿éšœ
          AND EXISTS (          -- ç¡®ä¿ç»§æ‰¿è§„åˆ™å­˜åœ¨ä¸”æœ‰æ•ˆ
            SELECT 1 FROM data.inheritance_rules ir
            WHERE ir.parent_level = parent.level_name
              AND ir.child_level = ip.level_name
              AND ir.config_type = p_config_type
              AND ir.is_inheritance_enabled = true
              AND ir.is_active = true
              AND (ir.effective_to IS NULL OR ir.effective_to > NOW())
          )
    )
    SELECT ARRAY_AGG(ip.level_name ORDER BY ip.inherit_priority ASC, ip.depth ASC) 
    INTO v_inheritance_path
    FROM inheritance_path ip;
    
    IF v_inheritance_path IS NULL THEN
        v_inheritance_path := ARRAY[p_target_level];
    END IF;
    
    RAISE NOTICE 'âœ… ç»§æ‰¿è·¯å¾„: %', v_inheritance_path;

    -- 2. æŒ‰è·¯å¾„é¡ºåºåˆå¹¶é…ç½®
    RAISE NOTICE 'ğŸ”„ æ­¥éª¤2: åˆå¹¶é…ç½®...';
    v_result := NULL;
    v_found_any_config := false;
    v_has_specific_config := false;
    
    FOR v_i IN 1..array_length(v_inheritance_path, 1) LOOP
        v_current_level := v_inheritance_path[v_i];
        RAISE NOTICE '  å¤„ç†å±‚çº§ %/%: %', v_i, array_length(v_inheritance_path, 1), v_current_level;
        
        v_current_config := api.get_level_config_with_context(
            p_config_type,
            v_current_level,
            CASE 
                WHEN v_current_level = p_target_level THEN p_target_scope_id
                ELSE NULL
            END,
            p_context
        );
        
        RAISE NOTICE '  é…ç½®ç»“æœ: %', v_current_config;
        
        IF v_current_config IS NOT NULL THEN
            v_found_any_config := true;
            
            IF v_current_level = p_target_level AND p_target_scope_id IS NOT NULL THEN
                v_has_specific_config := true;
                RAISE NOTICE '  ğŸ¯ æ‰¾åˆ°ç‰¹å®šé…ç½®ï¼Œæ ‡è®°ä¸ºå·²æ‰¾åˆ°ç‰¹å®šé…ç½®';
            END IF;
            
            IF v_result IS NULL THEN
                v_result := v_current_config;
                RAISE NOTICE '  åˆå§‹é…ç½®: %', v_result;
            ELSE
                v_result := api.dynamic_merge_config(
                    v_result, 
                    v_current_config, 
                    p_config_type,
                    v_current_level,
                    p_context
                );
                RAISE NOTICE '  åˆå¹¶åç»“æœ: %', v_result;
            END IF;
        END IF;
    END LOOP;

    RAISE NOTICE 'ğŸ“Š åˆå¹¶å®Œæˆç»“æœ: %, æ‰¾åˆ°é…ç½®: %, æœ‰ç‰¹å®šé…ç½®: %', v_result, v_found_any_config, v_has_specific_config;
    
    -- ğŸŸ¢ æ­¥éª¤3: ç®€åŒ–çš„å¥—é¤åº”ç”¨é€»è¾‘
    IF v_tier_config IS NOT NULL THEN
        -- æƒ…å†µ1: æ²¡æœ‰æ‰¾åˆ°ä»»ä½•é…ç½® â†’ ç›´æ¥ä½¿ç”¨å¥—é¤
        IF v_result IS NULL THEN
            RAISE NOTICE 'ğŸ° æƒ…å†µ1: æ— ä»»ä½•é…ç½®ï¼Œç›´æ¥ä½¿ç”¨å¥—é¤';
            v_result := v_tier_config;
        
        -- ğŸŸ¢ æƒ…å†µ2: æœ‰é…ç½®ä½†æ²¡æœ‰ç‰¹å®šé…ç½® â†’ å¼ºåˆ¶ä½¿ç”¨å¥—é¤é…ç½®
        ELSIF NOT v_has_specific_config THEN
            RAISE NOTICE 'ğŸ° æƒ…å†µ2: æœ‰é»˜è®¤é…ç½®ä½†æ— ç‰¹å®šé…ç½®ï¼Œå¼ºåˆ¶ä½¿ç”¨å¥—é¤é…ç½®';
            v_result := v_tier_config;  -- ğŸŸ¢ ç›´æ¥ä½¿ç”¨å¥—é¤ï¼Œå¿½ç•¥é»˜è®¤é…ç½®
            RAISE NOTICE '  ğŸ¯ å¥—é¤é…ç½®è¦†ç›–é»˜è®¤é…ç½®: %', v_result;
        
        -- æƒ…å†µ3: æœ‰ç‰¹å®šé…ç½® â†’ ä¿æŒç°æœ‰é€»è¾‘ï¼ˆç‰¹å®šé…ç½®ä¼˜å…ˆï¼‰
        ELSE
            RAISE NOTICE 'ğŸ° æƒ…å†µ3: æœ‰ç‰¹å®šé…ç½®ï¼Œä¿æŒç°æœ‰ç»“æœï¼ˆç‰¹å®šé…ç½®ä¼˜å…ˆï¼‰';
            -- ä¸ä¿®æ”¹ v_result
        END IF;
    END IF;
    
    -- 4. å¦‚æœè¿˜æ˜¯æ²¡æœ‰é…ç½®ï¼Œä½¿ç”¨å…¨å±€é»˜è®¤å€¼
    IF v_result IS NULL THEN
        RAISE NOTICE 'ğŸŒ æ­¥éª¤4: ä½¿ç”¨å…¨å±€é»˜è®¤å€¼';
        SELECT default_value INTO v_result
        FROM data.config_types
        WHERE type_name = p_config_type;
        RAISE NOTICE '  å…¨å±€é»˜è®¤å€¼: %', v_result;
    END IF;
    
    RAISE NOTICE 'ğŸ¯ æœ€ç»ˆç»“æœ: %', v_result;
    RETURN v_result;
END;
$BODY$;

CREATE OR REPLACE FUNCTION api.get_level_config_with_context(
	p_config_type text,
	p_level_name text,
	p_scope_id uuid DEFAULT NULL::uuid,
	p_context jsonb DEFAULT '{}'::jsonb)
    RETURNS jsonb
    LANGUAGE 'plpgsql'
    COST 100
    STABLE PARALLEL UNSAFE
AS $BODY$
DECLARE
    v_config JSONB;
    v_tier_name TEXT;
BEGIN
    v_tier_name := p_context->>'tier_name';
    
    RAISE NOTICE '    ğŸ” æŸ¥è¯¢é…ç½®: type=%, level=%, scope_id=%, tier=%', 
        p_config_type, p_level_name, p_scope_id, v_tier_name;
    
    -- ğŸŸ¢ æ˜ç¡®åŒºåˆ†ä¸¤ç§æƒ…å†µï¼š
    IF p_scope_id IS NOT NULL THEN
        -- æƒ…å†µ1ï¼šæŸ¥è¯¢ç‰¹å®šå®ä½“çš„é…ç½®ï¼ˆç²¾ç¡®åŒ¹é… scope_idï¼‰
        SELECT ucs.config_value INTO v_config
        FROM data.unified_config_store ucs
        WHERE ucs.config_type = p_config_type
          AND ucs.level_name = p_level_name
          AND ucs.scope_id = p_scope_id  -- ğŸŸ¢ ç²¾ç¡®åŒ¹é…
          AND (ucs.effective_to IS NULL OR ucs.effective_to > NOW())
          AND (ucs.applied_tier IS NULL OR ucs.applied_tier = v_tier_name)
          AND (ucs.condition_context IS NULL OR api.evaluate_condition(ucs.condition_context, p_context))
        ORDER BY 
            CASE WHEN ucs.applied_tier = v_tier_name THEN 1 ELSE 2 END,
            ucs.version DESC
        LIMIT 1;
    ELSE
        -- æƒ…å†µ2ï¼šæŸ¥è¯¢é»˜è®¤é…ç½®ï¼ˆç”¨äºç»§æ‰¿ï¼‰ï¼Œåªæ‰¾ scope_id IS NULL çš„è®°å½•
        SELECT ucs.config_value INTO v_config
        FROM data.unified_config_store ucs
        WHERE ucs.config_type = p_config_type
          AND ucs.level_name = p_level_name
          AND ucs.scope_id IS NULL  -- ğŸŸ¢ åªæ‰¾é»˜è®¤é…ç½®
          AND (ucs.effective_to IS NULL OR ucs.effective_to > NOW())
          AND (ucs.applied_tier IS NULL OR ucs.applied_tier = v_tier_name)
          AND (ucs.condition_context IS NULL OR api.evaluate_condition(ucs.condition_context, p_context))
        ORDER BY 
            CASE WHEN ucs.applied_tier = v_tier_name THEN 1 ELSE 2 END,
            ucs.version DESC
        LIMIT 1;
    END IF;
    
    RAISE NOTICE '    ğŸ“¦ æ‰¾åˆ°é…ç½®: %', v_config;
    
    RETURN v_config;
END;
$BODY$;


CREATE OR REPLACE FUNCTION api.get_tier_default_config(
	p_config_type text,
	p_tier_name text,
	p_context jsonb DEFAULT '{}'::jsonb)
    RETURNS jsonb
    LANGUAGE 'plpgsql'
    COST 100
    STABLE PARALLEL UNSAFE
AS $BODY$
DECLARE
    v_config JSONB;
BEGIN
    RAISE NOTICE '    ğŸ° æŸ¥è¯¢å¥—é¤é»˜è®¤é…ç½®: type=%, tier=%', p_config_type, p_tier_name;
    
    -- æŸ¥è¯¢å¥—é¤ç‰¹æ€§æ˜ å°„ï¼Œè€ƒè™‘æ¡ä»¶å’Œç”Ÿæ•ˆæ—¶é—´
    SELECT tfm.feature_value INTO v_config
    FROM data.tier_feature_mappings tfm
    WHERE tfm.tier_name = p_tier_name
      AND tfm.config_type = p_config_type
      AND tfm.is_active = true
      AND (tfm.effective_to IS NULL OR tfm.effective_to > NOW())
      AND (
        -- æ¡ä»¶åŒ¹é…
        tfm.condition_expression IS NULL 
        OR api.evaluate_condition(tfm.condition_expression, p_context)
      )
    ORDER BY 
        -- ä¼˜å…ˆçº§ï¼šæœ‰æ¡ä»¶åŒ¹é…çš„ > æ— æ¡ä»¶é»˜è®¤çš„
        CASE WHEN tfm.condition_expression IS NULL THEN 2 ELSE 1 END,
        tfm.effective_from DESC
    LIMIT 1;
    
    RAISE NOTICE '    ğŸ“¦ å¥—é¤é…ç½®ç»“æœ: %', v_config;
    RETURN v_config;
END;
$BODY$;


CREATE OR REPLACE FUNCTION api.dynamic_merge_config(
	parent_config jsonb,
	child_config jsonb,
	p_config_type text,
	current_level text,
	context jsonb)
    RETURNS jsonb
    LANGUAGE 'plpgsql'
    COST 100
    STABLE PARALLEL UNSAFE
AS $BODY$
DECLARE
    v_merge_strategy TEXT;
    v_custom_strategy TEXT;
    v_default_strategy TEXT;
BEGIN
    -- å¦‚æœçˆ¶é…ç½®ä¸ºç©ºï¼Œç›´æ¥è¿”å›å­é…ç½®
    IF parent_config IS NULL THEN
        RETURN child_config;
    END IF;
    
    -- å¦‚æœå­é…ç½®ä¸ºç©ºï¼Œç›´æ¥è¿”å›çˆ¶é…ç½®
    IF child_config IS NULL THEN
        RETURN parent_config;
    END IF;
    
    -- æŸ¥æ‰¾é…ç½®ç±»å‹çš„é»˜è®¤åˆå¹¶ç­–ç•¥
    SELECT merge_strategy INTO v_default_strategy
    FROM data.config_types
    WHERE type_name = p_config_type;
    
    -- æŸ¥æ‰¾ç»§æ‰¿è§„åˆ™ä¸­çš„è‡ªå®šä¹‰ç­–ç•¥
    SELECT ir.custom_merge_strategy INTO v_custom_strategy
    FROM data.inheritance_rules ir
    WHERE ir.config_type = p_config_type
      AND ir.child_level = current_level
      AND ir.is_active = true
      AND (ir.effective_to IS NULL OR ir.effective_to > NOW())
      AND (ir.condition_expression IS NULL OR api.evaluate_condition(ir.condition_expression, context));
    
    -- ç¡®å®šä½¿ç”¨çš„åˆå¹¶ç­–ç•¥ï¼ˆä¼˜å…ˆä½¿ç”¨è‡ªå®šä¹‰ç­–ç•¥ï¼‰
    v_merge_strategy := COALESCE(v_custom_strategy, v_default_strategy, 'override');
    
    RAISE NOTICE '    ğŸ¯ åˆå¹¶ç­–ç•¥: % (è‡ªå®šä¹‰: %, é»˜è®¤: %)', 
        v_merge_strategy, v_custom_strategy, v_default_strategy;
    
    -- æ‰§è¡Œåˆå¹¶
    CASE v_merge_strategy
        WHEN 'override' THEN
            RAISE NOTICE '    ğŸ”„ ä½¿ç”¨è¦†ç›–ç­–ç•¥';
            RETURN child_config;
            
        WHEN 'deep_merge' THEN
            RAISE NOTICE '    ğŸ”„ ä½¿ç”¨æ·±åº¦åˆå¹¶ç­–ç•¥';
            RETURN parent_config || child_config;
            
        WHEN 'array_append' THEN
            RAISE NOTICE '    ğŸ”„ ä½¿ç”¨æ•°ç»„è¿½åŠ ç­–ç•¥';
            -- æ™ºèƒ½æ•°ç»„åˆå¹¶ï¼šåˆå¹¶æ‰€æœ‰æ•°ç»„å­—æ®µï¼Œå…¶ä»–å­—æ®µä½¿ç”¨å­é…ç½®
            RETURN jsonb_build_object(
                'allowed_models', 
                COALESCE(parent_config->'allowed_models', '[]'::jsonb) || 
                COALESCE(child_config->'allowed_models', '[]'::jsonb)
            ) || (child_config - 'allowed_models');
            
        WHEN 'array_merge' THEN
            RAISE NOTICE '    ğŸ”„ ä½¿ç”¨æ•°ç»„åˆå¹¶ç­–ç•¥';
            -- ä¸ array_append ç›¸åŒ
            RETURN jsonb_build_object(
                'allowed_models', 
                COALESCE(parent_config->'allowed_models', '[]'::jsonb) || 
                COALESCE(child_config->'allowed_models', '[]'::jsonb)
            ) || (child_config - 'allowed_models');
            
        ELSE
            RAISE NOTICE '    âš ï¸ ä½¿ç”¨é»˜è®¤è¦†ç›–ç­–ç•¥';
            RETURN child_config;
    END CASE;
END;
$BODY$;


CREATE OR REPLACE FUNCTION api.evaluate_condition(
	condition_expression jsonb,
	context jsonb)
    RETURNS boolean
    LANGUAGE 'plpgsql'
    COST 100
    STABLE PARALLEL UNSAFE
AS $BODY$
DECLARE
    v_field TEXT;
    v_operator TEXT;
    v_value JSONB;
    v_context_value JSONB;
    v_result BOOLEAN := false;
BEGIN
    -- å‚æ•°éªŒè¯
    IF condition_expression IS NULL OR context IS NULL THEN
        RETURN false;
    END IF;
    
    -- æå–å­—æ®µ
    BEGIN
        v_field := condition_expression->>'field';
        v_operator := condition_expression->>'operator';
        v_value := condition_expression->'value';
        v_context_value := context->v_field;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE NOTICE '    âš ï¸ æ¡ä»¶è¡¨è¾¾å¼æ ¼å¼é”™è¯¯: %', condition_expression;
            RETURN false;
    END;
    
    -- éªŒè¯å¿…éœ€å­—æ®µ
    IF v_field IS NULL OR v_operator IS NULL THEN
        RAISE NOTICE '    âš ï¸ ç¼ºå°‘å¿…éœ€å­—æ®µ: field=%, operator=%', v_field, v_operator;
        RETURN false;
    END IF;
    
    RAISE NOTICE '    ğŸ¯ æ¡ä»¶è¯„ä¼°: field=%, operator=%, value=%, context_value=%', 
        v_field, v_operator, v_value, v_context_value;
    
    -- å¥å£®çš„æ¡ä»¶è¯„ä¼°
    BEGIN
        CASE v_operator
            WHEN 'equals' THEN
                v_result := (v_context_value = v_value);
                
            WHEN 'in' THEN
                IF jsonb_typeof(v_value) = 'array' AND v_context_value IS NOT NULL THEN
                    v_result := EXISTS (
                        SELECT 1 
                        FROM jsonb_array_elements(v_value) AS elem
                        WHERE elem = v_context_value
                    );
                ELSE
                    v_result := false;
                END IF;
                
            WHEN 'not_in' THEN
                IF jsonb_typeof(v_value) = 'array' AND v_context_value IS NOT NULL THEN
                    v_result := NOT EXISTS (
                        SELECT 1 
                        FROM jsonb_array_elements(v_value) AS elem
                        WHERE elem = v_context_value
                    );
                ELSE
                    v_result := false;
                END IF;
                
            WHEN 'greater_than' THEN
                BEGIN
                    v_result := (v_context_value::NUMERIC) > (v_value::NUMERIC);
                EXCEPTION
                    WHEN OTHERS THEN
                        v_result := false;
                END;
                
            WHEN 'less_than' THEN
                BEGIN
                    v_result := (v_context_value::NUMERIC) < (v_value::NUMERIC);
                EXCEPTION
                    WHEN OTHERS THEN
                        v_result := false;
                END;
                
            WHEN 'exists' THEN
                v_result := (context ? v_field);
                
            ELSE
                RAISE NOTICE '    âš ï¸ æœªçŸ¥æ“ä½œç¬¦: %', v_operator;
                v_result := false;
        END CASE;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE NOTICE '    âš ï¸ æ¡ä»¶è¯„ä¼°å‡ºé”™: %', SQLERRM;
            v_result := false;
    END;
    
    RETURN v_result;
END;
$BODY$;

```

# æµ‹è¯•å‡½æ•°

## åŸºç¡€æµ‹è¯•

```postgresql
CREATE OR REPLACE FUNCTION api.test_dynamic_config_system(
	)
    RETURNS TABLE(test_name text, config_type text, target_level text, scope_id uuid, context jsonb, result jsonb, status text) 
    LANGUAGE 'plpgsql'
    COST 100
    VOLATILE PARALLEL UNSAFE
    ROWS 1000

AS $BODY$
DECLARE
    v_global_config_ids UUID[];
    v_tenant_config_ids UUID[];
    v_user_config_ids UUID[];
    v_virtual_key_config_ids UUID[];
    v_tenant_id UUID := gen_random_uuid();
    v_user_id UUID := gen_random_uuid();
    v_virtual_key_id UUID := gen_random_uuid();
    v_count INTEGER;
BEGIN
    -- 1. åˆå§‹åŒ–æµ‹è¯•æ•°æ®
    RAISE NOTICE 'åˆå§‹åŒ–æµ‹è¯•æ•°æ®...';
    
    -- æ¸…ç†å¯èƒ½å­˜åœ¨çš„æµ‹è¯•æ•°æ®
    DELETE FROM data.unified_config_store WHERE level_name LIKE 'test_%';
    DELETE FROM data.inheritance_rules WHERE parent_level LIKE 'test_%' OR child_level LIKE 'test_%';
    DELETE FROM data.tier_feature_mappings WHERE tier_name LIKE 'test_%';
    DELETE FROM data.tier_definitions WHERE tier_name LIKE 'test_%';
    DELETE FROM data.merge_strategies WHERE strategy_name IN ('override', 'deep_merge', 'array_merge', 'array_append');
    DELETE FROM data.config_types WHERE type_name LIKE 'test_%';
    DELETE FROM data.config_levels WHERE level_name LIKE 'test_%';
    
    -- åˆå§‹åŒ–å±‚çº§
    INSERT INTO data.config_levels (level_name, display_name, parent_level, inherit_priority, description, is_system_level) VALUES 
    ('test_global', 'æµ‹è¯•å…¨å±€', NULL, 1, 'æµ‹è¯•å…¨å±€é…ç½®', false),
    ('test_tenant', 'æµ‹è¯•ç§Ÿæˆ·', 'test_global', 2, 'æµ‹è¯•ç§Ÿæˆ·é…ç½®', false),
    ('test_user', 'æµ‹è¯•ç”¨æˆ·', 'test_tenant', 3, 'æµ‹è¯•ç”¨æˆ·é…ç½®', false),
    ('test_virtual_key', 'æµ‹è¯•å¯†é’¥', 'test_user', 4, 'æµ‹è¯•å¯†é’¥é…ç½®', false);
    
    -- åˆå§‹åŒ–åˆå¹¶ç­–ç•¥ï¼ˆä¿®å¤ï¼šæ·»åŠ  array_appendï¼‰
    INSERT INTO data.merge_strategies (strategy_name, description, implementation_function, is_builtin) VALUES 
    ('override', 'å®Œå…¨è¦†ç›–', 'override_merge', true),
    ('deep_merge', 'æ·±åº¦åˆå¹¶', 'deep_merge_impl', true),
    ('array_merge', 'æ•°ç»„åˆå¹¶', 'array_merge_impl', true),
    ('array_append', 'æ•°ç»„è¿½åŠ ', 'array_append_impl', true);
    
    -- åˆå§‹åŒ–é…ç½®ç±»å‹ï¼ˆä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„åˆå¹¶ç­–ç•¥åç§°ï¼‰
    INSERT INTO data.config_types (type_name, display_name, value_schema, default_value, merge_strategy, description, is_system_type) VALUES 
    ('test_rate_limits', 'æµ‹è¯•é€Ÿç‡é™åˆ¶', '{"type":"object"}', '{"rpm": 100, "tpm": 10000}', 'override', 'æµ‹è¯•é€Ÿç‡é™åˆ¶', false),
    ('test_model_access', 'æµ‹è¯•æ¨¡å‹æƒé™', '{"type":"object"}', '{"allowed_models": ["gpt-3.5-turbo"]}', 'array_append', 'æµ‹è¯•æ¨¡å‹æƒé™', false); -- æ”¹ä¸º array_append
    
    -- åˆå§‹åŒ–å¥—é¤
    INSERT INTO data.tier_definitions (tier_name, display_name, description, pricing_model, base_price, currency) VALUES 
    ('test_standard', 'æµ‹è¯•æ ‡å‡†ç‰ˆ', 'æµ‹è¯•åŸºç¡€å¥—é¤', 'monthly', 0.00, 'CNY'),
    ('test_premium', 'æµ‹è¯•ä¸“ä¸šç‰ˆ', 'æµ‹è¯•é«˜çº§å¥—é¤', 'monthly', 299.00, 'CNY');
    
    -- åˆå§‹åŒ–å¥—é¤ç‰¹æ€§
    INSERT INTO data.tier_feature_mappings (tier_name, config_type, feature_value) VALUES 
    ('test_premium', 'test_rate_limits', '{"rpm": 5000, "tpm": 500000}'),
    ('test_premium', 'test_model_access', '{"allowed_models": ["gpt-4", "claude-2"]}'),
    ('test_standard', 'test_rate_limits', '{"rpm": 1000, "tpm": 100000}');
    
    -- åˆå§‹åŒ–ç»§æ‰¿è§„åˆ™ï¼ˆä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„ç­–ç•¥åç§°ï¼‰
INSERT INTO data.inheritance_rules (parent_level, child_level, config_type, is_inheritance_enabled, custom_merge_strategy, condition_description) VALUES 
('test_global', 'test_tenant', 'test_rate_limits', true, 'override', 'æµ‹è¯•ç»§æ‰¿è§„åˆ™'),
('test_global', 'test_tenant', 'test_model_access', true, 'array_append', 'æµ‹è¯•ç»§æ‰¿è§„åˆ™'),
('test_tenant', 'test_user', 'test_rate_limits', true, 'override', 'æµ‹è¯•ç»§æ‰¿è§„åˆ™'),
('test_tenant', 'test_user', 'test_model_access', true, 'array_append', 'æµ‹è¯•ç»§æ‰¿è§„åˆ™'),  -- ğŸŸ¢ æ–°å¢è¿™æ¡
('test_user', 'test_virtual_key', 'test_rate_limits', true, 'override', 'æµ‹è¯•ç»§æ‰¿è§„åˆ™'),
('test_user', 'test_virtual_key', 'test_model_access', true, 'array_append', 'æµ‹è¯•ç»§æ‰¿è§„åˆ™');  -- ğŸŸ¢ æ–°å¢è¿™æ¡
    
    -- 2. è®¾ç½®æµ‹è¯•é…ç½®æ•°æ®
    RAISE NOTICE 'è®¾ç½®æµ‹è¯•é…ç½®...';
-- ğŸŸ¢ ç§»é™¤å…¨å±€é€Ÿç‡é™åˆ¶é…ç½®ï¼Œè®©å¥—é¤å›é€€èƒ½æ­£ç¡®è§¦å‘
-- åªä¿ç•™æ¨¡å‹æƒé™çš„å…¨å±€é…ç½®
INSERT INTO data.unified_config_store (config_type, level_name, scope_id, config_value) 
VALUES ('test_model_access', 'test_global', NULL, '{"allowed_models": ["gpt-3.5-turbo", "qwen-turbo"]}');

-- æ¨¡å‹æƒé™ä½¿ç”¨ NULL scope_idï¼ˆé»˜è®¤é…ç½®ï¼‰
INSERT INTO data.unified_config_store (config_type, level_name, scope_id, config_value) 
VALUES ('test_model_access', 'test_tenant', NULL, '{"allowed_models": ["claude-instant"]}');

INSERT INTO data.unified_config_store (config_type, level_name, scope_id, config_value) 
VALUES ('test_model_access', 'test_user', NULL, '{"allowed_models": ["user-model"]}');

-- é€Ÿç‡é™åˆ¶ä½¿ç”¨ç‰¹å®šé…ç½®ï¼ˆæœ‰å…·ä½“ scope_idï¼‰
INSERT INTO data.unified_config_store (config_type, level_name, scope_id, config_value) 
VALUES ('test_rate_limits', 'test_tenant', v_tenant_id, '{"rpm": 2500, "tpm": 250000}');

INSERT INTO data.unified_config_store (config_type, level_name, scope_id, config_value) 
VALUES ('test_rate_limits', 'test_user', v_user_id, '{"rpm": 3500, "tpm": 350000}');

INSERT INTO data.unified_config_store (config_type, level_name, scope_id, config_value) 
VALUES ('test_rate_limits', 'test_virtual_key', v_virtual_key_id, '{"rpm": 4000, "tpm": 400000}');

INSERT INTO data.unified_config_store (config_type, level_name, scope_id, config_value) 
VALUES ('test_model_access', 'test_virtual_key', v_virtual_key_id, '{"allowed_models": ["special-model"]}');
    
    -- 3. æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹
    RAISE NOTICE 'å¼€å§‹æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹...';
    
    -- æµ‹è¯•ç”¨ä¾‹ 1: è·å– Virtual Key çš„é€Ÿç‡é™åˆ¶ï¼ˆåº”è¯¥è¿”å› 4000ï¼‰
    test_name := 'Virtual Key é€Ÿç‡é™åˆ¶';
    config_type := 'test_rate_limits';
    target_level := 'test_virtual_key';
    scope_id := v_virtual_key_id;
    context := '{"tier_name": "test_standard"}'::JSONB;
    BEGIN
        RAISE NOTICE 'è°ƒç”¨ resolve_dynamic_config: config_type=%, target_level=%, scope_id=%', 
            config_type, target_level, scope_id;
        result := api.resolve_dynamic_config(config_type, target_level, scope_id, context);
        status := CASE WHEN (result->>'rpm')::INTEGER = 4000 THEN 'PASS' ELSE 'FAIL' END;
    EXCEPTION WHEN OTHERS THEN
        result := jsonb_build_object('error', SQLERRM);
        status := 'ERROR';
    END;
    RETURN NEXT;
    
    -- æµ‹è¯•ç”¨ä¾‹ 2: è·å– Virtual Key çš„æ¨¡å‹æƒé™ï¼ˆåº”è¯¥åˆå¹¶æ‰€æœ‰å±‚çº§çš„æ¨¡å‹ï¼‰
    test_name := 'Virtual Key æ¨¡å‹æƒé™åˆå¹¶';
    config_type := 'test_model_access';
    target_level := 'test_virtual_key';
    scope_id := v_virtual_key_id;
    context := '{"tier_name": "test_standard"}'::JSONB;
    BEGIN
        result := api.resolve_dynamic_config(config_type, target_level, scope_id, context); -- ä¿®å¤ï¼šç§»é™¤ level_name å‚æ•°
        status := CASE 
            WHEN result ? 'allowed_models' AND 
                 jsonb_array_length(result->'allowed_models') >= 4 THEN 'PASS' -- æœŸæœ›åˆå¹¶æ‰€æœ‰æ¨¡å‹
            ELSE 'FAIL' 
        END;
    EXCEPTION WHEN OTHERS THEN
        result := jsonb_build_object('error', SQLERRM);
        status := 'ERROR';
    END;
    RETURN NEXT;
    
    -- æµ‹è¯•ç”¨ä¾‹ 3: è·å–ç”¨æˆ·çº§é…ç½®ï¼ˆåº”è¯¥è¿”å› 3500ï¼Œè¦†ç›–ç§Ÿæˆ·é…ç½®ï¼‰
    test_name := 'ç”¨æˆ·çº§é…ç½®è¦†ç›–';
    config_type := 'test_rate_limits';
    target_level := 'test_user';
    scope_id := v_user_id;
    context := '{"tier_name": "test_standard"}'::JSONB;
    BEGIN
        result := api.resolve_dynamic_config(config_type, target_level, scope_id, context);
        status := CASE WHEN (result->>'rpm')::INTEGER = 3500 THEN 'PASS' ELSE 'FAIL' END;
    EXCEPTION WHEN OTHERS THEN
        result := jsonb_build_object('error', SQLERRM);
        status := 'ERROR';
    END;
    RETURN NEXT;

    -- åœ¨æµ‹è¯•ç”¨ä¾‹4ä¹‹å‰æ·»åŠ è¯¦ç»†è¯Šæ–­
    RAISE NOTICE '=== è¯¦ç»†è¯Šæ–­å¥—é¤é…ç½®é—®é¢˜ ===';
    
    -- è¯Šæ–­1ï¼šæ£€æŸ¥å¥—é¤é…ç½®æ˜¯å¦å­˜åœ¨
    SELECT COUNT(*) INTO v_count 
    FROM data.tier_feature_mappings tfm
    WHERE tfm.tier_name = 'test_premium' AND tfm.config_type = 'test_rate_limits';
    RAISE NOTICE '1. test_premiumå¥—é¤é…ç½®æ•°é‡: %', v_count;
    
    -- è¯Šæ–­2ï¼šæ£€æŸ¥å…·ä½“çš„å¥—é¤é…ç½®å€¼
    SELECT tfm.feature_value INTO result 
    FROM data.tier_feature_mappings tfm
    WHERE tfm.tier_name = 'test_premium' AND tfm.config_type = 'test_rate_limits';
    RAISE NOTICE '2. test_premiumå¥—é¤é…ç½®å€¼: %', result;
    
    -- è¯Šæ–­3ï¼šæ‰‹åŠ¨è°ƒç”¨å¥—é¤å‡½æ•°æµ‹è¯•
    result := api.get_tier_default_config('test_rate_limits', 'test_premium', '{"tier_name": "test_premium"}'::JSONB);
    RAISE NOTICE '3. æ‰‹åŠ¨è°ƒç”¨get_tier_default_configç»“æœ: %', result;
    
    -- è¯Šæ–­4ï¼šæ£€æŸ¥å…¨å±€é»˜è®¤å€¼
    SELECT ct.default_value INTO result FROM data.config_types ct WHERE ct.type_name = 'test_rate_limits';
    RAISE NOTICE '4. å…¨å±€é»˜è®¤å€¼: %', result;
    
    RAISE NOTICE '=== è¯Šæ–­ç»“æŸ ===';

    -- æµ‹è¯•ç”¨ä¾‹ 4: å¥—é¤é»˜è®¤é…ç½®ï¼ˆä½¿ç”¨ premium å¥—é¤ï¼‰
    test_name := 'å¥—é¤é»˜è®¤é…ç½®(premium)';
    config_type := 'test_rate_limits';
    target_level := 'test_virtual_key';
    scope_id := gen_random_uuid(); -- æ–°çš„ Virtual Keyï¼Œæ²¡æœ‰è‡ªå®šä¹‰é…ç½®
    context := '{"tier_name": "test_premium"}'::JSONB;
    BEGIN
        result := api.resolve_dynamic_config(config_type, target_level, scope_id, context);
        status := CASE WHEN (result->>'rpm')::INTEGER = 5000 THEN 'PASS' ELSE 'FAIL' END;
    EXCEPTION WHEN OTHERS THEN
        result := jsonb_build_object('error', SQLERRM);
        status := 'ERROR';
    END;
    RETURN NEXT;
    
    -- æµ‹è¯•ç”¨ä¾‹ 5: å¥—é¤é»˜è®¤é…ç½®ï¼ˆä½¿ç”¨ standard å¥—é¤ï¼‰
    test_name := 'å¥—é¤é»˜è®¤é…ç½®(standard)';
    config_type := 'test_rate_limits';
    target_level := 'test_virtual_key';
    scope_id := gen_random_uuid(); -- æ–°çš„ Virtual Keyï¼Œæ²¡æœ‰è‡ªå®šä¹‰é…ç½®
    context := '{"tier_name": "test_standard"}'::JSONB;
    BEGIN
        result := api.resolve_dynamic_config(config_type, target_level, scope_id, context);
        status := CASE WHEN (result->>'rpm')::INTEGER = 1000 THEN 'PASS' ELSE 'FAIL' END;
    EXCEPTION WHEN OTHERS THEN
        result := jsonb_build_object('error', SQLERRM);
        status := 'ERROR';
    END;
    RETURN NEXT;
    
    -- ğŸŸ¢ æ–°å¢æµ‹è¯•ç”¨ä¾‹ 6: çœŸæ­£çš„å…¨å±€é»˜è®¤é…ç½®ï¼ˆæ²¡æœ‰å¥—é¤ä¿¡æ¯ï¼‰
    test_name := 'çœŸæ­£çš„å…¨å±€é»˜è®¤é…ç½®';
    config_type := 'test_rate_limits';
    target_level := 'test_virtual_key';
    scope_id := gen_random_uuid(); -- æ–°çš„ Virtual Key
    context := '{}'::JSONB;  -- ğŸŸ¢ å…³é”®ï¼šæ²¡æœ‰å¥—é¤ä¿¡æ¯
    BEGIN
        result := api.resolve_dynamic_config(config_type, target_level, scope_id, context);
        status := CASE WHEN (result->>'rpm')::INTEGER = 100 THEN 'PASS' ELSE 'FAIL' END;  -- ğŸŸ¢ æœŸæœ›å…¨å±€é»˜è®¤å€¼ 100
    EXCEPTION WHEN OTHERS THEN
        result := jsonb_build_object('error', SQLERRM);
        status := 'ERROR';
    END;
    RETURN NEXT;
    
    RAISE NOTICE 'âœ… åŠ¨æ€é…ç½®ç³»ç»Ÿæµ‹è¯•å®Œæˆï¼';
    
    -- 4. æ¸…ç†æµ‹è¯•æ•°æ®
    RAISE NOTICE 'æ¸…ç†æµ‹è¯•æ•°æ®...';
    DELETE FROM data.unified_config_store WHERE level_name LIKE 'test_%';
    DELETE FROM data.tier_feature_mappings WHERE tier_name LIKE 'test_%';
    DELETE FROM data.tier_definitions WHERE tier_name LIKE 'test_%';
    DELETE FROM data.inheritance_rules WHERE condition_description LIKE '%æµ‹è¯•%';
    DELETE FROM data.config_types WHERE type_name LIKE 'test_%';
    DELETE FROM data.config_levels WHERE level_name LIKE 'test_%';
    
END;
$BODY$;
```

æ‰§è¡Œè¾“å‡º:

```
test_name	config_type	target_level	scope_id	context	result	status
Virtual Key é€Ÿç‡é™åˆ¶	test_rate_limits	test_virtual_key	9525330d-635f-46c0-a986-fa994e094a13	{"tier_name": "test_standard"}	{"rpm": 4000, "tpm": 400000}	PASS
Virtual Key æ¨¡å‹æƒé™åˆå¹¶	test_model_access	test_virtual_key	9525330d-635f-46c0-a986-fa994e094a13	{"tier_name": "test_standard"}	{"allowed_models": ["gpt-3.5-turbo", "qwen-turbo", "claude-instant", "user-model", "special-model"]}	PASS
ç”¨æˆ·çº§é…ç½®è¦†ç›–	test_rate_limits	test_user	5e5499ff-519e-4035-a757-4e209c0ac9fb	{"tier_name": "test_standard"}	{"rpm": 3500, "tpm": 350000}	PASS
å¥—é¤é»˜è®¤é…ç½®(premium)	test_rate_limits	test_virtual_key	7f5a2348-fde8-41d5-82c9-728badce5878	{"tier_name": "test_premium"}	{"rpm": 5000, "tpm": 500000}	PASS
å¥—é¤é»˜è®¤é…ç½®(standard)	test_rate_limits	test_virtual_key	fc841075-6ce0-4ef7-b005-eb0cf957086e	{"tier_name": "test_standard"}	{"rpm": 1000, "tpm": 100000}	PASS
çœŸæ­£çš„å…¨å±€é»˜è®¤é…ç½®	test_rate_limits	test_virtual_key	2d879e3a-8751-4473-b911-7d7513351f59	{}	{"rpm": 100, "tpm": 10000}	PASS
```

## é«˜çº§æµ‹è¯•

```postgresql
-- FUNCTION: api.test_advanced_config_system()

-- DROP FUNCTION IF EXISTS api.test_advanced_config_system();

CREATE OR REPLACE FUNCTION api.test_advanced_config_system(
	)
    RETURNS TABLE(test_category text, test_scenario text, config_type_name text, target_level text, expected_value jsonb, actual_value jsonb, status text) 
    LANGUAGE 'plpgsql'
    COST 100
    VOLATILE PARALLEL UNSAFE
    ROWS 1000

AS $BODY$
DECLARE
    v_tenant_id UUID := gen_random_uuid();
    v_project_id UUID := gen_random_uuid();
    v_app_id UUID := gen_random_uuid();
    v_virtual_key_id UUID := gen_random_uuid();
    v_new_virtual_key_id UUID := gen_random_uuid();  -- ğŸŸ¢ ä¸“é—¨ç”¨äºå¥—é¤æµ‹è¯•çš„æ–°å¯†é’¥
    
    v_result JSONB;
BEGIN
    -- æ¸…ç†æµ‹è¯•æ•°æ®
    PERFORM api.cleanup_test_data();
    
    -- åˆå§‹åŒ–æµ‹è¯•å±‚çº§ï¼ˆç¡®ä¿ç»§æ‰¿å…³ç³»æ­£ç¡®ï¼‰
    INSERT INTO data.config_levels (level_name, display_name, parent_level, inherit_priority) VALUES 
    ('test_platform', 'æµ‹è¯•å¹³å°', NULL, 1),
    ('test_tenant', 'æµ‹è¯•ç§Ÿæˆ·', 'test_platform', 2),
    ('test_project', 'æµ‹è¯•é¡¹ç›®', 'test_tenant', 3),
    ('test_app', 'æµ‹è¯•åº”ç”¨', 'test_project', 4),
    ('test_virtual_key', 'æµ‹è¯•å¯†é’¥', 'test_app', 5);
    
    -- åˆå§‹åŒ–é…ç½®ç±»å‹
    INSERT INTO data.config_types (type_name, display_name, value_schema, default_value, merge_strategy, description) VALUES 
    ('gateway_routing', 'è·¯ç”±é…ç½®', '{"type":"object"}', '{"timeout": 30}', 'deep_merge', 'ç½‘å…³è·¯ç”±é…ç½®'),
    ('rate_limits', 'é€Ÿç‡é™åˆ¶', '{"type":"object"}', '{"rpm": 100}', 'override', 'APIé™åˆ¶é…ç½®'),
    ('model_access', 'æ¨¡å‹æƒé™', '{"type":"object"}', '{"allowed_models": ["gpt-3.5-turbo"]}', 'array_append', 'æ¨¡å‹è®¿é—®æ§åˆ¶');
    
    -- åˆå§‹åŒ–ç»§æ‰¿è§„åˆ™ï¼ˆç¡®ä¿æ‰€æœ‰å±‚çº§é—´éƒ½æœ‰ç»§æ‰¿å…³ç³»ï¼‰
    INSERT INTO data.inheritance_rules (parent_level, child_level, config_type, is_inheritance_enabled, custom_merge_strategy) VALUES 
    ('test_platform', 'test_tenant', 'gateway_routing', true, 'deep_merge'),
    ('test_platform', 'test_tenant', 'rate_limits', true, 'override'),
    ('test_platform', 'test_tenant', 'model_access', true, 'array_append'),
    ('test_tenant', 'test_project', 'gateway_routing', true, 'deep_merge'),
    ('test_tenant', 'test_project', 'rate_limits', true, 'override'),
    ('test_tenant', 'test_project', 'model_access', true, 'array_append'),
    ('test_project', 'test_app', 'gateway_routing', true, 'deep_merge'),
    ('test_project', 'test_app', 'rate_limits', true, 'override'),
    ('test_project', 'test_app', 'model_access', true, 'array_append'),
    ('test_app', 'test_virtual_key', 'gateway_routing', true, 'deep_merge'),
    ('test_app', 'test_virtual_key', 'rate_limits', true, 'override'),
    ('test_app', 'test_virtual_key', 'model_access', true, 'array_append');
    
    RAISE NOTICE 'ğŸ¯ å¼€å§‹é«˜çº§é…ç½®ç³»ç»Ÿæµ‹è¯•...';
    
    -- ğŸ§ª æµ‹è¯•ç±»åˆ« 1: è·¯ç”±é…ç½®æµ‹è¯•
    test_category := 'è·¯ç”±é…ç½®';
    
    -- æµ‹è¯•åœºæ™¯ 1.1: åŸºç¡€è·¯ç”±ç»§æ‰¿
    test_scenario := 'åŸºç¡€è·¯ç”±é…ç½®ç»§æ‰¿';
    config_type_name := 'gateway_routing';
    target_level := 'test_virtual_key';
    
    -- è®¾ç½®æµ‹è¯•æ•°æ®ï¼šç¡®ä¿æ¯ä¸ªå±‚çº§éƒ½æœ‰é»˜è®¤é…ç½®
    INSERT INTO data.unified_config_store (config_type, level_name, scope_id, config_value) VALUES
    ('gateway_routing', 'test_platform', NULL, '{"timeout": 30, "retry_count": 3}'),
    ('gateway_routing', 'test_tenant', NULL, '{"timeout": 60}'),  -- é»˜è®¤é…ç½®
    ('gateway_routing', 'test_virtual_key', v_virtual_key_id, '{"provider": "openai"}');  -- ç‰¹å®šé…ç½®
    
    expected_value := '{"timeout": 60, "retry_count": 3, "provider": "openai"}';
    v_result := api.resolve_dynamic_config(config_type_name, target_level, v_virtual_key_id, '{}');
    actual_value := v_result;
    status := CASE WHEN v_result @> expected_value THEN 'PASS' ELSE 'FAIL' END;
    RETURN NEXT;
    
    -- ğŸ§ª æµ‹è¯•ç±»åˆ« 2: é€Ÿç‡é™åˆ¶æµ‹è¯•
    test_category := 'é€Ÿç‡é™åˆ¶';
    
    -- æµ‹è¯•åœºæ™¯ 2.1: é€Ÿç‡é™åˆ¶è¦†ç›–ï¼ˆè¿™ä¸ªåº”è¯¥é€šè¿‡ï¼‰
    test_scenario := 'é€Ÿç‡é™åˆ¶å®Œå…¨è¦†ç›–';
    config_type_name := 'rate_limits';
    
    INSERT INTO data.unified_config_store (config_type, level_name, scope_id, config_value) VALUES
    ('rate_limits', 'test_platform', NULL, '{"rpm": 100, "tpm": 10000}'),
    ('rate_limits', 'test_tenant', NULL, '{"rpm": 1000, "tpm": 100000}'),
    ('rate_limits', 'test_virtual_key', v_virtual_key_id, '{"rpm": 500}');
    
    expected_value := '{"rpm": 500}';
    v_result := api.resolve_dynamic_config(config_type_name, target_level, v_virtual_key_id, '{}');
    actual_value := v_result;
    status := CASE WHEN (v_result->>'rpm')::INTEGER = 500 THEN 'PASS' ELSE 'FAIL' END;
    RETURN NEXT;
    
    -- æµ‹è¯•åœºæ™¯ 2.2: å¥—é¤é»˜è®¤é€Ÿç‡ï¼ˆå…³é”®ä¿®å¤ï¼‰
    test_scenario := 'å¥—é¤é»˜è®¤é€Ÿç‡é™åˆ¶';
    config_type_name := 'rate_limits';
    
    -- è®¾ç½®å¥—é¤ç‰¹æ€§
    INSERT INTO data.tier_definitions (tier_name, display_name) VALUES 
    ('test_premium', 'æµ‹è¯•é«˜çº§ç‰ˆ');
    
    INSERT INTO data.tier_feature_mappings (tier_name, config_type, feature_value) VALUES
    ('test_premium', 'rate_limits', '{"rpm": 5000, "tpm": 500000}');
    
    -- ğŸŸ¢ å…³é”®ä¿®å¤ï¼šä½¿ç”¨å…¨æ–°çš„æµ‹è¯•ç¯å¢ƒï¼Œç¡®ä¿æ²¡æœ‰ä»»ä½•é…ç½®å­˜åœ¨
    -- ä¸æ’å…¥ä»»ä½• rate_limits é…ç½®æ•°æ®ï¼Œè®©ç³»ç»Ÿåªèƒ½å›é€€åˆ°å¥—é¤é…ç½®
    
    -- æµ‹è¯•æ–°å¯†é’¥ä½¿ç”¨å¥—é¤é»˜è®¤å€¼ï¼ˆç¡®ä¿æ²¡æœ‰ä»»ä½•é…ç½®ï¼‰
    v_result := api.resolve_dynamic_config(
        config_type_name, 
        'test_virtual_key', 
        v_new_virtual_key_id,  -- ğŸŸ¢ ä½¿ç”¨å…¨æ–°çš„å¯†é’¥IDï¼Œç¡®ä¿æ²¡æœ‰é…ç½®
        '{"tier_name": "test_premium"}'
    );
    
    expected_value := '{"rpm": 5000, "tpm": 500000}';
    actual_value := v_result;
    status := CASE 
        WHEN v_result @> '{"rpm": 5000}' AND v_result @> '{"tpm": 500000}' THEN 'PASS' 
        ELSE 'FAIL' 
    END;
    RETURN NEXT;
    
    -- ğŸ§ª æµ‹è¯•ç±»åˆ« 3: æ¨¡å‹æƒé™æµ‹è¯•ï¼ˆè¿™ä¸ªå·²ç»é€šè¿‡ï¼‰
    test_category := 'æ¨¡å‹æƒé™';
    
    -- æµ‹è¯•åœºæ™¯ 3.1: æ¨¡å‹æƒé™æ•°ç»„åˆå¹¶
    test_scenario := 'æ¨¡å‹æƒé™æ•°ç»„åˆå¹¶';
    config_type_name := 'model_access';
    
    INSERT INTO data.unified_config_store (config_type, level_name, scope_id, config_value) VALUES
    ('model_access', 'test_platform', NULL, '{"allowed_models": ["gpt-3.5-turbo"]}'),
    ('model_access', 'test_tenant', NULL, '{"allowed_models": ["gpt-4"]}'),
    ('model_access', 'test_project', NULL, '{"allowed_models": ["claude-2"]}'),
    ('model_access', 'test_virtual_key', v_virtual_key_id, '{"allowed_models": ["qwen-turbo"]}');
    
    v_result := api.resolve_dynamic_config(config_type_name, target_level, v_virtual_key_id, '{}');
    actual_value := v_result->'allowed_models';
    
    -- æ£€æŸ¥æ˜¯å¦åŒ…å«æ‰€æœ‰æ¨¡å‹ï¼ˆarray_append åº”è¯¥åˆå¹¶æ‰€æœ‰æ•°ç»„ï¼‰
    status := CASE 
        WHEN v_result ? 'allowed_models' AND 
             jsonb_array_length(v_result->'allowed_models') >= 4 THEN 'PASS' 
        ELSE 'FAIL' 
    END;
    RETURN NEXT;
    
    RAISE NOTICE 'âœ… é«˜çº§é…ç½®ç³»ç»Ÿæµ‹è¯•å®Œæˆï¼';
    
    -- æ¸…ç†æµ‹è¯•æ•°æ®
    PERFORM api.cleanup_test_data();
    
END;
$BODY$;

ALTER FUNCTION api.test_advanced_config_system()
    OWNER TO geohuz;


```

æ‰§è¡Œè¾“å‡º:
```
test_category	test_scenario	config_type_name	target_level	expected_value	actual_value	status
è·¯ç”±é…ç½®	åŸºç¡€è·¯ç”±é…ç½®ç»§æ‰¿	gateway_routing	test_virtual_key	{"timeout": 60, "provider": "openai", "retry_count": 3}	{"timeout": 60, "provider": "openai", "retry_count": 3}	PASS
é€Ÿç‡é™åˆ¶	é€Ÿç‡é™åˆ¶å®Œå…¨è¦†ç›–	rate_limits	test_virtual_key	{"rpm": 500}	{"rpm": 500}	PASS
é€Ÿç‡é™åˆ¶	å¥—é¤é»˜è®¤é€Ÿç‡é™åˆ¶	rate_limits	test_virtual_key	{"rpm": 5000, "tpm": 500000}	{"rpm": 5000, "tpm": 500000}	PASS
æ¨¡å‹æƒé™	æ¨¡å‹æƒé™æ•°ç»„åˆå¹¶	model_access	test_virtual_key	{"rpm": 5000, "tpm": 500000}	["gpt-3.5-turbo", "gpt-4", "claude-2", "qwen-turbo"]	PASS
```

## å®Œæ•´æµ‹è¯•

```postgresql
CREATE OR REPLACE FUNCTION api.test_complete_config_system(
	)
    RETURNS TABLE(test_category text, test_scenario text, config_type_name text, expected_value jsonb, actual_value jsonb, status text) 
    LANGUAGE 'plpgsql'
    COST 100
    VOLATILE PARALLEL UNSAFE
    ROWS 1000

AS $BODY$
DECLARE
    -- æµ‹è¯•æ•°æ®ID
    v_platform_id TEXT := 'test-platform';
    v_org_id UUID := gen_random_uuid();
    v_project_id UUID := gen_random_uuid();
    v_env_id UUID := gen_random_uuid();
    v_virtual_key_id UUID := gen_random_uuid();
    v_new_virtual_key_id UUID := gen_random_uuid();
    
    v_result JSONB;
BEGIN
    -- æ¸…ç†æµ‹è¯•æ•°æ® - æ›´å½»åº•çš„æ¸…ç†
    PERFORM api.cleanup_test_data();
    
    -- ğŸŸ¢ å…ˆåˆ é™¤å¯èƒ½å­˜åœ¨çš„æµ‹è¯•é…ç½®ç±»å‹
    DELETE FROM data.config_types WHERE type_name LIKE 'test_%';
    DELETE FROM data.config_levels WHERE level_name LIKE 'test_%';
    DELETE FROM data.tier_definitions WHERE tier_name LIKE 'test_%';
    
    -- ğŸŸ¢ åˆå§‹åŒ–è‡ªå®šä¹‰å±‚çº§
    INSERT INTO data.config_levels (level_name, display_name, parent_level, inherit_priority) VALUES 
    ('test_platform_2', 'æµ‹è¯•å¹³å°', NULL, 1),
    ('test_org_2', 'æµ‹è¯•ç»„ç»‡', 'test_platform_2', 2),
    ('test_project_2', 'æµ‹è¯•é¡¹ç›®', 'test_org_2', 3),
    ('test_env_2', 'æµ‹è¯•ç¯å¢ƒ', 'test_project_2', 4),
    ('test_virtual_key_2', 'æµ‹è¯•å¯†é’¥', 'test_env_2', 5);
    
    -- ğŸŸ¢ ä½¿ç”¨å”¯ä¸€çš„é…ç½®ç±»å‹åç§°
    INSERT INTO data.config_types (type_name, display_name, value_schema, default_value, merge_strategy, description, supports_tier_entitlements) VALUES 
    ('test_rate_limits_2', 'æµ‹è¯•é€Ÿç‡é™åˆ¶', '{"type":"object"}', '{"rpm": 100}', 'override', 'æµ‹è¯•é€Ÿç‡é™åˆ¶', true),
    ('test_model_access_2', 'æµ‹è¯•æ¨¡å‹æƒé™', '{"type":"object"}', '{"allowed_models": ["gpt-3.5"]}', 'array_append', 'æµ‹è¯•æ¨¡å‹æƒé™', true),
    ('test_monitoring_2', 'æµ‹è¯•ç›‘æ§å‘Šè­¦', '{"type":"object"}', '{"enabled": false}', 'override', 'æµ‹è¯•ç›‘æ§å‘Šè­¦', false);
    
    -- ğŸŸ¢ åˆå§‹åŒ–ç»§æ‰¿è§„åˆ™
    INSERT INTO data.inheritance_rules (parent_level, child_level, config_type, is_inheritance_enabled, custom_merge_strategy) 
    SELECT parent, child, config_type, true, 'override'
    FROM (VALUES 
        ('test_platform_2', 'test_org_2'),
        ('test_org_2', 'test_project_2'),
        ('test_project_2', 'test_env_2'),
        ('test_env_2', 'test_virtual_key_2')
    ) AS levels(parent, child)
    CROSS JOIN (VALUES ('test_rate_limits_2'), ('test_model_access_2'), ('test_monitoring_2')) AS configs(config_type);
    
    -- ğŸŸ¢ åˆå§‹åŒ–å¥—é¤ç³»ç»Ÿ
    INSERT INTO data.tier_definitions (tier_name, display_name) VALUES 
    ('test_basic_2', 'æµ‹è¯•åŸºç¡€ç‰ˆ'),
    ('test_pro_2', 'æµ‹è¯•ä¸“ä¸šç‰ˆ');
    
    -- ğŸŸ¢ åˆå§‹åŒ–å¥—é¤ç‰¹æ€§
    INSERT INTO data.tier_feature_mappings (tier_name, config_type, feature_value, condition_expression) VALUES 
    -- åŸºç¡€ç‰ˆå¥—é¤
    ('test_basic_2', 'test_rate_limits_2', '{"rpm": 1000}', NULL),
    ('test_basic_2', 'test_model_access_2', '{"allowed_models": ["gpt-4"]}', NULL),
    
    -- ä¸“ä¸šç‰ˆå¥—é¤
    ('test_pro_2', 'test_rate_limits_2', '{"rpm": 5000}', NULL),
    ('test_pro_2', 'test_rate_limits_2', '{"rpm": 10000}', '{"field": "region", "operator": "in", "value": ["beijing", "shanghai"]}'),
    ('test_pro_2', 'test_model_access_2', '{"allowed_models": ["claude-2"]}', NULL),
    ('test_pro_2', 'test_model_access_2', '{"allowed_models": ["qwen-turbo"]}', '{"field": "user_type", "operator": "equals", "value": "vip"}');
    
    RAISE NOTICE 'ğŸ¯ å¼€å§‹å®Œæ•´é…ç½®ç³»ç»Ÿæµ‹è¯•...';
    
    -- ğŸ§ª æµ‹è¯•ç±»åˆ« 1: åŸºç¡€åŠŸèƒ½æµ‹è¯•
    test_category := 'åŸºç¡€åŠŸèƒ½';
    
    -- æµ‹è¯•åœºæ™¯ 1.1: é»˜è®¤é…ç½®ç»§æ‰¿
    test_scenario := 'é»˜è®¤é…ç½®ç»§æ‰¿';
    config_type_name := 'test_rate_limits_2';
    
    INSERT INTO data.unified_config_store (config_type, level_name, scope_id, config_value) VALUES
    ('test_rate_limits_2', 'test_platform_2', NULL, '{"rpm": 500}'),
    ('test_rate_limits_2', 'test_org_2', NULL, '{"rpm": 1000}');
    
    expected_value := '{"rpm": 1000}';
    v_result := api.resolve_dynamic_config(config_type_name, 'test_virtual_key_2', v_virtual_key_id, '{}');
    actual_value := v_result;
    status := CASE WHEN (v_result->>'rpm')::INTEGER = 1000 THEN 'PASS' ELSE 'FAIL' END;
    RETURN NEXT;
    
    -- ğŸ§ª æµ‹è¯•ç±»åˆ« 2: å¥—é¤åŠŸèƒ½æµ‹è¯•
    test_category := 'å¥—é¤åŠŸèƒ½';
    
    -- æµ‹è¯•åœºæ™¯ 2.1: åŸºç¡€å¥—é¤åº”ç”¨
    test_scenario := 'åŸºç¡€å¥—é¤åº”ç”¨';
    expected_value := '{"rpm": 1000}';
    v_result := api.resolve_dynamic_config('test_rate_limits_2', 'test_virtual_key_2', v_new_virtual_key_id, '{"tier_name": "test_basic_2"}');
    actual_value := v_result;
    status := CASE WHEN (v_result->>'rpm')::INTEGER = 1000 THEN 'PASS' ELSE 'FAIL' END;
    RETURN NEXT;
    
    -- æµ‹è¯•åœºæ™¯ 2.2: ä¸“ä¸šå¥—é¤æ— æ¡ä»¶é»˜è®¤
    test_scenario := 'ä¸“ä¸šå¥—é¤æ— æ¡ä»¶é»˜è®¤';
    expected_value := '{"rpm": 5000}';
    v_result := api.resolve_dynamic_config('test_rate_limits_2', 'test_virtual_key_2', v_new_virtual_key_id, '{"tier_name": "test_pro_2"}');
    actual_value := v_result;
    status := CASE WHEN (v_result->>'rpm')::INTEGER = 5000 THEN 'PASS' ELSE 'FAIL' END;
    RETURN NEXT;
    
    -- æµ‹è¯•åœºæ™¯ 2.3: ä¸“ä¸šå¥—é¤æ¡ä»¶é…ç½®
    test_scenario := 'ä¸“ä¸šå¥—é¤æ¡ä»¶é…ç½®';
    expected_value := '{"rpm": 10000}';
    v_result := api.resolve_dynamic_config('test_rate_limits_2', 'test_virtual_key_2', v_new_virtual_key_id, '{"tier_name": "test_pro_2", "region": "beijing"}');
    actual_value := v_result;
    status := CASE WHEN (v_result->>'rpm')::INTEGER = 10000 THEN 'PASS' ELSE 'FAIL' END;
    RETURN NEXT;
    
    -- æµ‹è¯•åœºæ™¯ 2.4: æ¨¡å‹æƒé™åˆå¹¶
    test_scenario := 'æ¨¡å‹æƒé™åˆå¹¶';
    v_result := api.resolve_dynamic_config('test_model_access_2', 'test_virtual_key_2', v_new_virtual_key_id, '{"tier_name": "test_pro_2", "user_type": "vip"}');
    actual_value := v_result->'allowed_models';
    status := CASE 
        WHEN v_result ? 'allowed_models' AND 
             jsonb_array_length(v_result->'allowed_models') >= 2 THEN 'PASS' 
        ELSE 'FAIL' 
    END;
    RETURN NEXT;
    
    -- ğŸ§ª æµ‹è¯•ç±»åˆ« 3: å¥—é¤æ”¯æŒæ€§æ§åˆ¶æµ‹è¯•
    test_category := 'å¥—é¤æ”¯æŒæ€§æ§åˆ¶';
    
    -- æµ‹è¯•åœºæ™¯ 3.1: ä¸æ”¯æŒå¥—é¤çš„é…ç½®ç±»å‹
    test_scenario := 'ä¸æ”¯æŒå¥—é¤çš„é…ç½®';
    INSERT INTO data.unified_config_store (config_type, level_name, scope_id, config_value) VALUES
    ('test_monitoring_2', 'test_platform_2', NULL, '{"enabled": true}');
    
    expected_value := '{"enabled": true}';
    v_result := api.resolve_dynamic_config('test_monitoring_2', 'test_virtual_key_2', v_new_virtual_key_id, '{"tier_name": "test_pro_2"}');
    actual_value := v_result;
    status := CASE WHEN v_result->>'enabled' = 'true' THEN 'PASS' ELSE 'FAIL' END;
    RETURN NEXT;
    
    RAISE NOTICE 'âœ… å®Œæ•´é…ç½®ç³»ç»Ÿæµ‹è¯•å®Œæˆï¼';
    
    -- æ¸…ç†æµ‹è¯•æ•°æ®
 -- åœ¨æµ‹è¯•å‡½æ•°æœ€åï¼ŒæŒ‰è¿™ä¸ªé¡ºåºæ¸…ç†ï¼š
DELETE FROM data.unified_config_store WHERE config_type LIKE 'test_%_2';
DELETE FROM data.tier_feature_mappings WHERE tier_name LIKE 'test_%_2' OR config_type LIKE 'test_%_2';
DELETE FROM data.inheritance_rules WHERE config_type LIKE 'test_%_2';
DELETE FROM data.config_types WHERE type_name LIKE 'test_%_2';
DELETE FROM data.config_levels WHERE level_name LIKE 'test_%_2'; 
DELETE FROM data.tier_definitions WHERE tier_name LIKE 'test_%_2';

END;
```

æ‰§è¡Œè¾“å‡º:

```
test_category	test_scenario	config_type_name	expected_value	actual_value	status
åŸºç¡€åŠŸèƒ½	é»˜è®¤é…ç½®ç»§æ‰¿	test_rate_limits_2	{"rpm": 1000}	{"rpm": 1000}	PASS
å¥—é¤åŠŸèƒ½	åŸºç¡€å¥—é¤åº”ç”¨	test_rate_limits_2	{"rpm": 1000}	{"rpm": 1000}	PASS
å¥—é¤åŠŸèƒ½	ä¸“ä¸šå¥—é¤æ— æ¡ä»¶é»˜è®¤	test_rate_limits_2	{"rpm": 5000}	{"rpm": 5000}	PASS
å¥—é¤åŠŸèƒ½	ä¸“ä¸šå¥—é¤æ¡ä»¶é…ç½®	test_rate_limits_2	{"rpm": 10000}	{"rpm": 10000}	PASS
å¥—é¤åŠŸèƒ½	æ¨¡å‹æƒé™åˆå¹¶	test_rate_limits_2	{"rpm": 10000}	["qwen-turbo"]	FAIL
å¥—é¤æ”¯æŒæ€§æ§åˆ¶	ä¸æ”¯æŒå¥—é¤çš„é…ç½®	test_rate_limits_2	{"enabled": true}	{"enabled": true}	PASS
```

# **ç°åœ¨å¯ä»¥åšåˆ°ï¼š**

```postgresql
-- 1. åŠ¨æ€æ·»åŠ å±‚çº§
INSERT INTO data.config_levels VALUES 
('region', 'åŒºåŸŸé…ç½®', 'tenant', 2, 'åŒºåŸŸçº§åˆ«é…ç½®', false);

-- 2. åŠ¨æ€æ·»åŠ é…ç½®ç±»å‹
INSERT INTO data.config_types VALUES
('regional_routing', 'åŒºåŸŸè·¯ç”±', '{"type":"object"}', '{}', 'deep_merge', 'åŒºåŸŸè·¯ç”±ç­–ç•¥', false);

-- 3. åŠ¨æ€è®¾ç½®ç»§æ‰¿è§„åˆ™
INSERT INTO data.inheritance_rules VALUES 
(gen_random_uuid(), 'tenant', 'region', 'regional_routing', true, 'deep_merge', 'child_wins', 
 '{"condition": {"has_region": true}}', 'æœ‰åŒºåŸŸçš„ç§Ÿæˆ·æ‰ç»§æ‰¿');

-- 4. åŠ¨æ€åˆ›å»ºå¥—é¤
INSERT INTO data.tier_definitions VALUES
('startup', 'åˆ›ä¸šç‰ˆ', 99.00, 'é€‚åˆåˆ›ä¸šå…¬å¸', 'monthly', 'CNY', true, true, 2);

-- 5. æ‰€æœ‰æ”¹åŠ¨ç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€ä¿®æ”¹ä»£ç ï¼
```

# è®¾è®¡å“²å­¦

1. **âœ… å®Œå…¨å…ƒæ•°æ®é©±åŠ¨** - ç³»ç»Ÿè¡Œä¸ºç”±æ•°æ®å®šä¹‰ï¼Œä¸æ˜¯ä»£ç 
2. **âœ… è¿è¡Œæ—¶å¯é…ç½®** - æ‰€æœ‰è§„åˆ™å¯åœ¨ä¸é‡å¯çš„æƒ…å†µä¸‹ä¿®æ”¹
3. **âœ… æ— é™æ‰©å±•æ€§** - æ–°çš„å±‚çº§ã€ç±»å‹ã€ç­–ç•¥éƒ½å¯åŠ¨æ€æ·»åŠ 
4. **âœ… ä¸Šä¸‹æ–‡æ„ŸçŸ¥** - é…ç½®è§£æè€ƒè™‘å®Œæ•´çš„ä¸šåŠ¡ä¸Šä¸‹æ–‡

# é…ç½®è§£ææµç¨‹

å½“è°ƒç”¨ `resolve_dynamic_config` æ—¶ï¼Œç³»ç»Ÿä¼šï¼š

1. **æ„å»ºç»§æ‰¿é“¾**ï¼š`virtual_key` â†’ `user` â†’ `tenant` â†’ `global`
2. **æŒ‰ä¼˜å…ˆçº§æŸ¥è¯¢**ï¼šä»ä½åˆ°é«˜æŸ¥è¯¢æ¯ä¸ªå±‚çº§çš„é…ç½®
3. **åŠ¨æ€åˆå¹¶**ï¼šæ ¹æ®ç»§æ‰¿è§„åˆ™å’Œåˆå¹¶ç­–ç•¥åˆå¹¶é…ç½®
4. **åº”ç”¨å¥—é¤**ï¼šå¦‚æœåŸºç¡€é…ç½®ä¸ºç©ºï¼Œåº”ç”¨å¥—é¤é»˜è®¤å€¼
5. **è¿”å›ç»“æœ**ï¼šæœ€ç»ˆåˆå¹¶åçš„é…ç½®

è¿™ä¸ªä¿®å¤æ›´å¥½åœ°å®ç°äº†ç³»ç»Ÿçš„è®¾è®¡æ„å›¾ï¼š

- **é»˜è®¤é…ç½®**ï¼ˆscope_id = NULLï¼‰ï¼šç”¨äºç»§æ‰¿ï¼Œæ‰€æœ‰è¯¥å±‚çº§çš„å®ä½“å…±äº«
- **ç‰¹å®šé…ç½®**ï¼ˆscope_id = å…·ä½“å€¼ï¼‰ï¼šè¦†ç›–é»˜è®¤é…ç½®ï¼Œåªå½±å“ç‰¹å®šå®ä½“
- **ç»§æ‰¿æœºåˆ¶**ï¼šæŸ¥æ‰¾çˆ¶çº§çš„é»˜è®¤é…ç½®ï¼ˆä¸æ˜¯ç‰¹å®šå®ä½“çš„é…ç½®ï¼‰

è¿™æ ·æ—¢ä¿æŒäº†çµæ´»æ€§ï¼Œåˆç¡®ä¿äº†ç»§æ‰¿æœºåˆ¶çš„æ­£ç¡®æ€§ï¼

### å±‚çº§å…³ç³»çº¦æŸï¼š

1. **å…¨å±€é…ç½®** (`unified_config_store` ä¸­çš„å…¨å±€è®°å½•) â†’ å‚ä¸æ­£å¸¸ç»§æ‰¿
2. **å¥—é¤é…ç½®** â†’ å½“æ²¡æœ‰æ‰¾åˆ°ä»»ä½•é…ç½®æ—¶ä½¿ç”¨
3. **å…¨å±€é»˜è®¤å€¼** (`config_types.default_value`) â†’ æœ€ç»ˆå›é€€

# å…¨å±€é…ç½®æ— å®ä½“çº¦æŸ

**æ ¸å¿ƒå«ä¹‰**ï¼š

- ğŸ¯ **æ ¹å±‚çº§é…ç½®å¿…é¡»é¢å‘å…¨ä½“**ï¼Œä¸èƒ½é’ˆå¯¹ç‰¹å®šå®ä½“
- ğŸ”’ **å…¨å±€é…ç½®çš„ scope_id å¿…é¡»ä¸º NULL**ï¼Œç¡®ä¿é…ç½®çš„å…¨å±€æ€§
- ğŸš« **é˜²æ­¢å…¨å±€é…ç½®æ„å¤–ç»‘å®šåˆ°å…·ä½“å®¢æˆ·/åº”ç”¨**

**ä¸€å¥è¯è§£é‡Š**ï¼š

> "å¹³å°çº§é…ç½®å¿…é¡»æƒ åŠæ‰€æœ‰ç”¨æˆ·ï¼Œä¸èƒ½å·å·ç»™æŸä¸ªå®¢æˆ·å¼€å°ç¶"

**ä¸šåŠ¡æ„ä¹‰**ï¼š

- ç¡®ä¿å…¬å¹³æ€§ï¼šå¹³å°è§„åˆ™å¯¹æ‰€æœ‰äººä¸€è‡´
- é˜²æ­¢é…ç½®é”™è¯¯ï¼šé¿å…å…¨å±€é…ç½®è¯¯å†™æˆç‰¹å®šé…ç½®
- ç»´æŠ¤ç³»ç»Ÿçº¯æ´æ€§ï¼šä¿æŒå…¨å±€å±‚çº§çš„"ä¸Šå¸è§†è§’"ç‰¹æ€§

## å®Œæ•´çš„çº¦æŸå®ç°

```postgresql
-- 1. åˆ é™¤æ—§çš„ç¡¬ç¼–ç çº¦æŸï¼ˆå¦‚æœå­˜åœ¨ï¼‰
ALTER TABLE data.unified_config_store DROP CONSTRAINT IF EXISTS scope_constraint;

-- 2. åˆ›å»ºåŠ¨æ€çº¦æŸå‡½æ•°
CREATE OR REPLACE FUNCTION data.check_scope_constraint()
RETURNS TRIGGER AS $$
BEGIN
    -- æŸ¥è¯¢å±‚çº§å®šä¹‰ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºæ ¹å±‚çº§ï¼ˆå…¨å±€å±‚çº§ï¼‰
    IF EXISTS (
        SELECT 1 FROM data.config_levels 
        WHERE level_name = NEW.level_name 
        AND parent_level IS NULL  -- æ ¹å±‚çº§çš„ç‰¹å¾ï¼šæ²¡æœ‰çˆ¶çº§
    ) THEN
        -- æ ¹å±‚çº§ï¼šscope_id å¿…é¡»ä¸º NULLï¼ˆå…¨å±€é…ç½®æ²¡æœ‰å…·ä½“å¯¹è±¡ï¼‰
        IF NEW.scope_id IS NOT NULL THEN
            RAISE EXCEPTION 'æ ¹å±‚çº§ "%" çš„ scope_id å¿…é¡»ä¸º NULLï¼Œå› ä¸ºè¿™æ˜¯å…¨å±€é…ç½®', NEW.level_name;
        END IF;
    ELSE
        -- éæ ¹å±‚çº§ï¼šscope_id å¯ä»¥ä¸º NULLï¼ˆé»˜è®¤é…ç½®ï¼‰æˆ–å…·ä½“å€¼ï¼ˆç‰¹å®šå®ä½“é…ç½®ï¼‰
        -- ä¸è¿›è¡Œé™åˆ¶ï¼Œå…è®¸ä¸¤ç§æ–¹å¼
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 3. åˆ›å»ºè§¦å‘å™¨
DROP TRIGGER IF EXISTS check_scope_trigger ON data.unified_config_store;
CREATE TRIGGER check_scope_trigger
    BEFORE INSERT OR UPDATE ON data.unified_config_store
    FOR EACH ROW EXECUTE FUNCTION data.check_scope_constraint();
```

## çº¦æŸè§„åˆ™è¯´æ˜

### å…è®¸çš„é…ç½®æƒ…å†µï¼š

| å±‚çº§ç±»å‹ | level_name ç¤ºä¾‹ | scope_id å…è®¸å€¼ | é…ç½®å«ä¹‰                     |
| :------- | :-------------- | :-------------- | :--------------------------- |
| æ ¹å±‚çº§   | `platform`      | å¿…é¡» `NULL`     | å¹³å°å…¨å±€é»˜è®¤é…ç½®             |
| æ ¹å±‚çº§   | `global`        | å¿…é¡» `NULL`     | å…¨å±€é»˜è®¤é…ç½®                 |
| éæ ¹å±‚çº§ | `tenant`        | `NULL`          | ç§Ÿæˆ·é»˜è®¤é…ç½®ï¼ˆæ‰€æœ‰ç§Ÿæˆ·å…±äº«ï¼‰ |
| éæ ¹å±‚çº§ | `tenant`        | `'company-abc'` | ç‰¹å®šç§Ÿæˆ·é…ç½®                 |
| éæ ¹å±‚çº§ | `app`           | `NULL`          | åº”ç”¨é»˜è®¤é…ç½®                 |
| éæ ¹å±‚çº§ | `app`           | `'app-123'`     | ç‰¹å®šåº”ç”¨é…ç½®                 |

## é…ç½®ç±»å‹æ€»è§ˆ

| é…ç½®ç±»å‹           | ä¸šåŠ¡ç”¨é€” | æŠ€æœ¯æ§åˆ¶ç‚¹      | é…ç½®å±‚çº§ | åˆå¹¶ç­–ç•¥       |
| :----------------- | :------- | :-------------- | :------- | :------------- |
| `gateway_routing`  | è·¯ç”±ç­–ç•¥ | Portkey Gateway | æ‰€æœ‰å±‚çº§ | `deep_merge`   |
| `rate_limits`      | æµé‡æ§åˆ¶ | API Gateway     | æ‰€æœ‰å±‚çº§ | `override`     |
| `model_access`     | æ¨¡å‹æƒé™ | ä¸šåŠ¡é€»è¾‘        | æ‰€æœ‰å±‚çº§ | `array_append` |
| `billing_rules`    | è®¡è´¹ç­–ç•¥ | è®¡è´¹æœåŠ¡        | tenant+  | `override`     |
| `security_policy`  | å®‰å…¨ç­–ç•¥ | ç½‘å…³+ä¸šåŠ¡       | æ‰€æœ‰å±‚çº§ | `deep_merge`   |
| `content_filters`  | å†…å®¹è¿‡æ»¤ | é¢„å¤„ç†å±‚        | æ‰€æœ‰å±‚çº§ | `deep_merge`   |
| `cache_strategy`   | ç¼“å­˜ç­–ç•¥ | Portkey Gateway | æ‰€æœ‰å±‚çº§ | `override`     |
| `monitoring_alert` | ç›‘æ§å‘Šè­¦ | ç›‘æ§ç³»ç»Ÿ        | platform | `override`     |

# é…ç½®çš„resolver æœºåˆ¶

# `resolve_dynamic_config` é…ç½®è§£ææµç¨‹å›¾

```mermaid
graph TD
    A[å¼€å§‹è§£æé…ç½®] --> B{æ˜¯å¦æœ‰å¥—é¤ä¿¡æ¯?}
    
    B -->|æ˜¯| C[è·å–å¥—é¤é…ç½®]
    B -->|å¦| D[å¥—é¤é…ç½® = NULL]
    
    C --> E[æ„å»ºç»§æ‰¿è·¯å¾„]
    D --> E
    
    E --> F[æŒ‰ç»§æ‰¿è·¯å¾„åˆå¹¶é…ç½®]
    F --> G{æ˜¯å¦æœ‰ç‰¹å®šé…ç½®?}
    
    G -->|æ˜¯| H[ä¿æŒç‰¹å®šé…ç½®ç»“æœ]
    G -->|å¦| I{æ˜¯å¦æœ‰å¥—é¤é…ç½®?}
    
    I -->|æ˜¯| J[ä½¿ç”¨å¥—é¤é…ç½®è¦†ç›–é»˜è®¤é…ç½®]
    I -->|å¦| K[ä¿æŒé»˜è®¤é…ç½®ç»“æœ]
    
    H --> L{æ˜¯å¦æœ‰é…ç½®ç»“æœ?}
    J --> L
    K --> L
    
    L -->|æ˜¯| M[è¿”å›é…ç½®ç»“æœ]
    L -->|å¦| N[ä½¿ç”¨å…¨å±€é»˜è®¤å€¼]
    
    N --> M
```

## è¯¦ç»†æ­¥éª¤è¯´æ˜

### 1. ğŸ¯ å¥—é¤é…ç½®è·å–
```
IF contextæœ‰tier_name THEN
    v_tier_config = get_tier_default_config()
ELSE
    v_tier_config = NULL
```

### 2. ğŸ›£ï¸ ç»§æ‰¿è·¯å¾„æ„å»º
```
WITH RECURSIVE ä»ç›®æ ‡å±‚çº§å‘ä¸ŠæŸ¥æ‰¾çˆ¶çº§
æ„å»ºè·¯å¾„: root â†’ parent â†’ ... â†’ target_level
ç¡®ä¿ç»§æ‰¿è§„åˆ™æœ‰æ•ˆä¸”æ— å¾ªç¯
```

### 3. ğŸ”„ é…ç½®åˆå¹¶æµç¨‹
```
FOR æ¯ä¸ªå±‚çº§ IN ç»§æ‰¿è·¯å¾„:
    IF å½“å‰å±‚çº§ = ç›®æ ‡å±‚çº§ THEN
        æŸ¥è¯¢ç‰¹å®šé…ç½®(scope_id = å…·ä½“å€¼)
    ELSE
        æŸ¥è¯¢é»˜è®¤é…ç½®(scope_id = NULL)
    
    IF æ‰¾åˆ°é…ç½® THEN
        IF æ˜¯ç¬¬ä¸€ä¸ªé…ç½® THEN
            v_result = å½“å‰é…ç½®
        ELSE
            v_result = åˆå¹¶(v_result, å½“å‰é…ç½®)
```

### 4. ğŸ° æ™ºèƒ½å¥—é¤åº”ç”¨
```
IF æœ‰å¥—é¤é…ç½® THEN
    CASE:
        æƒ…å†µ1: æ— ä»»ä½•é…ç½® â†’ ç›´æ¥ä½¿ç”¨å¥—é¤
        æƒ…å†µ2: åªæœ‰é»˜è®¤é…ç½® â†’ å¥—é¤è¦†ç›–é»˜è®¤é…ç½®
        æƒ…å†µ3: æœ‰ç‰¹å®šé…ç½® â†’ ä¿æŒç‰¹å®šé…ç½®ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
```

### 5. ğŸŒ æœ€ç»ˆå›é€€
```
IF ä»ç„¶æ²¡æœ‰é…ç½® THEN
    ä½¿ç”¨config_typesè¡¨ä¸­çš„å…¨å±€é»˜è®¤å€¼
```

## ä¼˜å…ˆçº§è§„åˆ™

| ä¼˜å…ˆçº§     | é…ç½®ç±»å‹ | è¯´æ˜                     |
| ---------- | -------- | ------------------------ |
| ğŸ¥‡ **æœ€é«˜** | ç‰¹å®šé…ç½® | ç”¨æˆ·æ˜ç¡®ä¸ºå®ä½“è®¾ç½®çš„é…ç½® |
| ğŸ¥ˆ **ä¸­ç­‰** | å¥—é¤é…ç½® | ç”¨æˆ·è´­ä¹°çš„å¥—é¤æƒç›Š       |
| ğŸ¥‰ **æœ€ä½** | é»˜è®¤é…ç½® | ç³»ç»Ÿé¢„è®¾çš„å±‚çº§é»˜è®¤å€¼     |
| ğŸ”„ **ä¿åº•** | å…¨å±€é»˜è®¤ | é…ç½®ç±»å‹çš„åŸºç¡€é»˜è®¤å€¼     |

## ä¸šåŠ¡é€»è¾‘ç¤ºä¾‹

**åœºæ™¯**: ç”¨æˆ·è´­ä¹°äº†"ç™½é‡‘ä¼šå‘˜"ï¼Œåœ¨åŒ—äº¬åŒºåŸŸä½¿ç”¨

```
1. è·å–å¥—é¤: {"rpm": 5000} (ç™½é‡‘ä¼šå‘˜æƒç›Š)
2. ç»§æ‰¿è·¯å¾„: global â†’ tenant â†’ user â†’ virtual_key
3. æ‰¾åˆ°é»˜è®¤é…ç½®: {"rpm": 1000} (ç§Ÿæˆ·é»˜è®¤)
4. æ— ç‰¹å®šé…ç½® â†’ å¥—é¤è¦†ç›–é»˜è®¤
5. æœ€ç»ˆç»“æœ: {"rpm": 5000} (ä½¿ç”¨å¥—é¤æƒç›Š)
```

è¿™ä¸ªæµç¨‹ç¡®ä¿äº†ç”¨æˆ·æƒç›Šä¼˜å…ˆï¼ŒåŒæ—¶ä¿æŒäº†é…ç½®ç³»ç»Ÿçš„çµæ´»æ€§å’Œå‘åå…¼å®¹æ€§ã€‚

# å®Œæ•´çš„ä¿éšœä½“ç³»(æ•°æ®å®Œæ•´æ€§æ§åˆ¶)

| ä¿éšœç±»å‹       | è§¦å‘å™¨å‡½æ•°                         | ä½œç”¨è¡¨                                         | ä¿éšœå†…å®¹               |
| :------------- | :--------------------------------- | :--------------------------------------------- | :--------------------- |
| **å±‚çº§å…³ç³»**   | `validate_level_hierarchy`         | `config_levels`                                | çˆ¶å­å…³ç³»æ­£ç¡®ï¼Œæ— è‡ªå¼•ç”¨ |
| **æ ¹å±‚çº§çº¦æŸ** | `enforce_root_level_constraint`    | `unified_config_store`                         | æ ¹å±‚çº§é…ç½®å¿…é¡»æ˜¯å…¨å±€çš„ |
| **ç»§æ‰¿æ— ç¯**   | `prevent_inheritance_cycle`        | `inheritance_rules`                            | ç»§æ‰¿å…³ç³»æ— å¾ªç¯         |
| **æ—¶é—´æœ‰æ•ˆæ€§** | `validate_config_effective_period` | æ‰€æœ‰é…ç½®è¡¨                                     | ç”Ÿæ•ˆæ—¶é—´é€»è¾‘æ­£ç¡®       |
| **SchemaéªŒè¯** | `validate_config_schema`           | `unified_config_store` `tier_feature_mappings` | é…ç½®å€¼ç¬¦åˆé¢„å®šä¹‰æ ¼å¼   |

## 1. ç»§æ‰¿æ— ç¯ä¿éšœ `prevent_inheritance_cycle`

```postgresql
CREATE OR REPLACE FUNCTION data.prevent_inheritance_cycle()
RETURNS TRIGGER AS $$
DECLARE
    v_has_cycle BOOLEAN;
BEGIN
    -- ç»§æ‰¿æ— ç¯ä¿éšœ `prevent_inheritance_cycle`
    -- æ£€æŸ¥æ˜¯å¦å½¢æˆå¾ªç¯ç»§æ‰¿
    WITH RECURSIVE inheritance_chain AS (
        SELECT 
            NEW.child_level as current_level,
            NEW.parent_level as next_level,
            1 as depth
        UNION ALL
        SELECT 
            ic.next_level as current_level,
            ir.parent_level as next_level,
            ic.depth + 1
        FROM inheritance_chain ic
        JOIN data.inheritance_rules ir ON ir.child_level = ic.next_level
        WHERE ir.config_type = NEW.config_type
          AND ir.is_inheritance_enabled = true
          AND ir.is_active = true
          AND ic.depth < 10  -- é˜²æ­¢æ— é™é€’å½’
    )
    SELECT EXISTS(
        SELECT 1 FROM inheritance_chain 
        WHERE next_level = NEW.child_level  -- æ£€æµ‹å¾ªç¯ï¼šæ˜¯å¦å›åˆ°èµ·ç‚¹
    ) INTO v_has_cycle;
    
    IF v_has_cycle THEN
        RAISE EXCEPTION 'ç»§æ‰¿è§„åˆ™å½¢æˆå¾ªç¯: % -> % -> %', 
            NEW.parent_level, NEW.child_level, NEW.child_level;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- åœ¨æ’å…¥ç»§æ‰¿è§„åˆ™æ—¶ç«‹å³æ£€æŸ¥
CREATE TRIGGER prevent_inheritance_cycle_trigger
    BEFORE INSERT OR UPDATE ON data.inheritance_rules
    FOR EACH ROW EXECUTE FUNCTION data.prevent_inheritance_cycle();
```

## 2. æ—¶é—´æœ‰æ•ˆæ€§ä¿éšœ `validate_config_effective_period`

```postgresql 
CREATE OR REPLACE FUNCTION data.validate_config_effective_period()
RETURNS TRIGGER AS $$
BEGIN
    -- æ—¶é—´æœ‰æ•ˆæ€§ä¿éšœ
    -- ç”Ÿæ•ˆæ—¶é—´ä¸èƒ½æ™šäºå¤±æ•ˆæ—¶é—´
    IF NEW.effective_to IS NOT NULL AND NEW.effective_from > NEW.effective_to THEN
        RAISE EXCEPTION 'é…ç½®ç”Ÿæ•ˆæ—¶é—´(%)ä¸èƒ½æ™šäºå¤±æ•ˆæ—¶é—´(%)', 
            NEW.effective_from, NEW.effective_to;
    END IF;
    
    -- å¤±æ•ˆæ—¶é—´ä¸èƒ½æ˜¯è¿‡å»çš„æ—¶é—´ï¼ˆé™¤éæ˜¯å†å²é…ç½®ï¼‰
    IF NEW.effective_to IS NOT NULL AND NEW.effective_to < NOW() THEN
        RAISE NOTICE 'è­¦å‘Šï¼šé…ç½®å¤±æ•ˆæ—¶é—´(%)æ˜¯è¿‡å»æ—¶é—´', NEW.effective_to;
        -- æ³¨æ„ï¼šè¿™é‡Œåªæ˜¯è­¦å‘Šï¼Œä¸æ˜¯é”™è¯¯ï¼Œå…è®¸è®¾ç½®å†å²é…ç½®
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- åº”ç”¨åˆ°æ‰€æœ‰é…ç½®ç›¸å…³çš„è¡¨
CREATE TRIGGER validate_config_effective_period_trigger
    BEFORE INSERT OR UPDATE ON data.unified_config_store
    FOR EACH ROW EXECUTE FUNCTION data.validate_config_effective_period();
```

## 3. SchemaéªŒè¯ä¿éšœ `validate_config_schema`

```postgresql
CREATE OR REPLACE FUNCTION data.validate_config_schema()
RETURNS TRIGGER AS $$
DECLARE
    v_schema JSONB;
BEGIN
    -- SchemaéªŒè¯ä¿éšœ `validate_config_schema`
    -- è·å–é…ç½®ç±»å‹çš„schemaå®šä¹‰
    SELECT value_schema INTO v_schema
    FROM data.config_types
    WHERE type_name = NEW.config_type;
    
    -- å¦‚æœå®šä¹‰äº†schemaï¼ŒéªŒè¯é…ç½®å€¼
    IF v_schema IS NOT NULL AND v_schema != '{}'::JSONB THEN
        -- åŸºç¡€ç±»å‹éªŒè¯
        IF v_schema->>'type' = 'object' AND jsonb_typeof(NEW.config_value) != 'object' THEN
            RAISE EXCEPTION 'é…ç½®ç±»å‹"%s"è¦æ±‚é…ç½®å€¼ä¸ºJSONå¯¹è±¡ï¼Œå®é™…ä¸º: %', 
                NEW.config_type, jsonb_typeof(NEW.config_value);
        END IF;
        
        -- å¯ä»¥æ‰©å±•æ›´å¤šéªŒè¯è§„åˆ™
        -- å¦‚ï¼šå¿…éœ€å­—æ®µã€æ•°å€¼èŒƒå›´ã€æšä¸¾å€¼ç­‰
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER validate_config_schema_trigger
    BEFORE INSERT OR UPDATE ON data.unified_config_store
    FOR EACH ROW EXECUTE FUNCTION data.validate_config_schema();
```

## 4. ç»§æ‰¿è·¯å¾„å®Œæ•´æ€§ä¿éšœ

### åœ¨ `resolve_dynamic_config` ä¸­å®ç°: depthå’Œç¡®ä¿è§„åˆ™å­˜åœ¨å’Œæœ‰æ•ˆ

## **5. å¥—é¤æ”¯æŒæ€§çº¦æŸ**

```postgresql
-- é˜²æ­¢ä¸ºä¸æ”¯æŒå¥—é¤çš„é…ç½®ç±»å‹åˆ›å»ºå¥—é¤ç‰¹æ€§
CREATE OR REPLACE FUNCTION data.prevent_unsupported_tier_features()
RETURNS TRIGGER AS $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM data.config_types 
        WHERE type_name = NEW.config_type 
        AND supports_tier_entitlements = true
    ) THEN
        RAISE EXCEPTION 'é…ç½®ç±»å‹"%s"ä¸æ”¯æŒå¥—é¤ç‰¹æ€§ï¼Œæ— æ³•åˆ›å»ºå¥—é¤æ˜ å°„', NEW.config_type;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER prevent_unsupported_tier_features_trigger
    BEFORE INSERT OR UPDATE ON data.tier_feature_mappings
    FOR EACH ROW EXECUTE FUNCTION data.prevent_unsupported_tier_features();
```

## **6. å¥—é¤å¼•ç”¨çº¦æŸ**

```postgresql
CREATE OR REPLACE FUNCTION data.prevent_unsupported_tier_references()
RETURNS TRIGGER AS $$
BEGIN
    -- é˜²æ­¢åœ¨ä¸æ”¯æŒå¥—é¤çš„é…ç½®ä¸Šè®¾ç½®applied_tier
    IF NEW.applied_tier IS NOT NULL AND NOT EXISTS (
        SELECT 1 FROM data.config_types 
        WHERE type_name = NEW.config_type 
        AND supports_tier_entitlements = true
    ) THEN
        RAISE EXCEPTION 'é…ç½®ç±»å‹"%s"ä¸æ”¯æŒå¥—é¤ï¼Œä¸èƒ½è®¾ç½®applied_tier', NEW.config_type;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER prevent_unsupported_tier_references_trigger
    BEFORE INSERT OR UPDATE ON data.unified_config_store
    FOR EACH ROW EXECUTE FUNCTION data.prevent_unsupported_tier_references();
```

# æ•´ä¸ªé…ç½®è§£æå·¥ä½œæµç¨‹

```
ç”¨æˆ·è¯·æ±‚é…ç½® â†’ ç³»ç»ŸæŒ‰è¿™ä¸ªé¡ºåºæ‰¾ï¼š

1. ğŸ¯ å…ˆçœ‹æœ‰æ²¡æœ‰"ç‰¹åˆ«å®šåˆ¶"ï¼ˆvirtual_keyçš„ç‰¹å®šé…ç½®ï¼‰
2. ğŸ° å†çœ‹ç”¨æˆ·ä¹°äº†ä»€ä¹ˆ"å¥—é¤"ï¼ˆtieræƒç›Šï¼‰  
3. ğŸ¢ ç„¶åæŒ‰"æ¥¼å±‚å…³ç³»"å¾€ä¸Šæ‰¾ï¼ˆç»§æ‰¿è·¯å¾„ï¼‰
4. ğŸŒ æœ€åç”¨"é»˜è®¤é…ç½®"ï¼ˆå…¨å±€é»˜è®¤å€¼ï¼‰
```

## ğŸ¯ å›ºå®šä¸çµæ´»éƒ¨åˆ†

### 1. **å±‚çº§åç§°æ˜¯çµæ´»çš„** âœ…
```sql
-- å±‚çº§å¯ä»¥ä»»æ„å‘½åï¼Œä¸åªæ˜¯ global/tenant/user
config_levels:
   level_name (PK) | parent_level | inherit_priority
   'platform'      | NULL         | 1
   'organization'  | 'platform'   | 2  
   'project'       | 'organization' | 3
   'environment'   | 'project'    | 4
   'virtual_key'   | 'environment'| 5  -- ğŸ¯ åªæœ‰è¿™å±‚å›ºå®šï¼Œå› ä¸ºå¯¹æ¥Portkey
```

### 2. **é…ç½®ç±»å‹æœ‰æ˜ç¡®çš„ä¸šåŠ¡å®šä¹‰** ğŸ“‹

åŸºäºä½ æä¾›çš„é…ç½®ç±»å‹æ€»è§ˆï¼š

| é…ç½®ç±»å‹           | ä¸šåŠ¡ç”¨é€” | æŠ€æœ¯æ§åˆ¶ç‚¹      | é…ç½®å±‚çº§ | åˆå¹¶ç­–ç•¥       |
| ------------------ | -------- | --------------- | -------- | -------------- |
| `gateway_routing`  | è·¯ç”±ç­–ç•¥ | Portkey Gateway | æ‰€æœ‰å±‚çº§ | `deep_merge`   |
| `rate_limits`      | æµé‡æ§åˆ¶ | API Gateway     | æ‰€æœ‰å±‚çº§ | `override`     |
| `model_access`     | æ¨¡å‹æƒé™ | ä¸šåŠ¡é€»è¾‘        | æ‰€æœ‰å±‚çº§ | `array_append` |
| `billing_rules`    | è®¡è´¹ç­–ç•¥ | è®¡è´¹æœåŠ¡        | tenant+  | `override`     |
| `security_policy`  | å®‰å…¨ç­–ç•¥ | ç½‘å…³+ä¸šåŠ¡       | æ‰€æœ‰å±‚çº§ | `deep_merge`   |
| `content_filters`  | å†…å®¹è¿‡æ»¤ | é¢„å¤„ç†å±‚        | æ‰€æœ‰å±‚çº§ | `deep_merge`   |
| `cache_strategy`   | ç¼“å­˜ç­–ç•¥ | Portkey Gateway | æ‰€æœ‰å±‚çº§ | `override`     |
| `monitoring_alert` | ç›‘æ§å‘Šè­¦ | ç›‘æ§ç³»ç»Ÿ        | platform | `override`     |

### 3. **åˆå¹¶ç­–ç•¥è¯¦è§£** ğŸ”„

ç›®å‰ç³»ç»Ÿæ”¯æŒ**3ç§**åˆå¹¶ç­–ç•¥ï¼š

#### A. **`override`** - å®Œå…¨è¦†ç›–
```sql
-- çˆ¶çº§: {"rpm": 100, "tpm": 10000}
-- å­çº§: {"rpm": 500}
-- ç»“æœ: {"rpm": 500}  -- å­çº§å®Œå…¨è¦†ç›–çˆ¶çº§
```
**é€‚ç”¨åœºæ™¯**: é€Ÿç‡é™åˆ¶ã€è®¡è´¹è§„åˆ™ã€ç¼“å­˜ç­–ç•¥

#### B. **`deep_merge`** - æ·±åº¦åˆå¹¶  
```sql
-- çˆ¶çº§: {"timeout": 30, "retry_count": 3}
-- å­çº§: {"timeout": 60, "provider": "openai"}
-- ç»“æœ: {"timeout": 60, "retry_count": 3, "provider": "openai"}
```
**é€‚ç”¨åœºæ™¯**: è·¯ç”±é…ç½®ã€å®‰å…¨ç­–ç•¥ã€å†…å®¹è¿‡æ»¤

#### C. **`array_append`** - æ•°ç»„è¿½åŠ 
```sql
-- çˆ¶çº§: {"allowed_models": ["gpt-3.5"]}
-- å­çº§: {"allowed_models": ["gpt-4", "claude-2"]}  
-- ç»“æœ: {"allowed_models": ["gpt-3.5", "gpt-4", "claude-2"]}
```
**é€‚ç”¨åœºæ™¯**: æ¨¡å‹æƒé™ï¼ˆåˆå¹¶æ‰€æœ‰å¯ç”¨æ¨¡å‹ï¼‰

## ğŸ”§ ç³»ç»Ÿæ‰©å±•æ€§

```sql
-- å¯ä»¥éšæ—¶æ–°å¢é…ç½®ç±»å‹ï¼ˆä½†éœ€è¦æ˜ç¡®ä¸šåŠ¡å®šä¹‰ï¼‰
INSERT INTO config_types VALUES 
('new_feature_flags', 'åŠŸèƒ½å¼€å…³', '{"type":"object"}', '{}', 'deep_merge', 'åŠŸèƒ½ç°åº¦å‘å¸ƒ');

-- å¯ä»¥éšæ—¶æ–°å¢å±‚çº§
INSERT INTO config_levels VALUES 
('region', 'åŒºåŸŸå±‚çº§', 'tenant', 2.5, 'æŒ‰åŒºåŸŸåˆ’åˆ†é…ç½®');
```

## é…ç½®ç±»å‹(config_type æ”¯æŒå¥—é¤(tier) yes/no)

`supports_tier_entitlements = true or false`

åŸºäºä¸šåŠ¡é€»è¾‘ï¼Œæ›´åˆç†çš„åˆ†ç±»å¯èƒ½æ˜¯ï¼š

sql

```
-- å•†ä¸šåŒ–åŠŸèƒ½ï¼ˆæ”¯æŒå¥—é¤ï¼‰
UPDATE data.config_types SET supports_tier_entitlements = true 
WHERE type_name IN ('rate_limits', 'model_access', 'billing_rules', 'cache_strategy');

-- ç³»ç»ŸåŠŸèƒ½ï¼ˆä¸æ”¯æŒå¥—é¤ï¼‰
UPDATE data.config_types SET supports_tier_entitlements = false 
WHERE type_name IN ('monitoring_alert', 'gateway_routing', 'security_policy', 'content_filters');
```

```postgresql
ALTER TABLE data.config_types 
ADD COLUMN supports_tier_entitlements BOOLEAN DEFAULT true;
```

**å•†ä¸šé€»è¾‘**ï¼š

- ğŸ’° **å•†ä¸šåŒ–åŠŸèƒ½**ï¼šé€Ÿç‡é™åˆ¶ã€æ¨¡å‹æƒé™ã€è®¡è´¹è§„åˆ™ã€ç¼“å­˜ç­–ç•¥
- ğŸ”§ **ç³»ç»ŸåŠŸèƒ½**ï¼šè·¯ç”±é…ç½®ã€å®‰å…¨ç­–ç•¥ã€å†…å®¹è¿‡æ»¤ã€ç›‘æ§å‘Šè­¦

```postgresql
-- æ¸…ç©ºå¹¶é‡æ–°åˆå§‹åŒ– config_types è¡¨
TRUNCATE TABLE data.config_types CASCADE;

-- æ’å…¥é…ç½®ç±»å‹åŠé»˜è®¤å€¼
INSERT INTO data.config_types (type_name, display_name, value_schema, default_value, merge_strategy, description, is_system_type, supports_tier_entitlements) VALUES 
-- ğŸš€ ç½‘å…³è·¯ç”±é…ç½®
('gateway_routing', 'ç½‘å…³è·¯ç”±', 
 '{"type": "object", "properties": {"timeout": {"type": "number"}, "retry_count": {"type": "number"}, "provider": {"type": "string"}}}',
 '{"timeout": 30, "retry_count": 3}',
 'deep_merge', 
 'APIç½‘å…³è·¯ç”±ç­–ç•¥ï¼Œæ§åˆ¶è¶…æ—¶ã€é‡è¯•ç­‰', 
 true, false),

-- ğŸ“Š é€Ÿç‡é™åˆ¶  
('rate_limits', 'é€Ÿç‡é™åˆ¶',
 '{"type": "object", "properties": {"rpm": {"type": "number"}, "tpm": {"type": "number"}, "daily_limit": {"type": "number"}}}',
 '{"rpm": 100, "tpm": 10000}',
 'override',
 'APIè°ƒç”¨é¢‘ç‡é™åˆ¶ï¼ŒåŒ…æ‹¬æ¯åˆ†é’Ÿè¯·æ±‚æ•°å’Œtokenæ•°',
 true, true),

-- ğŸ§  æ¨¡å‹æƒé™
('model_access', 'æ¨¡å‹æƒé™',
 '{"type": "object", "properties": {"allowed_models": {"type": "array"}, "blocked_models": {"type": "array"}}}',
 '{"allowed_models": ["gpt-3.5-turbo"]}',
 'array_append',
 'å¯è®¿é—®çš„AIæ¨¡å‹åˆ—è¡¨ï¼Œæ”¯æŒæ¨¡å‹çº§æƒé™æ§åˆ¶',
 true, true),

-- ğŸ’° è®¡è´¹è§„åˆ™
('billing_rules', 'è®¡è´¹è§„åˆ™', 
 '{"type": "object", "properties": {"price_per_token": {"type": "number"}, "currency": {"type": "string"}, "free_quota": {"type": "number"}}}',
 '{"price_per_token": 0.00002, "currency": "USD", "free_quota": 1000}',
 'override',
 'è®¡è´¹ç­–ç•¥å’Œä»·æ ¼é…ç½®',
 true, true),

-- ğŸ”’ å®‰å…¨ç­–ç•¥
('security_policy', 'å®‰å…¨ç­–ç•¥',
 '{"type": "object", "properties": {"require_2fa": {"type": "boolean"}, "ip_whitelist": {"type": "array"}, "audit_logging": {"type": "boolean"}}}',
 '{"require_2fa": false, "audit_logging": true}',
 'deep_merge',
 'å®‰å…¨æ§åˆ¶ç­–ç•¥ï¼ŒåŒ…æ‹¬åŒå› å­è®¤è¯ã€IPç™½åå•ç­‰',
 true, false),

-- ğŸ›¡ï¸ å†…å®¹è¿‡æ»¤
('content_filters', 'å†…å®¹è¿‡æ»¤',
 '{"type": "object", "properties": {"moderation_enabled": {"type": "boolean"}, "custom_filters": {"type": "array"}}}',
 '{"moderation_enabled": true}',
 'deep_merge',
 'å†…å®¹å®‰å…¨è¿‡æ»¤ç­–ç•¥ï¼Œæ”¯æŒè‡ªå®šä¹‰è¿‡æ»¤è§„åˆ™',
 true, false),

-- ğŸ’¾ ç¼“å­˜ç­–ç•¥
('cache_strategy', 'ç¼“å­˜ç­–ç•¥',
 '{"type": "object", "properties": {"enabled": {"type": "boolean"}, "ttl": {"type": "number"}, "strategy": {"type": "string"}}}',
 '{"enabled": false, "ttl": 3600}',
 'override',
 'å“åº”ç¼“å­˜ç­–ç•¥ï¼Œæ§åˆ¶ç¼“å­˜ç”Ÿæ•ˆæ—¶é—´å’Œç­–ç•¥',
 true, true),

-- ğŸ“ˆ ç›‘æ§å‘Šè­¦
('monitoring_alert', 'ç›‘æ§å‘Šè­¦',
 '{"type": "object", "properties": {"alert_threshold": {"type": "number"}, "notify_channels": {"type": "array"}, "enabled": {"type": "boolean"}}}',
 '{"alert_threshold": 0.8, "enabled": true, "notify_channels": ["email"]}',
 'override',
 'ç³»ç»Ÿç›‘æ§å’Œå‘Šè­¦é…ç½®',
 true, false);
```

# ğŸ“‹ æ¡ä»¶æ±‚å€¼ç³»ç»Ÿè¯´æ˜

## ğŸ¯ ä»€ä¹ˆæ˜¯æ¡ä»¶æ±‚å€¼ï¼Ÿ

æ¡ä»¶æ±‚å€¼ç³»ç»Ÿå…è®¸é…ç½®**åŸºäºè¿è¡Œæ—¶ä¸Šä¸‹æ–‡åŠ¨æ€ç”Ÿæ•ˆ**ã€‚æ¯”å¦‚ï¼š
- "åŒ—äº¬åŒºåŸŸçš„ç”¨æˆ·ä½¿ç”¨ç‰¹æ®Šé…ç½®"
- "VIPç”¨æˆ·äº«æœ‰æ›´é«˜æƒé™"  
- "æ–°åŠŸèƒ½åªå¯¹å†…éƒ¨ç”¨æˆ·å¼€æ”¾"

## ğŸ”§ æ¡ä»¶è¡¨è¾¾å¼æ ¼å¼

### 1. **æ ‡å‡†æ ¼å¼**ï¼ˆæ¨èï¼‰
```json
{
    "field": "å­—æ®µå",
    "operator": "æ“ä½œç¬¦", 
    "value": "å€¼æˆ–æ•°ç»„"
}
```

### 2. **ç®€å•æ ¼å¼**ï¼ˆå¿«æ·æ–¹å¼ï¼‰
```json
{
    "å­—æ®µå": "æœŸæœ›å€¼"
}
// ç­‰ä»·äº {"field": "å­—æ®µå", "operator": "equals", "value": "æœŸæœ›å€¼"}
```

## ğŸ“š æ”¯æŒçš„æ“ä½œç¬¦

### æ¯”è¾ƒæ“ä½œç¬¦
```json
// ç­‰äº
{"field": "user_type", "operator": "equals", "value": "vip"}

// å¤§äº
{"field": "age", "operator": "greater_than", "value": 18}

// å°äº  
{"field": "usage", "operator": "less_than", "value": 1000}
```

### é›†åˆæ“ä½œç¬¦
```json
// åœ¨æ•°ç»„ä¸­
{"field": "region", "operator": "in", "value": ["beijing", "shanghai"]}

// ä¸åœ¨æ•°ç»„ä¸­
{"field": "user_type", "operator": "not_in", "value": ["trial", "banned"]}
```

### å­˜åœ¨æ€§æ£€æŸ¥
```json
// å­—æ®µå­˜åœ¨ï¼ˆä¸éœ€è¦valueï¼‰
{"field": "vip_level", "operator": "exists", "value": null}
```

## ğŸª ä½¿ç”¨åœºæ™¯ç¤ºä¾‹

### åœºæ™¯1ï¼šåŒºåŸŸå·®å¼‚åŒ–é…ç½®
```sql
-- å¥—é¤ç‰¹æ€§è¡¨
INSERT INTO tier_feature_mappings VALUES 
('premium', 'rate_limits', '{"rpm": 5000}', NULL),  -- é»˜è®¤é…ç½®
('premium', 'rate_limits', '{"rpm": 10000}', '{"field": "region", "operator": "in", "value": ["beijing", "shanghai"]}');  -- åŒ—ä¸Šå¹¿ç‰¹æ®Šé…ç½®

-- è¿è¡Œæ—¶
context = {"region": "beijing", "tier_name": "premium"}
â†’ è¿”å›: {"rpm": 10000}  âœ… åŒ¹é…åŒ—äº¬æ¡ä»¶

context = {"region": "shenzhen", "tier_name": "premium"}  
â†’ è¿”å›: {"rpm": 5000}   âœ… å›é€€åˆ°é»˜è®¤é…ç½®
```

### åœºæ™¯2ï¼šç”¨æˆ·ç±»å‹æƒé™æ§åˆ¶
```sql
-- æ¨¡å‹æƒé™è¡¨
INSERT INTO tier_feature_mappings VALUES 
('enterprise', 'model_access', '{"allowed_models": ["gpt-4"]}', NULL),  -- é»˜è®¤
('enterprise', 'model_access', '{"allowed_models": ["gpt-4", "claude-2", "qwen-turbo"]}', '{"field": "user_type", "operator": "equals", "value": "researcher"}');  -- ç ”ç©¶äººå‘˜é¢å¤–æƒé™

-- è¿è¡Œæ—¶  
context = {"user_type": "researcher", "tier_name": "enterprise"}
â†’ è¿”å›: {"allowed_models": ["gpt-4", "claude-2", "qwen-turbo"]}  âœ… ç ”ç©¶äººå‘˜æƒé™
```

### åœºæ™¯3ï¼šåŠŸèƒ½ç°åº¦å‘å¸ƒ
```sql
-- åŠŸèƒ½å¼€å…³è¡¨
INSERT INTO unified_config_store VALUES 
('feature_flags', 'platform', NULL, '{"new_ui": false}', NULL, NULL, NULL),  -- å…¨å±€å…³é—­
('feature_flags', 'platform', NULL, '{"new_ui": true}', NULL, NULL, '{"field": "user_id", "operator": "in", "value": ["user123", "user456"]}');  -- ç‰¹å®šç”¨æˆ·å¼€å¯

-- è¿è¡Œæ—¶
context = {"user_id": "user123"}
â†’ è¿”å›: {"new_ui": true}  âœ… ç™½åå•ç”¨æˆ·çœ‹åˆ°æ–°UI
```

## ğŸ” ä¸Šä¸‹æ–‡æ•°æ®æº

æ¡ä»¶æ±‚å€¼ä½¿ç”¨çš„ä¸Šä¸‹æ–‡å¯ä»¥æ¥è‡ªï¼š

### 1. **ç”¨æˆ·è¯·æ±‚æ˜¾å¼ä¼ é€’**
```sql
-- è§£æé…ç½®æ—¶ä¼ å…¥ä¸Šä¸‹æ–‡
api.resolve_dynamic_config(
    'rate_limits', 
    'virtual_key', 
    key_id, 
    '{"region": "beijing", "user_type": "vip", "app_version": "2.0"}'
)
```

### 2. **ç³»ç»Ÿè‡ªåŠ¨æ³¨å…¥**
```sql
-- å¯æ‰©å±•ï¼šä»ç”¨æˆ·èµ„æ–™ã€åœ°ç†ä½ç½®ç­‰è‡ªåŠ¨æ³¨å…¥
context = {
    "region": "beijing",           -- ä»IPè§£æ
    "user_type": "premium",        -- ä»ç”¨æˆ·è¡¨æŸ¥è¯¢  
    "registration_date": "2024-01-01",  -- ä»ç”¨æˆ·èµ„æ–™è·å–
    "current_time": "14:30"        -- ç³»ç»Ÿæ—¶é—´
}
```

### 3. **ä¸šåŠ¡é€»è¾‘ä¼ é€’**
```sql
-- ä¸šåŠ¡å±‚æ ¹æ®åœºæ™¯æ„é€ ä¸Šä¸‹æ–‡
IF is_internal_user THEN
    context['internal'] = true
    context['beta_features'] = true
END IF
```

## âš ï¸ æœ€ä½³å®è·µ

### 1. **æ¡ä»¶è®¾è®¡åŸåˆ™**
```sql
-- âœ… å¥½çš„æ¡ä»¶ï¼šæ˜ç¡®ã€å¯æµ‹è¯•
{"field": "region", "operator": "in", "value": ["beijing", "shanghai"]}

-- âŒ é¿å…çš„æ¡ä»¶ï¼šè¿‡äºå¤æ‚
{"field": "complex_logic", "operator": "custom", "value": "user.age > 18 AND user.vip = true"}
```

### 2. **å›é€€ç­–ç•¥**
```sql
-- æ€»æ˜¯æä¾›æ— æ¡ä»¶é»˜è®¤é…ç½®
INSERT INTO tier_feature_mappings VALUES 
('premium', 'rate_limits', '{"rpm": 5000}', NULL),  -- é»˜è®¤
('premium', 'rate_limits', '{"rpm": 10000}', '{"region": "beijing"}');  -- æ¡ä»¶é…ç½®
```

### 3. **æ€§èƒ½è€ƒè™‘**
```sql
-- ä½¿ç”¨ç´¢å¼•å‹å¥½çš„æ¡ä»¶
{"field": "user_id", "operator": "equals", "value": "123"}  -- âœ… å¯ç´¢å¼•

-- é¿å…å…¨è¡¨æ‰«æçš„æ¡ä»¶  
{"field": "email", "operator": "like", "value": "%@example.com"}  -- âŒ æ€§èƒ½å·®
```

## ğŸ”§ è°ƒè¯•å’Œæ’æŸ¥

### æŸ¥çœ‹æ¡ä»¶åŒ¹é…è¯¦æƒ…
```sql
-- åœ¨ get_tier_default_config ä¸­å¯ç”¨è°ƒè¯•
RAISE NOTICE '    ğŸ¯ æ¡ä»¶è¯„ä¼°: field=%, operator=%, value=%, context_value=%', 
    v_field, v_operator, v_value, v_context_value;
```

### æµ‹è¯•æ¡ä»¶è¡¨è¾¾å¼
```sql
-- æ‰‹åŠ¨æµ‹è¯•æ¡ä»¶
SELECT api.evaluate_condition(
    '{"field": "region", "operator": "in", "value": ["beijing", "shanghai"]}', 
    '{"region": "beijing"}'
);
-- æœŸæœ›: true
```

## ğŸš€ æ‰©å±•èƒ½åŠ›

ç³»ç»Ÿæ”¯æŒéšæ—¶æ‰©å±•æ–°çš„æ“ä½œç¬¦ï¼š

```sql
-- å¦‚éœ€æ”¯æŒæ­£åˆ™åŒ¹é…
WHEN 'regex' THEN
    RETURN regexp_match(v_context_value::text, v_value::text) IS NOT NULL;
    
-- å¦‚éœ€æ”¯æŒæ—¶é—´èŒƒå›´
WHEN 'time_between' THEN
    RETURN current_time BETWEEN (v_value->>'start')::time AND (v_value->>'end')::time;
```

# é…ç½®æ“ä½œapi

## å‡½æ•°

- `api.config_create: é…ç½®åˆ›å»º`
- `api.config_update`: é…ç½®æ›´æ–°
- `api.config_delete`: é…ç½®åˆ é™¤
- `api.virtual_config_set`: -- ä¸º Virtual Key è®¾ç½®é…ç½®
- `api.tier_feature_set`: -- è®¾ç½®å¥—é¤ç‰¹æ€§
- `api.virtual_config_resolve`: -- è§£æ Virtual Key å®Œæ•´é…ç½®
- `test_config_setup` 
- `test_config_cleanup` 

## **è¯»å–** 

* `api.config_view`: -- é…ç½®æŸ¥è¯¢
* `api.virtual_key_config_view`: -- Virtual Key é…ç½®
* `api.tier_feature_view`: -- å¥—é¤ç‰¹æ€§

# ä¸portky gatewayçš„æ•´åˆ

## ğŸ¯ **å…³é”®å‘ç°ä¸å¯¹æ¥ç­–ç•¥**

### âœ… **é…ç½®æ ¼å¼100%å…¼å®¹**
ä½ çš„ Config Service ç”Ÿæˆçš„é…ç½®å®Œå…¨ç¬¦åˆ Portkey Gateway è¦æ±‚ï¼š

```json
{
  "strategy": {"mode": "fallback", "on_status_codes": [429,500,502,503]},
  "targets": [{
    "provider": "openai", 
    "virtual_key": "vk-xxx",
    "override_params": {"model": "gpt-4", "max_tokens": 2000}
  }]
}
```

### ğŸš€ **å¯¹æ¥æ–¹æ¡ˆç¡®è®¤ï¼šå®Œæ•´é…ç½®ä¼ é€’**

**å·¥ä½œæµç¨‹**ï¼š
```
ç”¨æˆ·è¯·æ±‚ â†’ API Gateway â†’ Config Service â†’ å®Œæ•´Portkeyé…ç½® â†’ Portkey Gateway
```

**Headerè®¾ç½®**ï¼š
```http
x-portkey-config: {"strategy":{"mode":"fallback",...}}
x-portkey-metadata: {"user_id":"user123","tier_name":"premium"}
```

## ğŸ”§ **åŸºäºéªŒè¯çš„ä¼˜åŒ–å»ºè®®**

### 1. **ä¸°å¯Œç­–ç•¥æ”¯æŒ**
å½“å‰åªç”¨äº† `fallback`ï¼Œå¯ä»¥æ‰©å±•ï¼š

```javascript
// æ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©ç­–ç•¥
static selectStrategy(dynamicConfigs, context) {
    if (context.tier_name === 'enterprise') {
        return {
            mode: 'conditional',
            conditions: [
                {
                    query: {"$.metadata.content_type": "code"},
                    then: "code-optimized"
                }
            ],
            default: "high-performance"
        };
    }
    
    // é»˜è®¤fallbackç­–ç•¥
    return {
        mode: 'fallback',
        on_status_codes: [429, 500, 502, 503]
    };
}
```

### 2. **å¢å¼ºMetadata**
```javascript
// åŸºäºéªŒè¯æ–‡æ¡£çš„å»ºè®®metadata
metadata: {
    // å®¢æˆ·èº«ä»½
    customer_id: context.user_id,
    customer_tier: context.tier_name,
    
    // å†…å®¹ç‰¹å¾ï¼ˆå¯ä»è¯·æ±‚åˆ†æï¼‰
    content_type: this.analyzeContentType(context.request_body),
    content_language: 'chinese',
    
    // ä¸šåŠ¡è§„åˆ™
    cost_preference: this.getCostPreference(context.tier_name),
    latency_requirement: 'standard',
    
    // ç³»ç»Ÿä¸Šä¸‹æ–‡
    request_priority: 'normal',
    environment: process.env.NODE_ENV
}
```

### 3. **æ”¯æŒå¤æ‚åµŒå¥—ç­–ç•¥**
```javascript
// ä¼ä¸šçº§ç”¨æˆ·çš„å¤æ‚è·¯ç”±
static buildEnterpriseConfig(dynamicConfigs, context) {
    return {
        strategy: {
            mode: "conditional",
            conditions: [
                {
                    query: {
                        "$.metadata.content_type": "code",
                        "$.metadata.customer_tier": "enterprise"
                    },
                    then: "enterprise-code-cluster"
                }
            ],
            default: "enterprise-general-cluster"
        },
        targets: [
            {
                name: "enterprise-code-cluster",
                strategy: {
                    mode: "loadbalance"
                },
                targets: [
                    {provider: "openai", virtual_key: "vk-code-1", weight: 6},
                    {provider: "anthropic", virtual_key: "vk-code-2", weight: 4}
                ]
            },
            {
                name: "enterprise-general-cluster", 
                provider: "openai",
                virtual_key: "vk-enterprise",
                override_params: {model: "gpt-4"}
            }
        ]
    };
}
```

## ğŸ¯ **ç«‹å³å¯è¡Œçš„å®æ–½æ­¥éª¤**

### é˜¶æ®µ1ï¼šåŸºç¡€å¯¹æ¥ï¼ˆå½“å‰å³å¯å®ç°ï¼‰
```javascript
// API Gateway é€»è¾‘
async function handleUserRequest(userRequest) {
    // 1. æ„å»ºç”¨æˆ·ä¸Šä¸‹æ–‡
    const userContext = {
        user_id: userRequest.user_id,
        virtual_key: userRequest.virtual_key, 
        tier_name: userRequest.tier_name,
        request_body: userRequest.body
    };
    
    // 2. è°ƒç”¨Config Service
    const configResponse = await configService.generateConfig(userContext, userRequest.body);
    
    // 3. è®¾ç½®Portkey headers
    const portkeyHeaders = {
        'x-portkey-config': JSON.stringify(configResponse.config),
        'x-portkey-metadata': JSON.stringify(userContext)
    };
    
    // 4. è½¬å‘åˆ°Portkey Gateway
    return await forwardToPortkey(userRequest, portkeyHeaders);
}
```

### é˜¶æ®µ2ï¼šé«˜çº§åŠŸèƒ½ï¼ˆåç»­è¿­ä»£ï¼‰
- æ¡ä»¶è·¯ç”±åŸºäºå†…å®¹åˆ†æ
- è´Ÿè½½å‡è¡¡ç­–ç•¥
- æˆæœ¬ä¼˜åŒ–è·¯ç”±
- A/Bæµ‹è¯•è·¯ç”±

è¿™æ˜¯ä¸ªéå¸¸å¥½çš„é—®é¢˜ï¼è®©æˆ‘å¸®ä½ ç†æ¸…è¿™ä¸ªå…³ç³»ï¼š

## ğŸ¯ **æ ¸å¿ƒå…³ç³»ï¼šæ•°æ®å±‚é…ç½® vs Portkeyé…ç½®**

### **æ•°æ®å±‚é…ç½®**ï¼ˆä½ åˆšå»ºå¥½çš„ç³»ç»Ÿï¼‰
```yaml
# ä¸šåŠ¡è§„åˆ™å®šä¹‰
rate_limits: {"rpm": 5000}
model_access: {"allowed_models": ["gpt-4", "claude-2"]}
gateway_routing: {"timeout": 60}
```

### **Portkeyé…ç½®**ï¼ˆè·¯ç”±æ‰§è¡Œï¼‰
```json
{
  "strategy": {"mode": "conditional"},
  "targets": [
    {"provider": "openai", "virtual_key": "vk-xxx", "weight": 7},
    {"provider": "anthropic", "virtual_key": "vk-yyy", "weight": 3}
  ]
}
```

## ğŸ”„ **é…åˆæ–¹å¼åˆ†æ**

### âœ… **å½“å‰é…åˆè‰¯å¥½**
```javascript
// ä½ çš„ç³»ç»Ÿå·²ç»èƒ½ç”Ÿæˆæœ‰æ•ˆçš„Portkeyé…ç½®
{
  "strategy": {"mode": "fallback", "on_status_codes": [429,500]},
  "targets": [{
    "provider": "openai",
    "virtual_key": "user-virtual-key",  // ğŸ¯ ä»æ•°æ®å±‚è·å–
    "override_params": {
      "model": "gpt-4"  // ğŸ¯ ä»æ•°æ®å±‚model_accessè·å–
    }
  }]
}
```

### â“ **æ¡ä»¶è·¯ç”±çš„æŒ‘æˆ˜**
Portkeyçš„æ¡ä»¶è·¯ç”±éœ€è¦**è¯·æ±‚æ—¶**çš„metadataï¼š
```json
{
  "strategy": {
    "mode": "conditional",
    "conditions": [{
      "query": {"$.metadata.content_type": "code"},  // ğŸ¯ éœ€è¦å®æ—¶å†…å®¹åˆ†æ
      "then": "code-cluster"
    }]
  }
}
```

ä½†ä½ çš„æ•°æ®å±‚é…ç½®æ˜¯**ç”¨æˆ·çº§åˆ«**çš„ï¼Œä¸åŒ…å«å®æ—¶å†…å®¹ä¿¡æ¯ã€‚

## ğŸ¯ **è§£å†³æ–¹æ¡ˆï¼šåˆ†å±‚é…ç½®ç­–ç•¥**

### **æ–¹æ¡ˆAï¼šæ•°æ®å±‚é©±åŠ¨ç®€å•è·¯ç”±**ï¼ˆæ¨èå…ˆå®ç°ï¼‰
```javascript
// Config Service æ ¹æ®ç”¨æˆ·å¥—é¤ç”ŸæˆåŸºç¡€Portkeyé…ç½®
static generateBasicConfig(userContext) {
    // ä»æ•°æ®å±‚è·å–ç”¨æˆ·çº§åˆ«çš„é…ç½®
    const userConfig = await this.resolveAllConfigs(userContext);
    
    return {
        strategy: {
            mode: userConfig.gateway_routing?.strategy || "fallback",
            on_status_codes: [429, 500, 502, 503]
        },
        targets: [{
            provider: this.inferProvider(userContext.model),
            virtual_key: userContext.virtual_key,
            override_params: {
                model: userContext.model,
                max_tokens: userConfig.rate_limits?.max_tokens || 2000
            }
        }]
    };
}
```

### **æ–¹æ¡ˆBï¼šæ··åˆé…ç½®**ï¼ˆåç»­æ‰©å±•ï¼‰
```javascript
// æ•°æ®å±‚å®šä¹‰ä¸šåŠ¡è§„åˆ™ï¼Œå®æ—¶è¯·æ±‚è¡¥å……ä¸Šä¸‹æ–‡
static generateHybridConfig(userContext, realtimeMetadata) {
    const userConfig = await this.resolveAllConfigs(userContext);
    
    // å¦‚æœç”¨æˆ·æ˜¯enterpriseçº§åˆ«ï¼Œå¯ç”¨å¤æ‚è·¯ç”±
    if (userContext.tier_name === 'enterprise') {
        return {
            strategy: {
                mode: "conditional",
                conditions: [
                    {
                        query: {"$.metadata.content_type": "code"},
                        then: "enterprise-code"
                    },
                    {
                        query: {"$.metadata.priority": "high"},
                        then: "enterprise-priority" 
                    }
                ],
                default: "enterprise-default"
            },
            targets: [
                {
                    name: "enterprise-code",
                    provider: "anthropic",  // Claudeæ›´é€‚åˆä»£ç 
                    virtual_key: userConfig.enterprise_features?.code_virtual_key
                },
                {
                    name: "enterprise-priority", 
                    provider: "openai",
                    virtual_key: userConfig.enterprise_features?.priority_virtual_key,
                    override_params: {"model": "gpt-4"}
                },
                {
                    name: "enterprise-default",
                    provider: "openai",
                    virtual_key: userContext.virtual_key
                }
            ]
        };
    }
    
    // æ™®é€šç”¨æˆ·å›é€€åˆ°ç®€å•é…ç½®
    return this.generateBasicConfig(userContext);
}
```

## ğŸ”§ **æ•°æ®å±‚éœ€è¦æ‰©å±•çš„é…ç½®**

ä¸ºäº†æ›´å¥½é…åˆPortkeyï¼Œå¯ä»¥åœ¨æ•°æ®å±‚æ·»åŠ ï¼š

### **1. è·¯ç”±ç­–ç•¥é…ç½®**
```sql
INSERT INTO config_types VALUES 
('routing_strategy', 'è·¯ç”±ç­–ç•¥', '{"type":"object"}', 
 '{"mode":"fallback"}', 'override', 'Portkeyè·¯ç”±ç­–ç•¥é…ç½®');
```

### **2. æ¡ä»¶è·¯ç”±è§„åˆ™**
```sql
INSERT INTO config_types VALUES
('conditional_routing', 'æ¡ä»¶è·¯ç”±', '{"type":"object"}',
 '{"conditions":[]}', 'deep_merge', 'æ¡ä»¶è·¯ç”±è§„åˆ™å®šä¹‰');
```

### **3. ç›®æ ‡é›†ç¾¤é…ç½®**
```sql
INSERT INTO config_types VALUES  
('target_clusters', 'ç›®æ ‡é›†ç¾¤', '{"type":"object"}',
 '{"clusters":{}}', 'deep_merge', 'è·¯ç”±ç›®æ ‡é›†ç¾¤å®šä¹‰');
```

## ğŸš€ **å®æ–½å»ºè®®**

### **é˜¶æ®µ1ï¼šç«‹å³å¼€å§‹** âœ…
```javascript
// ä½¿ç”¨å½“å‰æ•°æ®å±‚é…ç½®ç”ŸæˆåŸºç¡€Portkeyé…ç½®
// å·²éªŒè¯å¯è¡Œï¼Œé…ç½®æ ¼å¼å…¼å®¹
```

### **é˜¶æ®µ2ï¼šç®€å•æ¡ä»¶è·¯ç”±**
```javascript  
// åŸºäºç”¨æˆ·å±æ€§ï¼ˆéå†…å®¹ï¼‰çš„æ¡ä»¶è·¯ç”±
// æ¯”å¦‚ï¼šif (user.tier === 'premium') then use gpt-4 else gpt-3.5
```

### **é˜¶æ®µ3ï¼šé«˜çº§å†…å®¹è·¯ç”±**
```javascript
// éœ€è¦å®æ—¶å†…å®¹åˆ†æ + æ•°æ®å±‚è§„åˆ™é…åˆ
// æ¯”å¦‚ï¼šåˆ†æç”¨æˆ·æ¶ˆæ¯å†…å®¹ï¼Œé€‰æ‹©æœ€é€‚åˆçš„æ¨¡å‹
```

## ğŸ’¡ **ç»“è®º**

**ä½ çš„æ•°æ®å±‚é…ç½®ç³»ç»Ÿä¸Portkey Gatewayé…åˆå¾—å¾ˆå¥½ï¼**

å½“å‰å¯ä»¥ç«‹å³å®ç°ï¼š
- âœ… ç”¨æˆ·çº§åˆ«çš„è·¯ç”±ç­–ç•¥ï¼ˆå¥—é¤å†³å®šä½¿ç”¨ä»€ä¹ˆæ¨¡å‹ï¼‰
- âœ… é€Ÿç‡é™åˆ¶å’Œæƒé™æ§åˆ¶  
- âœ… åŸºç¡€fallbackç­–ç•¥

åç»­å¯ä»¥æ‰©å±•ï¼š
- ğŸ”„ åŸºäºç”¨æˆ·å±æ€§çš„æ¡ä»¶è·¯ç”±
- ğŸ”„ å¤æ‚åµŒå¥—ç­–ç•¥
- ğŸ”„ å®æ—¶å†…å®¹åˆ†æè·¯ç”±
