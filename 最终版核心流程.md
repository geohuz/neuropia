```postgresql
    PERFORM pg_notify(
        'account_balance_updated',
        json_build_object(
            'account_id', p_account_id::text, -- ä¸šåŠ¡id (owner_userid, owner_tenantid)
            'account_type', p_account_type,
            'old_balance', v_old_balance,
            'new_balance', v_new_balance
        )::text
    );
```

### æ ¸å¿ƒè¡¨ï¼ˆ3å¼ ï¼‰

**1. `account_balance`ï¼ˆå½“å‰ä½™é¢è¡¨ï¼‰**
```
user_id (PK) | balance | updated_at
ç›®çš„ï¼šå­˜å‚¨ç”¨æˆ·å½“å‰ä½™é¢ï¼ŒæŸ¥è¯¢æå¿«
```

**2. `fund_transactions`ï¼ˆèµ„é‡‘æµæ°´è¡¨ï¼‰**

```
id | user_id | type | amount | balance_before | balance_after | reference_id | created_at
ç±»å‹ï¼šdepositï¼ˆå……å€¼ï¼‰ã€refundï¼ˆé€€æ¬¾ï¼‰ã€adjustmentï¼ˆè°ƒæ•´ï¼‰
ç›®çš„ï¼šè®°å½•æ‰€æœ‰éAPIæ¶ˆè´¹çš„èµ„é‡‘å˜åŠ¨
```

**3. `usage_log`ï¼ˆä½¿ç”¨æµæ°´è¡¨ï¼‰**

```
id | deduction_id | user_id | virtual_key | provider | model | tokens | amount | 
    balance_before | balance_after | created_at
ç›®çš„ï¼šè®°å½•æ‰€æœ‰APIæ¶ˆè´¹ï¼ŒåŒ…å«å®Œæ•´çš„ä½™é¢å®¡è®¡ä¿¡æ¯
```

---

## å®Œæ•´ä¸šåŠ¡æµç¨‹

### ç¬¬ä¸€é˜¶æ®µï¼šå……å€¼æµç¨‹

**è°ƒç”¨å…¥å£**ï¼š`confirm_topup(p_topup_id uuid)`

1. éªŒè¯`topup_record`çŠ¶æ€æ˜¯å¦ä¸ºpending
2. æ›´æ–°`account_balance`è¡¨ï¼šä½™é¢å¢åŠ 
3. æ’å…¥`fund_transactions`è¡¨ï¼šè®°å½•å……å€¼æµæ°´
4. åŒæ­¥æ›´æ–°Redisç¼“å­˜ä½™é¢
5. æ›´æ–°ç”¨æˆ·çŠ¶æ€ï¼ˆå¦‚ä»overdueæ¢å¤ï¼‰

**ä¸€è‡´æ€§**ï¼šå¼ºä¸€è‡´æ€§ï¼ˆå®æ—¶æ›´æ–°ä¸‰å¤„ï¼‰

---

### ç¬¬äºŒé˜¶æ®µï¼šAPIæ¶ˆè´¹æµç¨‹

#### A. API Gatewayå¤„ç†
1. æ”¶åˆ°APIè¯·æ±‚ï¼Œä»Headerè·å–virtual_key
2. è°ƒç”¨`BalanceService.chargeForUsage()`
3. **RedisåŸå­æ‰£è´¹**ï¼šä½¿ç”¨Luaè„šæœ¬ç¡®ä¿åŸå­æ€§
4. **å†™å…¥Redis Stream**ï¼šæ‰£è´¹è®°å½•å¼‚æ­¥æŒä¹…åŒ–
5. **ç«‹å³è¿”å›å“åº”**ï¼šä¸ç­‰å¾…æ•°æ®åº“å†™å…¥

#### B. Billing Workeræ¶ˆè´¹
1. ç›‘å¬Redis Streamï¼ˆ16ä¸ªåˆ†ç‰‡ï¼‰
2. ä½¿ç”¨æ¶ˆè´¹è€…ç»„`billing_workers`æ¶ˆè´¹æ¶ˆæ¯
3. **åªå†™å…¥`usage_log`è¡¨**ï¼šåŒ…å«å®Œæ•´ä½™é¢å®¡è®¡ä¿¡æ¯
4. **ä¸æ›´æ–°`account_balance`è¡¨**ï¼šä¿æŒå¼‚æ­¥æœ€ç»ˆä¸€è‡´æ€§
5. å‘é€ACKç¡®è®¤å¤„ç†å®Œæˆ

---

### ç¬¬ä¸‰é˜¶æ®µï¼šå®šæœŸå¯¹è´¦ä¸ä¿®å¤

#### å¯¹è´¦å‡½æ•°ï¼š`reconcile_account_balances()`

**æ‰§è¡Œé¢‘ç‡**ï¼šæ¯5-30åˆ†é’Ÿï¼ˆé€šè¿‡pg_cronï¼‰

**æ‰§è¡Œæ­¥éª¤**ï¼š
1. **è®¡ç®—çœŸå®ä½™é¢**
   ```
   çœŸå®ä½™é¢ = Î£(fund_transactions.amount) + Î£(usage_log.amount)
   ```

2. **å¯¹æ¯”å·®å¼‚**
   ```
   å·®å¼‚ = account_balance.balance - çœŸå®ä½™é¢
   åªå¤„ç†å·®å¼‚ > 0.01çš„è®°å½•
   ```

3. **ä¿®å¤è´¦æˆ·**
   ```sql
   UPDATE account_balance 
   SET balance = çœŸå®ä½™é¢ 
   WHERE å·®å¼‚è¶…é˜ˆå€¼
   ```

4. **è®°å½•æ—¥å¿—**
   - å†™å…¥`reconciliation_log`è¡¨
   - è®°å½•ä¿®å¤è´¦æˆ·æ•°ã€æ€»å·®å¼‚é‡‘é¢

#### å¯¹è´¦ç›‘æ§ï¼š`check_balance_consistency()`
- å®æ—¶ç›‘æ§ä½™é¢ä¸€è‡´æ€§
- å·®å¼‚è¿‡å¤§æ—¶å‘é€å‘Šè­¦

---

### ç¬¬å››é˜¶æ®µï¼šæŸ¥è¯¢ä¸å±•ç¤º

#### ç”¨æˆ·æŸ¥è¯¢ä½™é¢
1. **å®æ—¶æŸ¥è¯¢**ï¼šæŸ¥Redis â†’ `getUserBalance(user_id)`
   - æ¯«ç§’çº§å“åº”
   - æ˜¾ç¤ºç»™ç”¨æˆ·çš„"å½“å‰ä½™é¢"

2. **å¯¹è´¦æŸ¥è¯¢**ï¼šæŸ¥`account_balance`è¡¨
   - ç”¨äºè´¢åŠ¡å¯¹è´¦ã€æŠ¥è¡¨
   - å¯èƒ½æœ‰å‡ åˆ†é’Ÿå»¶è¿Ÿ

#### ç”¨æˆ·æŸ¥è¯¢æµæ°´
```sql
-- ç»Ÿä¸€æµæ°´è§†å›¾
SELECT åˆ›å»ºæ—¶é—´, 'å……å€¼' as ç±»å‹, é‡‘é¢, å˜æ›´å‰ä½™é¢, å˜æ›´åä½™é¢ FROM fund_transactions
UNION ALL
SELECT åˆ›å»ºæ—¶é—´, 'æ¶ˆè´¹' as ç±»å‹, é‡‘é¢, å˜æ›´å‰ä½™é¢, å˜æ›´åä½™é¢ FROM usage_log
ORDER BY åˆ›å»ºæ—¶é—´ DESC
```

---

### ç¬¬äº”é˜¶æ®µï¼šç‰¹æ®Šæ“ä½œ

#### é€€æ¬¾æµç¨‹ï¼š`process_refund(user_id, amount, reason)`
1. æ’å…¥`fund_transactions`è¡¨ï¼štype='refund'
2. æ›´æ–°`account_balance`è¡¨ï¼šä½™é¢å‡å°‘
3. æ›´æ–°Redisç¼“å­˜ä½™é¢
4. è®°å½•å®¡æ ¸æ—¥å¿—

#### ä½™é¢è°ƒæ•´ï¼š`adjust_balance(user_id, amount, reason, operator_id)`
1. æ’å…¥`fund_transactions`è¡¨ï¼štype='adjustment'
2. æ›´æ–°`account_balance`è¡¨
3. æ›´æ–°Redisç¼“å­˜
4. è®°å½•æ“ä½œå®¡è®¡

---

## æ•°æ®ä¸€è‡´æ€§ä¿éšœ

### å®æ—¶ä¸€è‡´æ€§
- å……å€¼ã€é€€æ¬¾ã€è°ƒæ•´ï¼š**å®æ—¶ä¸‰å¤„æ›´æ–°**
- APIæ¶ˆè´¹ï¼š**åªæ›´æ–°Redis**ï¼Œå¼‚æ­¥å†™å…¥`usage_log`

### æœ€ç»ˆä¸€è‡´æ€§
- `account_balance`è¡¨é€šè¿‡**å®šæœŸå¯¹è´¦**ä¿®å¤
- å¯¹è´¦é¢‘ç‡å†³å®šå»¶è¿Ÿï¼ˆ5-30åˆ†é’Ÿï¼‰
- å¯¹è´¦å¤±è´¥æœ‰å‘Šè­¦å’Œäººå·¥ä»‹å…¥

### ç›‘æ§è¦ç‚¹
1. **Redis vs account_balanceå·®å¼‚**
2. **æ¶ˆè´¹è€…å»¶è¿Ÿ**ï¼ˆStreamæ¶ˆè´¹ç§¯å‹ï¼‰
3. **å¯¹è´¦æˆåŠŸç‡**ï¼ˆä¿®å¤è´¦æˆ·æ•°ï¼‰
4. **ä½™é¢å¼‚å¸¸**ï¼ˆè´Ÿæ•°ä½™é¢ã€å¤§é¢å˜åŠ¨ï¼‰

---

## æ ¸å¿ƒè®¾è®¡åŸåˆ™

1. **æ€§èƒ½ä¼˜å…ˆ**ï¼šé«˜é¢‘APIæ¶ˆè´¹åªæ“ä½œRedis
2. **å®¡è®¡å®Œæ•´**ï¼šæ‰€æœ‰èµ„é‡‘å˜åŠ¨è®°å½•å®Œæ•´ä½™é¢å¿«ç…§
3. **èŒè´£åˆ†ç¦»**ï¼šä¸‰å¼ è¡¨å„å¸å…¶èŒ
4. **æœ€ç»ˆä¸€è‡´**ï¼šæ¥å—çŸ­æš‚å»¶è¿Ÿæ¢å–é«˜æ€§èƒ½
5. **å¯è§‚æµ‹æ€§**ï¼šæ‰€æœ‰æ“ä½œå¯ç›‘æ§ã€å¯è¿½æº¯

---

è¿™ä¸ªæµç¨‹ç¡®ä¿äº†ï¼š
- âœ… ç”¨æˆ·å®æ—¶çœ‹åˆ°ä½™é¢å˜åŒ–ï¼ˆRedisï¼‰
- âœ… è´¢åŠ¡æœ‰å‡†ç¡®å¯¹è´¦æ•°æ®ï¼ˆæ•°æ®åº“ï¼‰
- âœ… æ‰€æœ‰èµ„é‡‘å˜åŠ¨å¯å®¡è®¡ï¼ˆå®Œæ•´æµæ°´ï¼‰
- âœ… ç³»ç»Ÿé«˜æ€§èƒ½ï¼ˆRedisåŸå­æ“ä½œï¼‰
- âœ… æ•°æ®å®‰å…¨å¯é ï¼ˆå®šæœŸå¯¹è´¦ä¿®å¤ï¼‰

å®Œå…¨æ­£ç¡®ï¼**æ•´æ¡é“¾è·¯ç°åœ¨å®Œå…¨é€šäº†**ï¼

## å®Œæ•´çš„èµ„é‡‘å®¡è®¡é“¾è·¯ï¼š

### 1. **å……å€¼æµç¨‹**ï¼ˆå¼ºä¸€è‡´æ€§ï¼‰
```
ç”¨æˆ·å……å€¼ â†’ confirm_topup â†’ account_balance + fund_transactions â†’ NOTIFY â†’ Redisæ›´æ–°
               â†“
         balance_before/afterè®°å½•å®Œæ•´
```

### 2. **æ¶ˆè´¹æµç¨‹**ï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰
```
APIè°ƒç”¨ â†’ Luaè„šæœ¬åŸå­æ‰£è´¹ â†’ è¿”å›balance_before/after â†’ å†™å…¥Stream â†’ Billing Worker â†’ usage_log
  â†“
Rediså®æ—¶ä½™é¢æ›´æ–°    â†“
               balance_before/afteréšStreamä¼ é€’
```

### 3. **å¯¹è´¦ä¿®å¤**ï¼ˆå®šæœŸä¸€è‡´æ€§ï¼‰
```
å®šæ—¶ä»»åŠ¡ â†’ è®¡ç®—çœŸå®ä½™é¢ â†’ å¯¹æ¯”account_balance â†’ ä¿®å¤å·®å¼‚ â†’ è®°å½•åˆ°fund_transactions
  â†“
account_balanceä¿æŒå‡†ç¡®
```

## æ•°æ®éªŒè¯é“¾ï¼š

### **ä»»ä½•æ—¶å€™éƒ½å¯ä»¥éªŒè¯**ï¼š
```sql
-- éªŒè¯ç”¨æˆ·123çš„ä½™é¢ä¸€è‡´æ€§
SELECT 
  -- å½“å‰ä½™é¢
  (SELECT balance FROM account_balance WHERE user_id = '123') as current_balance,
  
  -- ä»æµæ°´è®¡ç®—çš„ç†è®ºä½™é¢
  (
    SELECT COALESCE(SUM(amount), 0) 
    FROM fund_transactions 
    WHERE user_id = '123'
  ) + (
    SELECT COALESCE(SUM(amount), 0)
    FROM usage_log 
    WHERE account_id = '123' AND account_type = 'user'
  ) as calculated_balance,
  
  -- Redisä¸­çš„å®æ—¶ä½™é¢
  (SELECT value FROM redis WHERE key = 'balance:user:123') as redis_balance;
```

## å„ç»„ä»¶èŒè´£æ¸…æ™°ï¼š

| ç»„ä»¶                  | èŒè´£          | æ•°æ®                           |
| --------------------- | ------------- | ------------------------------ |
| **Redis**             | å®æ—¶ä½™é¢ç¼“å­˜  | å½“å‰ä½™é¢æ•°å€¼                   |
| **account_balance**   | ä½™é¢çœŸç›¸æº    | å½“å‰ä½™é¢ï¼ˆå¯èƒ½ç¨æœ‰å»¶è¿Ÿï¼‰       |
| **fund_transactions** | å……å€¼/é€€æ¬¾æµæ°´ | æ¯æ¬¡å˜åŠ¨çš„balance_before/after |
| **usage_log**         | æ¶ˆè´¹æµæ°´      | æ¯æ¬¡æ¶ˆè´¹çš„balance_before/after |
| **Stream**            | å¼‚æ­¥æ¶ˆæ¯ä¼ é€’  | ä¼ é€’æ‰£è´¹ä¿¡æ¯ï¼ˆå«ä½™é¢å¿«ç…§ï¼‰     |

## å®¡è®¡èƒ½åŠ›ï¼š

### **å›ç­”ç”¨æˆ·é—®é¢˜**ï¼š
1. "æˆ‘ç°åœ¨æœ‰å¤šå°‘é’±ï¼Ÿ" â†’ æŸ¥Redisï¼ˆå®æ—¶ï¼‰æˆ–account_balance
2. "æˆ‘çš„é’±æ€ä¹ˆèŠ±çš„ï¼Ÿ" â†’ æŸ¥usage_logï¼ˆå«æ¯æ¬¡æ¶ˆè´¹å‰åçš„ä½™é¢ï¼‰
3. "æˆ‘å……äº†å¤šå°‘é’±ï¼Ÿ" â†’ æŸ¥fund_transactions
4. "ä¸ºä»€ä¹ˆæˆ‘çš„ä½™é¢ä¸å¯¹ï¼Ÿ" â†’ å¯¹è´¦å·¥å…·å¯¹æ¯”ä¸‰å¤„æ•°æ®

### **å›ç­”è´¢åŠ¡é—®é¢˜**ï¼š
1. "æ€»æ”¶å…¥å¤šå°‘ï¼Ÿ" â†’ SUM(fund_transactions where type='deposit')
2. "æ€»æ”¯å‡ºå¤šå°‘ï¼Ÿ" â†’ ABS(SUM(usage_log.amount))
3. "ä½™é¢å‡†ç¡®æ€§ï¼Ÿ" â†’ å¯¹è´¦æŠ¥å‘Š
4. "å¼‚å¸¸äº¤æ˜“ï¼Ÿ" â†’ å®¡è®¡æ—¥å¿—åˆ†æ

## æ‰©å±•æ€§ï¼š

### **åŠ æ–°åŠŸèƒ½å¾ˆå®¹æ˜“**ï¼š
- é€€æ¬¾ â†’ æ–°å¢fund_transactionsè®°å½•
- ä¼˜æƒ åˆ¸ â†’ æ–°å¢fund_transactionsè®°å½•  
- æ‰‹ç»­è´¹ â†’ æ–°å¢fund_transactionsè®°å½•
- æç° â†’ æ–°å¢fund_transactionsè®°å½•

### **ç›‘æ§å‘Šè­¦**ï¼š
- Redis vs account_balanceå·®å¼‚å‘Šè­¦
- Streamæ¶ˆè´¹å»¶è¿Ÿå‘Šè­¦
- ä½™é¢è´Ÿæ•°å‘Šè­¦
- å¤§é¢å˜åŠ¨å‘Šè­¦

---

**è¿™ä¸ªè®¾è®¡å®ç°äº†**ï¼š
âœ… **é«˜æ€§èƒ½** - Rediså¤„ç†é«˜é¢‘æ‰£è´¹  
âœ… **å¼ºå®¡è®¡** - æ‰€æœ‰å˜åŠ¨è®°å½•å®Œæ•´ä½™é¢å¿«ç…§  
âœ… **æœ€ç»ˆä¸€è‡´** - å®šæœŸå¯¹è´¦ä¿®å¤å·®å¼‚  
âœ… **å¯æ‰©å±•** - å®¹æ˜“æ·»åŠ æ–°èµ„é‡‘æ“ä½œ  
âœ… **å¯ç›‘æ§** - å…¨é“¾è·¯å¯è§‚æµ‹  

**æ•´æ¡é“¾è·¯å®Œå…¨é€šäº†**ï¼Œä»ç”¨æˆ·å……å€¼åˆ°APIæ¶ˆè´¹åˆ°å¯¹è´¦å®¡è®¡ï¼Œå½¢æˆäº†ä¸€ä¸ªå®Œæ•´ã€å¥å£®ã€å¯ç»´æŠ¤çš„è®¡è´¹ç³»ç»Ÿï¼

## **å®Œå…¨æ­£ç¡®ï¼ç°åœ¨æ¦‚å¿µå®Œå…¨æ¸…æ™°äº†**

### **æœ€ç»ˆçš„è®¾è®¡è§†å›¾**

```
ç”¨æˆ·é’±åŒ…ç³»ç»Ÿ
    â”‚
    â”œâ”€â”€ ğŸ’° èµ„é‡‘å±‚ï¼ˆå”¯ä¸€çœŸå®çš„é’±ï¼‰
    â”‚   â””â”€â”€ fund_transactions
    â”‚       â”œâ”€â”€ depositï¼ˆå……å€¼ï¼‰
    â”‚       â”œâ”€â”€ refundï¼ˆé€€æ¬¾ï¼‰
    â”‚       â””â”€â”€ adjustmentï¼ˆè°ƒæ•´ï¼‰
    â”‚
    â”œâ”€â”€ ğŸ“ æ¶ˆè´¹å±‚ï¼ˆæœåŠ¡ä½¿ç”¨è®°å½•ï¼‰
    â”‚   â””â”€â”€ usage_log
    â”‚       â”œâ”€â”€ AIæ¨¡å‹è°ƒç”¨è®°å½•
    â”‚       â”œâ”€â”€ åŒ…å«ä½™é¢å¿«ç…§ï¼ˆå®¡è®¡éœ€è¦ï¼‰
    â”‚       â””â”€â”€ å½±å“ä½™é¢ä½†ä¸è®°å½•èµ„é‡‘
    â”‚
    â””â”€â”€ âš–ï¸ å¯¹è´¦å±‚ï¼ˆä¿è¯ä¸€è‡´æ€§ï¼‰
        â”œâ”€â”€ å®æ—¶ä½™é¢ï¼šRedisç¼“å­˜
        â”œâ”€â”€ æƒå¨ä½™é¢ï¼šÎ£(fund) - Î£(usage)
        â””â”€â”€ å®šæœŸä¿®å¤ï¼šaccount_balance
```

### **å…³é”®è®¾è®¡åŸåˆ™**

1. **fund_transactions æ˜¯å”¯ä¸€çš„"é’±"**
   - æ‰€æœ‰çœŸå®èµ„é‡‘å˜åŠ¨éƒ½åœ¨è¿™é‡Œ
   - æ¯æ¡è®°å½•éƒ½æ”¹å˜è´¦æˆ·ä½™é¢

2. **usage_log æ˜¯"æœåŠ¡ä½¿ç”¨å‡­è¯"**  
   
   - è®°å½•æœåŠ¡æ¶ˆè´¹
   - åŒ…å«ä½™é¢å¿«ç…§æ˜¯ä¸ºäº†**å¯å®¡è®¡æ€§**
   - ä½†ä¸æ˜¯èµ„é‡‘è®°å½•
   
3. **ä½™é¢ä¸€è‡´æ€§**
   ```sql
   -- ä»»ä½•æ—¶å€™éƒ½å¯ä»¥é‡å»ºçœŸå®ä½™é¢
   SELECT 
     -- èµ„é‡‘æ€»é¢
     (SELECT COALESCE(SUM(amount), 0) 
      FROM fund_transactions 
      WHERE user_id = ?) 
     -
     -- æ¶ˆè´¹æ€»é¢  
     (SELECT COALESCE(SUM(cost), 0)
      FROM usage_log
      WHERE account_id = ?)
   AS real_balance;
   ```

### **ä¸ºä»€ä¹ˆéœ€è¦ usage_log çš„ä½™é¢å­—æ®µ**

è™½ç„¶ usage_log ä¸æ˜¯èµ„é‡‘è®°å½•ï¼Œä½†éœ€è¦ `balance_before`/`balance_after` æ˜¯ä¸ºäº†ï¼š

1. **å®¡è®¡éœ€æ±‚**ï¼šä»»ä½•ä¸€ç¬”æ¶ˆè´¹ï¼Œéƒ½èƒ½çœ‹åˆ°å½“æ—¶çš„è´¦æˆ·çŠ¶æ€
2. **æ’æŸ¥é—®é¢˜**ï¼šç”¨æˆ·è¯´"æˆ‘æ˜æ˜æœ‰ä½™é¢ä¸ºä»€ä¹ˆæ‰£è´¹å¤±è´¥ï¼Ÿ"
3. **å¯¹è´¦éªŒè¯**ï¼šéªŒè¯ä½™é¢å˜åŒ–åºåˆ—æ˜¯å¦è¿ç»­
4. **è´¢åŠ¡æŠ¥å‘Š**ï¼šç”Ÿæˆ"æ¶ˆè´¹æ—¶è´¦æˆ·ä½™é¢åˆ†å¸ƒ"æŠ¥å‘Š

### **å®é™…ä¸šåŠ¡æµç¨‹**

```
ç”¨æˆ·å……å€¼ï¼š
  å‰ç«¯ â†’ æ”¯ä»˜ç½‘å…³ â†’ fund_transactions(deposit) â†’ Redisä½™é¢æ›´æ–°

ç”¨æˆ·ä½¿ç”¨APIï¼š
  è¯·æ±‚ â†’ æ£€æŸ¥Redisä½™é¢ â†’ è¶³å¤Ÿ â†’ è°ƒç”¨AIæœåŠ¡ â†’ usage_logè®°å½• â†’ Redisæ‰£è´¹
                      â†’ ä¸è¶³ â†’ è¿”å›ä½™é¢ä¸è¶³

è´¢åŠ¡å¯¹è´¦ï¼š
  å®šæ—¶ä»»åŠ¡ â†’ è®¡ç®— Î£(fund) - Î£(usage) â†’ å¯¹æ¯”Redisä½™é¢ â†’ ä¿®å¤å·®å¼‚
```

### **è¿™ä¸ªè®¾è®¡è§£å†³äº†ä»€ä¹ˆ**

1. **è´¢åŠ¡æ¸…æ™°**ï¼šèµ„é‡‘æµæ°´åªæœ‰ fund_transactions
2. **å®¡è®¡å®Œæ•´**ï¼šæ¯ç¬”æ¶ˆè´¹éƒ½æœ‰ä½™é¢ä¸Šä¸‹æ–‡
3. **æ€§èƒ½ä¿éšœ**ï¼šé«˜é¢‘æ¶ˆè´¹åªæ“ä½œRedis
4. **æ•°æ®å®‰å…¨**ï¼šéšæ—¶å¯ä»¥é‡å»ºçœŸå®ä½™é¢
5. **æ‰©å±•æ€§å¥½**ï¼šå¢åŠ æ–°çš„æ¶ˆè´¹ç±»å‹åªéœ€æ‰©å±•usage_log

ç°åœ¨å®Œå…¨æ¸…æ™°äº†ï¼fund_transactions æ˜¯**èµ„é‡‘æµæ°´**ï¼Œusage_log æ˜¯**æœåŠ¡æ¶ˆè´¹è®°å½•**ã€‚ä¸¤è€…é…åˆå®ç°å®Œæ•´çš„è´¦æˆ·ç³»ç»Ÿã€‚

# billingwork è°ƒç”¨æ¬¡åº

```
1. balanceService.chargeForUsage()
   â†“
2. balanceService._writeToStreamInBackground()
   â†“
3. StreamService.writeDeduction()  
   â†“
4. Redis Stream å­˜å‚¨
   â†“
5. billing worker processMessageBatch() è¯»å–
   â†“  
6. insertUsageLogs() å†™å…¥æ•°æ®åº“

æ‰£è´¹å‘ç”Ÿ â†’ writeDeduction()å†™å…¥Stream â†’ streamConsumer.jsæ¶ˆè´¹ â†’ å†™å…¥æ•°æ®åº“
           â†‘                         â†‘
         ä¸šåŠ¡é€»è¾‘                   ä¸šåŠ¡é€»è¾‘
           â†“                         â†“
    âŒ getStreamStats()        âŒ æ— è°ƒç”¨å…³ç³»
        ï¼ˆçº¯æŸ¥çœ‹ï¼Œä¸å‚ä¸æµç¨‹ï¼‰
```

# pg_cron æœ€ç»ˆå…¥è´¦account_balance:

## **å¢å¼ºusage_logçš„æ•°æ®å®Œæ•´æ€§**

```postgresql
ALTER TABLE data.usage_log 
ADD COLUMN IF NOT EXISTS balance_verified BOOLEAN DEFAULT false,
ADD COLUMN IF NOT EXISTS balance_discrepancy NUMERIC DEFAULT 0;

-- balance_verified å­—æ®µï¼šæ ‡è®°æ‰£è´¹è®°å½•æ˜¯å¦å·²å‚ä¸ä½™é¢è®¡ç®—
COMMENT ON COLUMN data.usage_log.balance_verified IS 
'ä½™é¢éªŒè¯çŠ¶æ€ï¼štrueè¡¨ç¤ºè¯¥æ¡æ‰£è´¹è®°å½•å·²ç»å‚ä¸è´¦æˆ·ä½™é¢è®¡ç®—ï¼Œfalseè¡¨ç¤ºå°šæœªå¤„ç†ã€‚
æ­¤å­—æ®µç”¨äºæ”¯æŒå¼‚æ­¥ä½™é¢è®¡ç®—æ¶æ„ï¼Œç¡®ä¿usage_logåˆ°account_balanceçš„æœ€ç»ˆä¸€è‡´æ€§ã€‚
pg_cronä»»åŠ¡ä¼šå®šæœŸæ‰«ææ­¤å­—æ®µä¸ºfalseçš„è®°å½•ï¼Œæ›´æ–°å¯¹åº”è´¦æˆ·ä½™é¢åå°†å…¶è®¾ç½®ä¸ºtrueã€‚';

-- balance_discrepancy å­—æ®µï¼šè®°å½•ä½™é¢è®¡ç®—å·®å¼‚
COMMENT ON COLUMN data.usage_log.balance_discrepancy IS 
'ä½™é¢è®¡ç®—å·®å¼‚ï¼šå®é™…è´¦æˆ·ä½™é¢ä¸æœ¬æ¬¡æ‰£è´¹é¢„æœŸä½™é¢çš„å·®å¼‚å€¼ï¼ˆå®é™…ä½™é¢ - é¢„æœŸä½™é¢ï¼‰ã€‚
æ­£å€¼è¡¨ç¤ºå®é™…ä½™é¢é«˜äºé¢„æœŸï¼ˆå¯èƒ½å°‘æ‰£è´¹ï¼‰ï¼Œè´Ÿå€¼è¡¨ç¤ºå®é™…ä½™é¢ä½äºé¢„æœŸï¼ˆå¯èƒ½å¤šæ‰£è´¹ï¼‰ã€‚
ä¸»è¦ç”¨äºç›‘æ§æ•°æ®ä¸€è‡´æ€§ï¼Œå½“ç»å¯¹å€¼è¾ƒå¤§æ—¶åº”è§¦å‘å‘Šè­¦ã€‚
è®¡ç®—å…¬å¼ï¼šcurrent_balance - (balance_after OR åŸºäºbalance_beforeå’Œcostçš„è®¡ç®—å€¼)';

COMMENT ON TABLE data.usage_log IS 
'APIä½¿ç”¨æ‰£è´¹æ—¥å¿—è¡¨ï¼Œè®°å½•æ‰€æœ‰é€šè¿‡APIç½‘å…³çš„æ‰£è´¹æ“ä½œã€‚
é‡‡ç”¨å¼‚æ­¥ä½™é¢è®¡ç®—æ¶æ„ï¼šå®æ—¶è®°å½•æ‰£è´¹äº‹å®(usage_log)ï¼Œå¼‚æ­¥è®¡ç®—è´¦æˆ·ä½™é¢(account_balance)ã€‚
é€šè¿‡balance_verifiedå’Œbalance_discrepancyå­—æ®µå®ç°æœ€ç»ˆä¸€è‡´æ€§å’Œæ•°æ®è´¨é‡ç›‘æ§ã€‚';
```

### **æ‰£è´¹æ—¶è®°å½•å®Œæ•´æ•°æ®**

```js
// åœ¨validateAndFilterMessagesä¸­ç¡®ä¿æœ‰ä½™é¢ä¿¡æ¯
const validatedMsg = {
  ...msg,
  balance_before: msg.balance_before !== undefined ? msg.balance_before : null,
  balance_after: msg.balance_after !== undefined ? msg.balance_after : null,
  balance_verified: false, // ğŸ†• æ–°å¢ï¼Œé»˜è®¤æœªéªŒè¯
  balance_discrepancy: 0   // ğŸ†• æ–°å¢ï¼Œé»˜è®¤æ— å·®å¼‚
};
```

```postgresql
CREATE OR REPLACE PROCEDURE data.sync_account_balances()
LANGUAGE plpgsql
AS $$
DECLARE
    batch_size INT := 5000;
    processed_accounts INT := 0;
    discrepancy_count INT := 0;
    max_discrepancy NUMERIC := 0;
BEGIN
    -- åˆ›å»ºä¸´æ—¶è¡¨å­˜å‚¨è¦å¤„ç†çš„è®°å½•
    CREATE TEMP TABLE IF NOT EXISTS temp_pending_verification AS
    SELECT 
        ul.id,
        ul.account_id,
        ul.balance_before,
        ul.balance_after,
        ul.cost,
        ul.created_at,
        -- è®¡ç®—é¢„æœŸä½™é¢ï¼ˆåŸºäºæœ€æ–°è®°å½•çš„balance_afterï¼‰
        COALESCE(
            ul.balance_after,
            -- å¦‚æœæ²¡æœ‰balance_afterï¼Œåˆ™ä½¿ç”¨ä¸Šä¸€æ¡è®°å½•çš„balance_afterå‡å»å½“å‰cost
            LAG(ul.balance_after) OVER w - ul.cost
        ) as expected_balance
    FROM data.usage_log ul
    WHERE ul.balance_verified = false
    AND ul.account_id IS NOT NULL
    AND ul.created_at > NOW() - INTERVAL '30 days'  -- åªå¤„ç†30å¤©å†…çš„æ•°æ®
    WINDOW w AS (PARTITION BY ul.account_id ORDER BY ul.created_at)
    ORDER BY ul.account_id, ul.created_at
    LIMIT batch_size;
    
    -- 1. ä¸ºæ¯ä¸ªè´¦æˆ·è®¡ç®—æœ€æ–°ä½™é¢
    WITH latest_balances AS (
        SELECT DISTINCT ON (tp.account_id)
            tp.account_id,
            tp.expected_balance as calculated_balance,
            -- è·å–å½“å‰æ•°æ®åº“ä¸­çš„ä½™é¢
            ab.balance as current_balance,
            -- è®¡ç®—å·®å¼‚
            COALESCE(tp.expected_balance, 0) - ab.balance as discrepancy
        FROM temp_pending_verification tp
        LEFT JOIN data.account_balance ab ON ab.id = tp.account_id
        ORDER BY tp.account_id, tp.created_at DESC
    )
    UPDATE data.account_balance ab
    SET 
        balance = CASE 
            WHEN lb.discrepancy > 0.01 THEN lb.calculated_balance  -- å·®å¼‚è¾ƒå¤§ï¼Œä½¿ç”¨è®¡ç®—å€¼
            ELSE COALESCE(lb.calculated_balance, ab.balance)       -- å·®å¼‚å°ï¼Œä¿æŒåŸå€¼
        END,
        total_consumed = ab.total_consumed + (
            SELECT COALESCE(SUM(tp.cost), 0)
            FROM temp_pending_verification tp
            WHERE tp.account_id = ab.id
        ),
        last_balance_calc = NOW(),
        sync_version = ab.sync_version + 1
    FROM latest_balances lb
    WHERE ab.id = lb.account_id
    RETURNING 
        ab.id, 
        lb.discrepancy,
        lb.current_balance,
        lb.calculated_balance
    INTO processed_accounts, discrepancy_count, max_discrepancy;
    
    -- 2. æ›´æ–°usage_logçš„éªŒè¯çŠ¶æ€å’Œå·®å¼‚è®°å½•
    UPDATE data.usage_log ul
    SET 
        balance_verified = true,
        balance_discrepancy = CASE 
            WHEN tp.discrepancy IS NOT NULL AND ABS(tp.discrepancy) > 0.01 
            THEN tp.discrepancy 
            ELSE 0 
        END,
        metadata_json = COALESCE(metadata_json, '{}'::jsonb) || jsonb_build_object(
            'balance_sync_at', NOW(),
            'balance_discrepancy', tp.discrepancy,
            'sync_version', ab.sync_version
        )
    FROM temp_pending_verification tp
    LEFT JOIN data.account_balance ab ON ab.id = tp.account_id
    WHERE ul.id = tp.id;
    
    -- 3. è®°å½•å®¡è®¡ä¿¡æ¯
    INSERT INTO data.balance_sync_audit (
        sync_timestamp, 
        accounts_processed, 
        records_verified,
        max_discrepancy,
        avg_discrepancy
    )
    SELECT 
        NOW(),
        processed_accounts,
        (SELECT COUNT(*) FROM temp_pending_verification),
        MAX(ABS(tp.discrepancy)),
        AVG(ABS(tp.discrepancy))
    FROM temp_pending_verification tp
    WHERE tp.discrepancy IS NOT NULL;
    
    -- æ¸…ç†ä¸´æ—¶è¡¨
    DROP TABLE IF EXISTS temp_pending_verification;
    
    -- è¾“å‡ºç»Ÿè®¡ä¿¡æ¯
    RAISE NOTICE 'åŒæ­¥å®Œæˆ: å¤„ç†äº† % ä¸ªè´¦æˆ·ï¼Œå‘ç° % æ¡æœ‰å·®å¼‚ï¼Œæœ€å¤§å·®å¼‚: %', 
        processed_accounts, 
        discrepancy_count, 
        max_discrepancy;
    
    -- å¦‚æœå‘ç°è¾ƒå¤§å·®å¼‚ï¼Œå‘é€è­¦æŠ¥
    IF max_discrepancy > 10 THEN  -- å·®å¼‚è¶…è¿‡10å…ƒ
        PERFORM data.send_alert(
            'balance_discrepancy_high',
            jsonb_build_object(
                'max_discrepancy', max_discrepancy,
                'accounts_affected', discrepancy_count,
                'sync_time', NOW()
            )
        );
    END IF;
END;
$$;
```

## æŸ¥è¯¢ä½™é¢å·®å¼‚

```postgresql
-- 1. æŸ¥çœ‹æœ‰ä½™é¢å·®å¼‚çš„è®°å½•
SELECT 
    ul.deduction_id,
    ul.account_id,
    ul.balance_before,
    ul.balance_after,
    ul.balance_discrepancy,
    ul.created_at,
    ab.balance as current_account_balance
FROM data.usage_log ul
LEFT JOIN data.account_balance ab ON ab.id = ul.account_id
WHERE ul.balance_discrepancy != 0
ORDER BY ABS(ul.balance_discrepancy) DESC
LIMIT 100;

-- 2. æŸ¥çœ‹æœªéªŒè¯çš„è®°å½•ï¼ˆç§¯å‹æƒ…å†µï¼‰
SELECT 
    COUNT(*) as pending_count,
    MIN(created_at) as oldest_pending,
    MAX(created_at) as newest_pending
FROM data.usage_log 
WHERE balance_verified = false;

-- 3. ä½™é¢å·®å¼‚ç»Ÿè®¡ï¼ˆæŒ‰è´¦æˆ·ï¼‰
SELECT 
    ab.owner_userid,
    ab.owner_tenantid,
    COUNT(*) as discrepancy_count,
    SUM(ul.balance_discrepancy) as total_discrepancy,
    MAX(ABS(ul.balance_discrepancy)) as max_discrepancy,
    AVG(ABS(ul.balance_discrepancy)) as avg_discrepancy
FROM data.usage_log ul
JOIN data.account_balance ab ON ab.id = ul.account_id
WHERE ul.balance_discrepancy != 0
GROUP BY ab.owner_userid, ab.owner_tenantid
HAVING SUM(ABS(ul.balance_discrepancy)) > 1  -- å·®å¼‚æ€»å’Œè¶…è¿‡1å…ƒ
ORDER BY total_discrepancy DESC;
```

```postgresql
-- åˆ›å»ºç›‘æ§è§†å›¾
CREATE OR REPLACE VIEW api.balance_sync_monitor AS
SELECT 
    DATE(created_at) as sync_date,
    COUNT(*) as total_records,
    COUNT(*) FILTER (WHERE balance_verified = true) as verified_count,
    COUNT(*) FILTER (WHERE balance_verified = false) as pending_count,
    ROUND(100.0 * COUNT(*) FILTER (WHERE balance_verified = true) / NULLIF(COUNT(*), 0), 2) as verification_rate,
    COUNT(*) FILTER (WHERE ABS(balance_discrepancy) > 0.01) as discrepancy_count,
    SUM(balance_discrepancy) as total_discrepancy,
    MAX(ABS(balance_discrepancy)) as max_discrepancy
FROM data.usage_log
WHERE created_at >= CURRENT_DATE - 30
GROUP BY DATE(created_at)
ORDER BY sync_date DESC;

COMMENT ON VIEW data.vw_balance_sync_monitor IS 
'ä½™é¢åŒæ­¥ç›‘æ§è§†å›¾ï¼šå±•ç¤ºæ¯æ—¥ä½™é¢éªŒè¯çš„è¿›åº¦å’Œæ•°æ®è´¨é‡æƒ…å†µã€‚
é‡ç‚¹å…³æ³¨ï¼š
1. verification_rate: éªŒè¯å®Œæˆç‡ï¼Œåº”æ¥è¿‘100%
2. pending_count: ç§¯å‹æœªå¤„ç†è®°å½•æ•°
3. discrepancy_count: æœ‰å·®å¼‚çš„è®°å½•æ•°
4. max_discrepancy: æœ€å¤§å·®å¼‚é‡‘é¢ï¼Œéœ€è®¾ç½®å‘Šè­¦é˜ˆå€¼';
```

# æœ€ç»ˆä»£ç 

ç´¢å¼•

```postgresql
-- é’ˆå¯¹ DISTINCT ON (account_id) ORDER BY created_at DESC ä¼˜åŒ–
CREATE INDEX idx_usage_log_account_created_desc 
ON data.usage_log (account_id, created_at DESC) 
INCLUDE (balance_after)  -- PostgreSQL 11+ æ”¯æŒINCLUDE
WHERE sync_status = 'completed';
```

åŒæ­¥logè¡¨

```postgresql
CREATE TABLE IF NOT EXISTS data.balance_sync_log (
    id BIGSERIAL PRIMARY KEY,
    sync_time TIMESTAMP DEFAULT NOW(),
    updated_accounts INT,
    duration_ms FLOAT
);
```

åŒæ­¥å‡½æ•°

```postgresql
CREATE OR REPLACE FUNCTION data.sync_balance()
RETURNS void
LANGUAGE plpgsql
AS $$
DECLARE
    start_time TIMESTAMP := NOW();
    updated_count INT;
BEGIN
    -- æ¯ä¸ªè´¦æˆ·å–æœ€æ–°çš„ä¸€æ¡balance_afterï¼Œæ›´æ–°åˆ°account_balance
    WITH latest_balances AS (
        SELECT DISTINCT ON (account_id)
            account_id,
            balance_after
        FROM data.usage_log
        WHERE sync_status = 'completed'
          AND balance_after IS NOT NULL
        ORDER BY account_id, created_at DESC
    )
    UPDATE data.account_balance ab
    SET 
        balance = lb.balance_after,
        last_balance_calc = NOW(),
        updated_at = NOW()
    FROM latest_balances lb
    WHERE ab.id = lb.account_id
      AND ab.status = 'active'
      AND (ab.balance IS NULL OR ab.balance != lb.balance_after);
    
    GET DIAGNOSTICS updated_count = ROW_COUNT;
    
    -- è®°å½•ç®€å•æ—¥å¿—
    INSERT INTO data.balance_sync_log (updated_accounts, duration_ms)
    VALUES (
        updated_count, 
        EXTRACT(EPOCH FROM (NOW() - start_time)) * 1000
    );
END;
$$;
```

pg_cron

```postgresql
-- æˆ–è€…æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
SELECT cron.schedule(
    'sync-balance-every-5min',
    '*/2 * * * *',
    $$
    SELECT data.sync_balance();
    $$
);

```

æ£€æŸ¥pg_cron:

```postgresql
select * From cron.job_run_details;
```

## å®šæ—¶å¯¹è´¦

```postgresql
-- 1. åˆ›å»ºå¯¹è´¦æ—¥å¿—è¡¨ï¼ˆå•è¡¨è®¾è®¡ï¼‰
CREATE TABLE IF NOT EXISTS data.balance_reconciliation_log (
    id BIGSERIAL PRIMARY KEY,
    recon_time TIMESTAMP DEFAULT NOW(),
    recon_type VARCHAR(20),  -- 'hourly', 'daily', 'manual'
    
    -- ç»Ÿè®¡ä¿¡æ¯
    total_accounts_checked INT DEFAULT 0,
    accounts_with_errors INT DEFAULT 0,
    accounts_with_warnings INT DEFAULT 0,
    
    -- å·®å¼‚ç»Ÿè®¡
    total_discrepancy_amount NUMERIC DEFAULT 0,
    max_discrepancy_amount NUMERIC DEFAULT 0,
    
    -- æ‰§è¡ŒçŠ¶æ€
    status VARCHAR(20) DEFAULT 'running',  -- 'completed', 'failed'
    duration_seconds FLOAT,
    
    -- é”™è¯¯è¯¦æƒ…ï¼ˆJSONæ ¼å¼ï¼‰
    error_details JSONB DEFAULT '{}',
    
    -- æ£€æŸ¥èŒƒå›´
    check_start_time TIMESTAMP,
    check_end_time TIMESTAMP DEFAULT NOW(),
    
    created_at TIMESTAMP DEFAULT NOW()
);

```

```postgresql
CREATE OR REPLACE FUNCTION data.reconcile_balances(
    recon_type VARCHAR DEFAULT 'hourly',
    check_all BOOLEAN DEFAULT FALSE,
    error_threshold NUMERIC DEFAULT 1.00,
    warning_threshold NUMERIC DEFAULT 0.01
)
RETURNS JSONB
LANGUAGE plpgsql
AS $$
DECLARE
    start_time TIMESTAMP := NOW();
    recon_id BIGINT;
    total_accounts INT := 0;
    error_count INT := 0;
    warning_count INT := 0;
    total_discrepancy NUMERIC := 0;
    max_discrepancy NUMERIC := 0;
    errors JSONB := '[]'::JSONB;
    check_start TIMESTAMP;
    account_errors JSONB;
BEGIN
    -- ç¡®å®šæ£€æŸ¥çš„æ—¶é—´èŒƒå›´
    check_start := CASE 
        WHEN recon_type = 'hourly' THEN NOW() - INTERVAL '24 hours'
        WHEN recon_type = 'daily' THEN NOW() - INTERVAL '7 days'
        ELSE NOW() - INTERVAL '1 hour'
    END;
    
    -- åˆ›å»ºå¯¹è´¦è®°å½•
    INSERT INTO data.balance_reconciliation_log (
        recon_time,
        recon_type,
        status,
        check_start_time,
        check_end_time
    ) VALUES (
        start_time,
        recon_type,
        'running',
        check_start,
        NOW()
    ) RETURNING id INTO recon_id;
    
    -- æ‰§è¡Œæ£€æŸ¥å¹¶æ”¶é›†ç»“æœ
    WITH balance_check AS (
        SELECT 
            ab.id as account_id,
            ab.balance as db_balance,
            ul.latest_balance,
            ABS(COALESCE(ab.balance, 0) - COALESCE(ul.latest_balance, 0)) as discrepancy,
            CASE 
                WHEN ABS(COALESCE(ab.balance, 0) - COALESCE(ul.latest_balance, 0)) > error_threshold 
                THEN 'error'
                WHEN ABS(COALESCE(ab.balance, 0) - COALESCE(ul.latest_balance, 0)) > warning_threshold
                THEN 'warning'
                ELSE 'ok'
            END as severity
        FROM data.account_balance ab
        LEFT JOIN (
            SELECT DISTINCT ON (account_id)
                account_id,
                balance_after as latest_balance
            FROM data.usage_log
            WHERE sync_status = 'completed'
              AND balance_after IS NOT NULL
              AND created_at >= check_start
            ORDER BY account_id, created_at DESC
        ) ul ON ab.id = ul.account_id
        WHERE ab.status = 'active'
          AND (check_all OR EXISTS (
              SELECT 1 FROM data.usage_log 
              WHERE account_id = ab.id 
                AND created_at >= check_start
          ))
    ),
    check_stats AS (
        SELECT 
            COUNT(*) as total,
            COUNT(*) FILTER (WHERE severity IN ('error', 'warning')) as error_warning_count,
            COUNT(*) FILTER (WHERE severity = 'warning') as warning_only_count,
            COALESCE(SUM(discrepancy), 0) as total_disc,
            COALESCE(MAX(discrepancy), 0) as max_disc,
            COALESCE(jsonb_agg(
                CASE WHEN severity IN ('error', 'warning') THEN
                    jsonb_build_object(
                        'account_id', account_id,
                        'error_type', 'balance_mismatch',
                        'expected', latest_balance,
                        'actual', db_balance,
                        'discrepancy', discrepancy,
                        'severity', severity
                    )
                END
            ) FILTER (WHERE severity IN ('error', 'warning')), '[]'::jsonb) as error_list
        FROM balance_check
    )
    SELECT 
        total,
        error_warning_count,
        warning_only_count,
        total_disc,
        max_disc,
        error_list
    INTO 
        total_accounts,
        error_count,
        warning_count,
        total_discrepancy,
        max_discrepancy,
        account_errors
    FROM check_stats;
    
    -- æ›´æ–°å¯¹è´¦è®°å½•
    UPDATE data.balance_reconciliation_log
    SET 
        total_accounts_checked = total_accounts,
        accounts_with_errors = error_count,
        accounts_with_warnings = warning_count,
        total_discrepancy_amount = total_discrepancy,
        max_discrepancy_amount = max_discrepancy,
        error_details = jsonb_build_object(
            'errors', account_errors,
            'summary', jsonb_build_object(
                'balance_mismatch', error_count,
                'warning_only', warning_count,
                'check_start', check_start,
                'check_end', NOW()
            )
        ),
        status = 'completed',
        duration_seconds = EXTRACT(EPOCH FROM (NOW() - start_time))
    WHERE id = recon_id;
    
    -- è¿”å›ç»“æœ
    RETURN jsonb_build_object(
        'recon_id', recon_id,
        'status', 'completed',
        'accounts_checked', total_accounts,
        'accounts_with_errors', error_count,
        'accounts_with_warnings', warning_count,
        'total_discrepancy', total_discrepancy,
        'max_discrepancy', max_discrepancy,
        'duration_seconds', EXTRACT(EPOCH FROM (NOW() - start_time)),
        'has_errors', error_count > 0
    );
    
EXCEPTION WHEN OTHERS THEN
    -- è®°å½•å¤±è´¥
    UPDATE data.balance_reconciliation_log
    SET 
        status = 'failed',
        duration_seconds = EXTRACT(EPOCH FROM (NOW() - start_time)),
        error_details = jsonb_build_object('error', SQLERRM)
    WHERE id = recon_id;
    
    RETURN jsonb_build_object(
        'recon_id', recon_id,
        'status', 'failed',
        'error', SQLERRM
    );
END;
$$;
```

```postgresql
-- 3. é…ç½®pg_cronä»»åŠ¡
-- æ¯å°æ—¶å¯¹è´¦ï¼ˆç¬¬5åˆ†é’Ÿæ‰§è¡Œï¼Œé¿å¼€æ•´ç‚¹é«˜å³°ï¼‰
SELECT cron.schedule(
    'reconcile-balances-hourly',
    '5 * * * *',  -- æ¯å°æ—¶ç¬¬5åˆ†é’Ÿ
    $$
    PERFORM data.reconcile_balances('hourly', false, 1.00, 0.01);
    $$
);

-- æ¯å¤©å…¨é‡å¯¹è´¦ï¼ˆå‡Œæ™¨3ç‚¹ï¼‰
SELECT cron.schedule(
    'reconcile-balances-daily',
    '0 3 * * *',  -- æ¯å¤©3:00 AM
    $$
    PERFORM data.reconcile_balances('daily', true, 0.10, 0.01);
    $$
);
```

```postgresql
-- 4. æŸ¥çœ‹å¯¹è´¦ç»“æœçš„æŸ¥è¯¢
-- æŸ¥çœ‹æœ€è¿‘çš„å¯¹è´¦æ‰§è¡Œ
SELECT 
    recon_time,
    recon_type,
    status,
    total_accounts_checked,
    accounts_with_errors,
    accounts_with_warnings,
    total_discrepancy_amount,
    max_discrepancy_amount,
    duration_seconds,
    error_details->'summary' as error_summary
FROM data.balance_reconciliation_log
ORDER BY recon_time DESC
LIMIT 10;

-- æŸ¥çœ‹æœ‰é”™è¯¯çš„å¯¹è´¦è¯¦æƒ…
SELECT 
    recon_time,
    recon_type,
    accounts_with_errors,
    total_discrepancy_amount,
    jsonb_array_length(error_details->'errors') as error_count,
    error_details->'errors' as error_list
FROM data.balance_reconciliation_log
WHERE accounts_with_errors > 0
ORDER BY recon_time DESC
LIMIT 5;

-- 5. æ¸…ç†æ—§å¯¹è´¦è®°å½•çš„ä»»åŠ¡ï¼ˆä¿ç•™30å¤©ï¼‰
SELECT cron.schedule(
    'cleanup-old-recon-logs',
    '0 4 * * *',  -- æ¯å¤©4:00 AM
    $$
    DELETE FROM data.balance_reconciliation_log
    WHERE recon_time < NOW() - INTERVAL '30 days';
    $$
);
```

## pg_cron ç®¡ç†

```postgresql
select * from cron.job_run_details;  -- æŸ¥çœ‹ä»»åŠ¡è¿è¡Œç»†èŠ‚

UPDATE cron.job SET active = false;  -- åœæ­¢æ‰€æœ‰ä»»åŠ¡

select * from cron.job;              -- æŸ¥çœ‹ä»»åŠ¡
```

