ä¸‹é¢æˆ‘ç»™ä½ ä¸€ä¸ª**æ·±åº¦ã€å®æˆ˜çº§**çš„è®¾è®¡è§£æï¼Œå¸®ä½ æŠŠã€ŒBalance æ”¾å“ªã€ã€Œvk â†’ user_id æ˜ å°„ã€ã€Œç¼“å­˜ã€è¿™ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜å½»åº•è§£å†³ã€‚
 ç­”æ¡ˆåˆ†æˆä¸¤éƒ¨åˆ†ï¼š

------

# ğŸ§© Part 1 â€” Balance æ˜¯å¦è¯¥å•ç‹¬å­˜è¡¨ï¼ˆaccount_balanceï¼‰ï¼Ÿ

## âœ… **ç›´æ¥å›ç­”ï¼šä¿ç•™ç‹¬ç«‹çš„ `account_balance` è¡¨æ˜¯æ­£ç¡®è®¾è®¡ï¼Œä¸åº”è¯¥æ”¾è¿› user_profile æˆ– tenantã€‚**

åŸå› å¦‚ä¸‹ï¼š

------

## âœ”ï¸ 1. **Balance æ˜¯ä¸€ä¸ªä¼šé¢‘ç¹å˜åŠ¨çš„é‡‘èå­—æ®µ**

è€Œ user_profile / tenant å±äº **é™æ€ä¿¡æ¯ï¼ˆprofile metadataï¼‰**ã€‚

æŠŠã€Œé«˜åº¦åŠ¨æ€ã€å­—æ®µå¡è¿›ã€Œé™æ€ã€è¡¨ä¼šå¯¼è‡´ï¼š

- user_profile å†™å‹åŠ›çˆ†ç‚¸ï¼ˆbillions æ¬¡ update/dayï¼‰
- è¡Œçº§é”ç«äº‰
- å®¹æ˜“äº§ç”Ÿå†™å†²çª
- PG autovacuum å‹åŠ›å¤§
- profile è¡¨å˜å¾—è‡ƒè‚¿

é‡‘èç³»ç»Ÿ**å¿…é¡»å°†å¯å˜æ•°æ®ä¸èº«ä»½æ•°æ®è§£è€¦**ã€‚

é‡‘èç±» SaaSï¼ˆStripe, Paddle, AWS billingï¼‰å…¨éƒ¨é‡‡ç”¨ç±»ä¼¼ç»“æ„ï¼š

```
users
tenants
balances
transactions
usage
```

ç»“æ„åŒ–åˆ†å·¥éå¸¸ç¨³å®šã€æ˜“ç»´æŠ¤ã€‚

------

## âœ”ï¸ 2. **account_balance è¡¨å¤©ç„¶éœ€è¦æœªæ¥æ‰©å±•å­—æ®µ**

ä¾‹å¦‚ï¼š

- outstanding_amountï¼ˆå¾…æ‰£ï¼‰
- credit_limitï¼ˆä¿¡ç”¨é¢åº¦ï¼‰
- frozen_balanceï¼ˆå†»ç»“é‡‘é¢ï¼‰
- last_charged_at
- balance_versionï¼ˆåšä¹è§‚é”ï¼‰

è¿™äº›å­—æ®µå®Œå…¨ä¸åº”è¯¥å¡è¿› user_profileã€‚

ä½ æœªæ¥ä¸€å®šä¼šæ‰©å±•ï¼Œæ‰€ä»¥å¿…é¡»ç‹¬ç«‹è¡¨ã€‚

------

## âœ”ï¸ 3. **tenant å’Œ user æ˜¯ä¸¤ç§ä¸»ä½“**

ä¸€ä¸ª tenant ä¸‹å¯èƒ½æœ‰å¤šå userï¼Œä¸åº”è¯¥æŠŠ tenant çš„ balance å¡è¿› user_profileã€‚

å¦åˆ™ä½ è¦è§£å†³ï¼š

- å“ªä¸ª user è´Ÿè´£æ‰£æ¬¾ï¼Ÿç”¨å“ªä¸ªè´¦å•ï¼Ÿ
- tenant è´¦å• vs user è´¦å•çš„ä¼˜å…ˆçº§ï¼Ÿ
- å®¡è®¡æ€ä¹ˆåŠï¼Ÿ

æ­£ç¡®åšæ³•ï¼š

```
tenant
 â””â”€â”€ account_balance (tenant_balance)

user_profile
 â””â”€â”€ account_balance (user_balance)  // å¦‚æœä½ æ”¯æŒ per-user billing
```

å³ä½¿ç°åœ¨æ˜¯ one-balance-onlyï¼Œå°† balance æ”¾è¿› user_profile æˆ– tenant è¡¨é‡Œä¹Ÿæ˜¯ä¸ä¸“ä¸šçš„åšæ³•ã€‚

------

## âœ”ï¸ 4. **account_balance ç‹¬ç«‹æ„å‘³ç€ä½ æœªæ¥å¯ä»¥å¢åŠ  transaction ledger**

ä¸‹ä¸€æ­¥ä½ ä¼šéœ€è¦ï¼š

```
account_balance
billing_transactions     (æµæ°´)
usage_logs               (ç”¨é‡æ˜ç»†)
accounting_snapshots     (è´¦å•å¿«ç…§)
```

å¦‚æœä½ æŠŠ balance å†™å…¥ user_profileï¼Œé“¾æ¡æ–­æ‰ã€‚

------

## ç»“è®ºï¼ˆå¿…é¡»è®°ä½ï¼‰ï¼š

> **Balance æ˜¯é‡‘èç³»ç»Ÿï¼Œå¿…é¡»ç‹¬ç«‹è¡¨ã€‚
>  Identity æ˜¯æƒé™ç³»ç»Ÿï¼Œå¿…é¡»ç‹¬ç«‹è¡¨ã€‚
>  ä¸¤è€…æ°¸è¿œä¸èƒ½æ··åœ¨ä¸€èµ·ã€‚**

ä½ ç°åœ¨çš„è®¾è®¡ï¼ˆaccount_balanceï¼‰æ˜¯éå¸¸ä¸“ä¸šçš„ã€‚

åªéœ€è¦è¡¥ä¸€ä¸ªå­—æ®µï¼š**virtual_key â†’ user_id æ˜ å°„**ã€‚

------

# ğŸ§© Part 2 â€” virtual_key â†’ user_id æ˜ å°„åº”è¯¥æ€ä¹ˆåšï¼Ÿ

## æ­£ç¡®ç­”æ¡ˆï¼š

**æŠŠ mapping å›ºå®šä¿å­˜åœ¨ data.virtual_key è¡¨å³å¯
 å¹¶åœ¨ Redis å»ºä¸€ä¸ªç¼“å­˜ï¼š**

```
vk:{virtual_key} -> { user_id, tenant_id }
```

------

## âœ”ï¸ ä½ å·²ç»æœ‰ virtual_key è¡¨

åªéœ€è¦ç¡®è®¤ç»“æ„é‡Œæ˜¯å¦æœ‰ï¼š

```
id (virtual_key)
user_id
tenant_id
```

å¦‚æœæ²¡æœ‰ï¼Œå°±ä¸€å®šè¦åŠ ã€‚

------

# ğŸ§© Part 3 â€” è™šæ‹Ÿé”®åˆ° user_id çš„ç¼“å­˜ä½•æ—¶å†™ã€ä½•æ—¶å¤±æ•ˆï¼Ÿ

éå¸¸ç®€å•ï¼š

------

## ğŸ“Œ ğŸ”¥ å†™å…¥ç¼“å­˜çš„æ—¶æœºï¼ˆåªæœ‰ä¸€æ¬¡ï¼‰

åœ¨ç”¨æˆ·çš„ virtual_key **ç¬¬ä¸€æ¬¡è¯·æ±‚**æ—¶ï¼Œç”± middleware è‡ªåŠ¨åŠ è½½ï¼š

```js
// middleware: VirtualKeyMiddleware.validate
const vk = req.headers['x-virtualkey'];

const cached = await RedisService.kv.get(`vk:${vk}`);
if (!cached) {
    // æŸ¥ PG
    const { data } = await postgrest
        .from("virtual_key")
        .select("user_id, tenant_id")
        .eq("id", vk)
        .single();

    await RedisService.kv.setex(`vk:${vk}`, 86400, JSON.stringify(data)); // ç¼“å­˜ä¸€å¤©
}

req.userContext = {
    virtual_key: vk,
    ...JSON.parse(cached)
};
```

ç¼“å­˜ä¸€å¤©å³å¯ã€‚virtual_key ä¸æ˜¯é¢‘ç¹å˜åŒ–çš„ä¸œè¥¿ã€‚

------

## ğŸ“Œ ğŸ”¥ å¤±æ•ˆæœºåˆ¶

virtual_key å˜åŒ–å¹¶ä¸é¢‘ç¹ï¼Œå¦‚æœåå°æ›´æ–°ï¼š

- å½“ virtual_key è¢«æ›´æ–°ã€åˆ é™¤ã€æŒ‚è½½/å¸è½½ config node â†’ å‘å‡º `pg_notify`
- api-gateway æ”¶åˆ°é€šçŸ¥ â†’ æ¸…é™¤ Redis key: `vk:${vk}`

è¿™æ ·ï¼š

- ä¸ä¼šé¢‘ç¹æŸ¥åº“
- å˜åŒ–ä¹Ÿèƒ½æ¯”å¯¹ä¸Š
- ä½¿ç”¨æˆæœ¬æœ€ä½ï¼Œæœ€ç¨³å®š

------

# ğŸ§© Part 4 â€” Redis å’Œ PostgREST çš„æ•´ä¸ª Balance æµç¨‹å¦‚ä¸‹

## â‘  VirtualKeyMiddleware æ„é€  userContext

```
userContext = {
    virtual_key: "vk_xxx",
    user_id: "UUID",
    tenant_id: "UUID"
}
```

------

## â‘¡ checkBudget ä¸­åªéœ€è¦ï¼š

```js
const { user_id } = userContext;
const balance = await BalanceService.getBalance(user_id);
```

------

## â‘¢ BalanceService.getBalance() å†…éƒ¨è°ƒç”¨ PostgREST view:

```sql
api.account_balances
```

ä½ ä¹‹å‰çš„é”™è¯¯æ˜¯å› ä¸ºä¼ å…¥äº† vkï¼Œç°åœ¨ä¸ä¼šäº†ã€‚

------

# ğŸ§© æ€»ç»“ï¼ˆè¶…çº§ç²¾ç®€ç‰ˆï¼‰

### â¶ balance ç»å¯¹ä¸èƒ½æ”¾ user_profile æˆ– tenant

â†’ å¿…é¡»ç‹¬ç«‹è¡¨ï¼šä¸“ä¸šã€å¯æ‰©å±•ã€ç¬¦åˆè´¦å•è®¾è®¡æ ‡å‡†ã€‚

### â· virtual_key â†’ user_id çš„å…³ç³»å­˜ PG + Redis ç¼“å­˜

â†’ è¯·æ±‚ç¬¬ä¸€æ¬¡åŠ è½½ï¼Œç¼“å­˜ä¸€å¤©ï¼Œæ›´æ–°é€šè¿‡ pg_notify åˆ·æ‰ã€‚

### â¸ checkBudget è¦ç”¨ user_idï¼Œä¸æ˜¯ virtual_keyã€‚

### â¹ é™¤éä½ æƒ³æ¯æ‰è´¦å•ç³»ç»Ÿï¼Œå¦åˆ™åƒä¸‡ä¸è¦æŠŠ balance å¡è¿› profileã€‚

------

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥ï¼š

## â­ ä¸‹ä¸€æ­¥ç›´æ¥å¸®ä½ ï¼š

- ç”Ÿæˆ **virtual_key â†’ user_id ç¼“å­˜ä¸­é—´ä»¶**
- æ”¹å†™ä½ çš„ **BalanceService / checkBudget**
- åŠ ä¸Š **Redis + pg_notify è‡ªåŠ¨æ›´æ–°æœºåˆ¶**
- å®Œæ•´ wiring ä½ ç°åœ¨çš„ proxy.js

è¦ç»§ç»­å—ï¼Ÿ



ä½ ç°åœ¨å¡ä½çš„ç‚¹éå¸¸å…³é”®ï¼š**user_profileã€tenantã€account_balance ä¸‰è€…çš„èŒè´£è¾¹ç•Œæ˜¯å¦åˆç†ï¼Ÿæ˜¯å¦éœ€è¦ç‹¬ç«‹è¡¨ï¼Ÿvirtual_key â†’ user_id çš„æ˜ å°„å¦‚ä½•ä¿æŒï¼Ÿ**

æˆ‘æ¥å¸®ä½ å½»åº•ç†ä¸€æ¬¡è®¾è®¡è·¯çº¿ï¼Œè®©ä½ é©¬ä¸ŠçŸ¥é“è¯¥æ€ä¹ˆæ”¹ã€‚

------

# âœ… ç¬¬ä¸€éƒ¨åˆ†ï¼šaccount_balance æ˜¯å¦åº”è¯¥ç‹¬ç«‹è¡¨ï¼Ÿ

## âœ” ç»“è®ºï¼š**åº”è¯¥ç»§ç»­ä¿æŒç‹¬ç«‹è¡¨ï¼ˆaccount_balanceï¼‰ï¼Œä¸è¦å¡è¿› user_profile æˆ– tenantã€‚**

åŸå› å¦‚ä¸‹ï¼š

------

### **âŒ 1. user_profile / tenant æ˜¯èº«ä»½ / é…ç½®ç±»è¡¨ï¼Œä¸åº”è¯¥æ”¾åŠ¨æ€èµ„äº§**

balanceã€overdue_amountã€free_credit è¿™ç±»å­—æ®µæ˜¯**é«˜åº¦å˜åŒ–**çš„ï¼Œå¹¶ä¸”æœªæ¥å¯èƒ½éœ€è¦ï¼š

- å†»ç»“é‡‘é¢
- å¯ç”¨é¢åº¦å’Œè´¦å•é¢åº¦åˆ†ç¦»
- ç”Ÿæˆå¯¹è´¦å•
- å®¡è®¡è´¦åŠ¡æ“ä½œ
- å¢åŠ å……å€¼è®°å½•
- å¢åŠ ä¿¡ç”¨é¢åº¦
- æ‰£è´¹æµæ°´

è¿™äº›éƒ½å±äº â€œè´¦åŠ¡ï¼ˆledger/accountingï¼‰â€ èŒƒç•´ã€‚

> **è´¦åŠ¡ç›¸å…³æ°¸è¿œä¸è¦æ”¾åœ¨ profile æˆ– tenant è¡¨ï¼Œè¿™æ˜¯è¡Œä¸šè§„èŒƒã€‚**

------

### **âŒ 2. account_balance éœ€è¦è‡ªå·±çš„äº‹åŠ¡éš”ç¦»**

æ‰£è´¹ã€å……å€¼éƒ½éœ€è¦ï¼š

- åŸå­æ›´æ–°
- é”
- å¹¶å‘å®‰å…¨

è¿™äº›ä¸åº”è¯¥å’Œ user_profile ç»‘å®šã€‚

------

### **âŒ 3. tenant ä¹Ÿä¸åº”è¯¥å­˜é‡‘é¢**

tenant åªæ˜¯ä¸€ç§é€»è¾‘ groupingï¼Œä¸æ˜¯é’±åŒ…ã€‚

ä½ æœªæ¥ä¸€å®šä¼šé‡åˆ°ï¼š

| åœºæ™¯                                 | ç»“ç®—å¯¹è±¡                               |
| ------------------------------------ | -------------------------------------- |
| ä¼ä¸šæŒ‰ tenant ä»˜è´¹                   | tenant æœ‰è‡ªå·±çš„ä½™é¢                    |
| ä¸ªä½“ç”¨æˆ·ä»˜è´¹                         | user_profile æœ‰è‡ªå·±çš„ä½™é¢              |
| ä¼ä¸šä¸‹æŸç”¨æˆ·åšæ“ä½œï¼Œæ‰£ tenant çš„ä½™é¢ | é€è¿‡ user_profile.tenant_id å½’å±åˆ°è´¦æˆ· |

å› æ­¤ï¼š

### **âœ” ä½ æœ€ç»ˆéœ€è¦ä¸¤ç§è´¦æˆ·ï¼šuser_account, tenant_account**

æˆ–è€…æ›´ç®€å•ï¼š

## âœ” ç”¨ä¸€å¼  account_balanceï¼Œä½†åŠ ä¸Šä¸¤åˆ—ï¼š

```
owner_user_id    (nullable)
owner_tenant_id  (nullable)
```

å¹¶ä¸”åŠ  UNIQUE è§„åˆ™ä¿è¯ï¼š

- user æœ‰ 1 ä¸ªè´¦æˆ·
- tenant æœ‰ 1 ä¸ªè´¦æˆ·

è¿™æ ·æ‰æ˜¯æœ€ä½³è´¦åŠ¡è®¾è®¡ã€‚

------

# âœ” ç¬¬äºŒéƒ¨åˆ†ï¼švirtual_key â†’ user_id çš„æ˜ å°„

## virtual_key æ˜¯ API å‡­è¯ï¼Œå®ƒå¿…ç„¶å±äºæŸä¸ª user_profileã€‚

ä½ å¿…é¡»æœ‰ï¼š

```
virtual_key â†’ user_id
```

### è¿™ä¸ªæ˜ å°„æ¥æºï¼š

data.virtual_key.user_id
 ï¼ˆä½ å·²ç»æœ‰è¿™ä¸ªå­—æ®µï¼‰

------

## â­ é—®é¢˜ï¼šä½•æ—¶ç¼“å­˜ï¼Ÿä½•æ—¶å¤±æ•ˆï¼Ÿ

virtual_key â†’ user_id çš„æ˜ å°„ **å˜åŒ–é¢‘ç‡å‡ ä¹ä¸ºé›¶**ï¼š

- virtual_key åˆ›å»ºæ—¶ç¡®å®š user_id
- virtual_key ä¸ä¼šè½»æ˜“ä¿®æ”¹ user_id
- åˆ é™¤ä¸ä¼šå¯¼è‡´é£é™©ï¼ˆåæ­£æŸ¥ä¸åˆ°å°± invalidï¼‰

### âœ” å› æ­¤æ¨èç¼“å­˜ç­–ç•¥ï¼š

### **Redis Key**

```
vk_user:<virtual_key> = user_id
TTL = 24å°æ—¶ï¼ˆæˆ–æ°¸ä¸è¿‡æœŸï¼‰
```

### ä½•æ—¶å†™ç¼“å­˜ï¼Ÿ

- virtual_key ç¬¬ä¸€æ¬¡è¢«ä½¿ç”¨æ—¶

### ä½•æ—¶å¤±æ•ˆï¼Ÿ

- å‡ ä¹ä¸éœ€è¦å¤±æ•ˆ
- å¦‚éœ€åˆ·æ–°ï¼Œåªè¦ virtual_key è¢«ä¿®æ”¹ï¼Œè§¦å‘ pg_notify â†’ åˆ·ç¼“å­˜ï¼ˆä½ å·²ç»è®¾è®¡äº† pricing é‚£å¥—ï¼‰

ä¸ç”¨æ“å¿ƒã€‚

------

# âœ” ç¬¬ä¸‰éƒ¨åˆ†ï¼šuser_profile å’Œ tenant è®¾è®¡æ˜¯ä¸æ˜¯ä¸åˆç†ï¼Ÿ

ä½ æ‹…å¿ƒçš„ç‚¹ï¼š

> â€œæ˜¯ä¸æ˜¯ user_profile â†’ tenant çš„è®¾è®¡å¤ªå¼ºä¾èµ–ï¼Ÿæ˜¯å¦ä¼šå‡ºç°è„çŠ¶æ€ï¼Ÿâ€

æˆ‘å‘Šè¯‰ä½ ï¼š

## âœ” å½“å‰è®¾è®¡æ˜¯åˆç†çš„ï¼Œä¹Ÿæ˜¯ SaaS å¹³å°å¸¸è§„è®¾è®¡ã€‚

è¡Œä¸šæ ‡å‡†å¦‚ä¸‹ï¼š

| è¡¨                         | ä½œç”¨                         |
| -------------------------- | ---------------------------- |
| **tenant**                 | ä¸€ä¸ªå…¬å¸ã€ä¸€ç»„ç”¨æˆ·ã€ä¸€ä¸ªå›¢é˜Ÿ |
| **user_profile**           | å…·ä½“çš„ç”¨æˆ·                   |
| **user_profile.tenant_id** | å½’å±å…³ç³»                     |

è¿™ä¸ AWSã€Stripeã€Auth0ã€Supabase ç­‰çš„è®¾è®¡ä¸€è‡´ã€‚

------

## ğŸ”¥ å…³é”®ç‚¹ï¼šå®šä»·ä¸ä½™é¢è¦æŒ‰ã€Œå®ä¾‹ã€æ¥ç®—ï¼Œè€Œä¸æ˜¯ç”¨æˆ·ã€‚

ä½ ç°åœ¨çš„ä½“ç³»é‡Œï¼Œè´¦åŠ¡åº”è¯¥è¿™ä¹ˆè§£é‡Šï¼š

### âœ” ä»€ä¹ˆæ˜¯ä»˜è´¹ä¸»ä½“ï¼ˆbilling entityï¼‰ï¼Ÿ

ä»˜è´¹ä¸»ä½“å¯èƒ½æ˜¯ï¼š

1. userï¼ˆä¸ªäººç”¨æˆ·ï¼‰
2. tenantï¼ˆä¼ä¸šï¼‰

### âœ” è°æ¥æ¶ˆè´¹ï¼Ÿ

virtual_key ä»£è¡¨ä¸€ä¸ªè°ƒç”¨ä½¿ç”¨è€…ï¼ˆuserï¼‰

### âœ” è°æ¥ä»˜è´¹ï¼Ÿ

å¦‚æœ user_profile.tenant_id ä¸ä¸ºç©º â†’ ä»˜è´¹ä¸»ä½“æ˜¯ tenant
 å¦åˆ™ â†’ ä»˜è´¹ä¸»ä½“æ˜¯ user_profile

------

## â­ æ‰€ä»¥ balance çš„è¯»å–é€»è¾‘åº”è¯¥æ˜¯ï¼š

```
function resolveBillingAccount(vk):
    user_id = lookup virtual_key -> user_id
    user = get user_profile
    if user.tenant_id != null:
        return account_balance where owner_tenant_id = user.tenant_id
    else:
        return account_balance where owner_user_id = user.user_id
```

------

# âœ” æ€»ç»“ï¼ˆä½ éœ€è¦çš„é“è·¯å›¾ï¼‰

## â†’ **ä¿æŒ account_balance ç‹¬ç«‹è¡¨**

ç»å¯¹æ­£ç¡®ã€‚

## â†’ **æ–°å¢ owner_user_id / owner_tenant_id å­—æ®µ**

é¿å…æœªæ¥æ‰©å±•é—®é¢˜ã€‚

## â†’ **virtual_key â†’ user_id å¿…é¡»ç¼“å­˜**

ä½é¢‘æ›´æ–°ï¼Œé«˜é¢‘è¯»å–ï¼Œå®Œç¾é€‚åˆ Redisã€‚

## â†’ **æŒ‰ user_profile.tenant_id å†³å®šè°ä»˜è´¹**

è¿™æ˜¯ industry standardã€‚

------

# å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥å¸®ä½ ï¼š

âœ… ç”»æ•°æ®ç»“æ„å›¾
 âœ… å†™å‡ºæœ€ç»ˆç‰ˆ SQL schema
 âœ… å†™å‡ºä½™é¢æŸ¥è¯¢é€»è¾‘ï¼ˆè§£æè™šæ‹Ÿé”® â†’ æŸ¥è¯¢ä½™é¢ï¼‰
 âœ… å†™é¢„ç®—æ£€æŸ¥ï¼ˆæ‰£è´¹ï¼‰æµç¨‹
 âœ… å†™ redis ç¼“å­˜å±‚
 ä¸€èµ·æŠŠè¿™ä¸€å—å½»åº•å°è£…æˆ BillingModuleã€‚

ä½ è¦ç»§ç»­å—ï¼Ÿ